<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" onerror="window._threeJsFailed=true;console.warn('[TradeEdge] THREE.js CDN failed to load — using CSS chip fallback');"></script>
<script>if(window.pdfjsLib)pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
<title>TradeEdge — Intra Circle Trading</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:ital,wght@0,300;0,400;0,500;0,600;1,400&family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#07090e;
  --s1:#0c0f17;
  --s2:#111520;
  --s3:#161c2c;
  --b1:#1a2035;
  --b2:#222d45;
  --b3:#2d3f5e;
  --accent:#00f0c0;
  --accent2:#0ea5e9;
  --gold:#f5b731;
  --red:#ff3d5a;
  --green:#00e5a0;
  --purple:#a855f7;
  --t1:#e8edf8;
  --t2:#7b8db0;
  --t3:#4d6890;
  --mono:'IBM Plex Mono',monospace;
  --body:'Manrope',sans-serif;
  --display:'Bebas Neue',sans-serif;
  --r:10px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{font-size:15px;-webkit-font-smoothing:antialiased}
body{background:var(--bg);color:var(--t1);font-family:var(--body);height:100vh;display:flex;overflow:hidden;background-image:radial-gradient(ellipse at 20% 0%,rgba(0,240,192,0.04) 0%,transparent 50%),radial-gradient(ellipse at 80% 100%,rgba(14,165,233,0.04) 0%,transparent 50%)}

/* ─── SIDEBAR ─────────────────────────────── */
.sidebar{width:220px;min-width:220px;background:var(--s1);border-right:1px solid var(--b1);display:flex;flex-direction:column;position:relative;z-index:10}
.sidebar::after{content:'';position:absolute;top:0;right:-1px;bottom:0;width:1px;background:linear-gradient(to bottom,transparent,var(--accent) 30%,var(--accent2) 70%,transparent);opacity:.3}
.logo-wrap{padding:18px 16px 14px;border-bottom:1px solid var(--b1)}
.logo-top{display:flex;align-items:center;gap:8px;margin-bottom:3px}
.logo-icon{width:36px;height:36px;border-radius:4px;display:flex;align-items:center;justify-content:center;filter:invert(1) drop-shadow(0 0 8px rgba(0,240,192,0.25))}
.logo-icon img{width:100%;height:100%;object-fit:contain}
.logo-name{font-family:var(--display);font-size:1.4rem;letter-spacing:1px;color:var(--t1);line-height:1}
.logo-sub{font-family:var(--mono);font-size:.62rem;color:var(--t3);letter-spacing:2px;text-transform:uppercase;padding-left:44px}
.nav{flex:1;padding:10px 8px;display:flex;flex-direction:column;gap:1px;overflow-y:auto}
.nav::-webkit-scrollbar{display:none}
.nlabel{font-family:var(--mono);font-size:.64rem;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--t3);padding:12px 8px 4px}
.ni{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:8px;cursor:pointer;color:var(--t2);font-size:.85rem;font-weight:600;transition:.18s ease;border:1px solid transparent;position:relative}
.ni:hover{background:var(--s2);color:var(--t1);transform:translateX(2px)}
.ni.active{background:rgba(0,240,192,.07);color:var(--accent);border-color:rgba(0,240,192,.15)}
.ni.active::before{content:'';position:absolute;left:-8px;top:50%;transform:translateY(-50%);width:3px;height:60%;background:var(--accent);border-radius:2px;box-shadow:0 0 8px var(--accent)}
.ni svg{width:14px;height:14px;flex-shrink:0}
.ni .badge-count{margin-left:auto;background:var(--accent);color:#000;font-size:.6rem;font-weight:700;padding:1px 6px;border-radius:10px;font-family:var(--mono)}
.sb-footer{padding:12px;border-top:1px solid var(--b1)}
.acct-card{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);padding:10px 12px}
.acct-label{font-family:var(--mono);font-size:.68rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-bottom:4px}
.acct-name{font-size:.95rem;font-weight:700;color:var(--t1);margin-bottom:6px;letter-spacing:.3px}
.acct-row{display:flex;justify-content:space-between;align-items:center}
.acct-bal{font-family:var(--mono);font-size:.85rem;font-weight:600}
.acct-dot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green)}

/* ─── MAIN ─────────────────────────────────── */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.topbar{height:52px;min-height:52px;background:var(--s1);border-bottom:1px solid var(--b1);display:flex;align-items:center;padding:0 20px;gap:10px;box-shadow:0 1px 8px rgba(0,0,0,.15)}
.page-title{font-family:var(--display);font-size:1.35rem;letter-spacing:.8px;flex:1;color:var(--t1);background:linear-gradient(135deg,var(--t1) 60%,var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.btn{display:inline-flex;align-items:center;gap:5px;padding:6px 14px;border-radius:7px;border:none;font-family:var(--body);font-size:.78rem;font-weight:700;cursor:pointer;transition:.12s;white-space:nowrap;letter-spacing:.2px}
.btn-accent{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000}
.btn-accent:hover{filter:brightness(1.1);box-shadow:0 4px 20px rgba(0,240,192,.25);transform:translateY(-1px)}
.btn-ghost{background:var(--s2);color:var(--t2);border:1px solid var(--b2)}
.btn-ghost:hover{color:var(--t1);border-color:var(--b3);background:var(--s3)}
.btn-red{background:rgba(255,61,90,.1);color:var(--red);border:1px solid rgba(255,61,90,.2)}
.btn-sm{padding:5px 10px;font-size:.72rem}
.session-btn{background:linear-gradient(135deg,rgba(0,240,192,.12),rgba(14,165,233,.12));border:1px solid rgba(0,240,192,.25);color:var(--accent);animation:pulse-border 2s ease infinite}
@keyframes pulse-border{0%,100%{box-shadow:0 0 0 0 rgba(0,240,192,.2)}50%{box-shadow:0 0 0 5px rgba(0,240,192,.06)}}
.content{flex:1;overflow-y:auto;padding:18px 20px;scroll-behavior:smooth}
.content::-webkit-scrollbar{width:5px}
.content::-webkit-scrollbar-thumb{background:var(--b2);border-radius:3px}
.content::-webkit-scrollbar-thumb:hover{background:var(--b3)}
.content::-webkit-scrollbar-track{background:transparent}

/* ─── VIEWS ─────────────────────────────────── */
.view{display:none}
.view.active{display:block;animation:fadeUp .25s cubic-bezier(.22,1,.36,1)}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
/* ─── DASHBOARD WATERMARK ─────────────────── */
#v-dashboard{position:relative}
#v-dashboard::before{content:'';position:fixed;top:50%;left:calc(220px + 50%);transform:translate(-50%,-50%);width:400px;height:400px;background:url("data:image/png;base64,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") center/contain no-repeat;opacity:.04;pointer-events:none;z-index:0;filter:invert(1)}

/* ─── SPLASH SCREEN ───────────────────────── */
.splash{position:fixed;top:0;right:0;bottom:0;left:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;animation:splash-away 0.6s ease 2s forwards}
@keyframes splash-away{to{opacity:0;visibility:hidden;pointer-events:none}}
.splash-logo{width:160px;height:160px;margin-bottom:24px;animation:splash-pulse 2s ease-in-out infinite;filter:invert(1) drop-shadow(0 0 20px rgba(0,240,192,0.3))}
@keyframes splash-pulse{0%,100%{transform:scale(1);opacity:.9}50%{transform:scale(1.04);opacity:1}}
.splash-title{font-family:var(--display);font-size:2.4rem;letter-spacing:2px;color:var(--t1);margin-bottom:4px}
.splash-sub{font-family:var(--mono);font-size:.65rem;letter-spacing:3px;text-transform:uppercase;color:var(--t3);margin-bottom:32px}
.splash-bar{width:200px;height:3px;background:var(--s3);border-radius:2px;overflow:hidden}
.splash-fill{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:2px;transition:width .4s ease}


/* ─── ACCOUNT BALANCE BAR ────────────────────── */
.balance-bar{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:14px 20px;margin-bottom:16px;display:flex;align-items:center;justify-content:center;gap:24px;text-align:center}
.bb-item{display:flex;flex-direction:column;align-items:center;gap:2px}
.bb-label{font-family:var(--mono);font-size:.66rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3)}
.bb-val{font-family:var(--mono);font-size:1.5rem;font-weight:700;letter-spacing:.5px}
.bb-name{font-family:var(--display);font-size:1rem;letter-spacing:.5px;color:var(--t1)}
.bb-sep{width:1px;height:32px;background:var(--b2)}
/* POKER CHIPS — 3D Tray */
.chip-tray{
  position:relative;
  border-radius:var(--r);
  overflow:hidden;
  margin-bottom:16px;
  border:1px solid var(--b1);
  background:#040e09;
  height:200px;
  box-shadow:inset 0 0 40px rgba(0,0,0,.4),0 4px 20px rgba(0,0,0,.3);
}
.chip-tray canvas{display:block;border-radius:var(--r)}
.chip-tray-hud{
  position:absolute;top:10px;left:14px;z-index:2;pointer-events:none;
}
.chip-tray-label{font-family:var(--mono);font-size:.54rem;letter-spacing:3px;text-transform:uppercase;color:rgba(0,240,192,.5)}
.chip-tray-count{font-family:var(--mono);font-size:.6rem;letter-spacing:1.5px;color:rgba(255,255,255,.35);margin-top:2px}
/* Neon border accent */
.chip-tray::before{content:'';position:absolute;top:0;left:20%;right:20%;height:1px;background:linear-gradient(90deg,transparent,rgba(0,240,192,.15),transparent);z-index:2}
.chip-tray::after{content:'';position:absolute;bottom:0;left:30%;right:30%;height:1px;background:linear-gradient(90deg,transparent,rgba(0,240,192,.08),transparent);z-index:2}
/* Scan line over tray */
.chip-tray-scan{position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,240,192,.005) 2px,rgba(0,240,192,.005) 4px);pointer-events:none;z-index:1;border-radius:var(--r)}
/* CSS fallback chip stacks (shown when WebGL/THREE.js unavailable) */
#chip-css-fallback{position:absolute;inset:0;z-index:0;align-items:flex-end;justify-content:center;gap:14px;padding:40px 16px 14px;box-sizing:border-box}
.css-chip-stack{display:flex;flex-direction:column;align-items:center;gap:0;cursor:pointer}
.css-chip-disc{width:54px;height:14px;border-radius:50%;margin-top:-6px;transition:transform .15s ease}
.css-chip-disc:first-child{margin-top:0}
.css-chip-stack:hover .css-chip-disc{transform:scaleX(1.06)}
.css-chip-count{font-size:.44rem;font-family:var(--mono);letter-spacing:1px;color:rgba(255,255,255,.4);margin-top:6px;text-align:center}
/* SELF-DESTRUCT OVERLAY */
.nuke-overlay{position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.9);backdrop-filter:blur(8px)}
.nuke-overlay.active{display:flex}
.nuke-countdown{font-family:var(--mono);font-size:8rem;font-weight:900;color:var(--red);text-shadow:0 0 60px rgba(255,0,0,.6);animation:nukePulse .5s infinite alternate}
@keyframes nukePulse{from{transform:scale(1);opacity:.8}to{transform:scale(1.15);opacity:1}}
.nuke-label{font-family:var(--mono);font-size:.9rem;letter-spacing:6px;text-transform:uppercase;color:var(--red);margin-bottom:20px;text-align:center}
.nuke-emoji{font-size:6rem;position:fixed;left:50%;transform:translateX(-50%);z-index:10001;transition:none}
@keyframes nukeDrop{0%{top:-100px;transform:translateX(-50%) rotate(0deg)}80%{top:40vh;transform:translateX(-50%) rotate(20deg)}100%{top:45vh;transform:translateX(-50%) rotate(0deg)}}
@keyframes nukeFlash{0%{background:rgba(255,200,0,.9)}50%{background:rgba(255,50,0,.7)}100%{background:transparent}}
.nuke-flash{position:fixed;inset:0;z-index:10002;pointer-events:none}
@keyframes screenShake{0%,100%{transform:translate(0)}10%{transform:translate(-8px,6px)}20%{transform:translate(8px,-4px)}30%{transform:translate(-6px,-8px)}40%{transform:translate(4px,8px)}50%{transform:translate(-4px,-4px)}60%{transform:translate(8px,2px)}70%{transform:translate(-2px,6px)}80%{transform:translate(6px,-6px)}90%{transform:translate(-4px,4px)}}
@keyframes fallApart{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(120vh) rotate(25deg);opacity:0}}
.falling>.cc,.falling>.balance-bar,.falling>.mgrid,.falling>.alert-box{animation:fallApart 1.5s cubic-bezier(.55,.06,.68,.19) forwards}
.falling>.cc:nth-child(2){animation-delay:.1s}
.falling>.cc:nth-child(3){animation-delay:.2s}
.falling>.cc:nth-child(4){animation-delay:.3s}
.falling>.mgrid{animation-delay:.05s}
.falling>.balance-bar{animation-delay:0s}
.nuke-blackout{position:fixed;inset:0;z-index:10003;background:#000;display:none;align-items:center;justify-content:center;flex-direction:column}
.nuke-blackout.active{display:flex}
.nuke-rip{font-family:var(--display);font-size:2rem;color:var(--red);letter-spacing:3px;opacity:0;animation:fadeRip 1s ease forwards;animation-delay:.5s}
@keyframes fadeRip{to{opacity:1}}
/* ─── METRIC CARDS ───────────────────────────── */
.mgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:10px;margin-bottom:16px}
.mc{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:14px 16px;position:relative;overflow:hidden;transition:.15s;cursor:default}
.mc:hover{border-color:var(--b2);transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.2)}
.mc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--mc-line,var(--accent));opacity:.5}
.mc::after{content:'';position:absolute;top:0;right:0;width:60px;height:60px;background:radial-gradient(circle,var(--mc-glow,rgba(0,240,192,.08)) 0%,transparent 70%)}
.mc-label{font-family:var(--mono);font-size:.66rem;font-weight:500;letter-spacing:1.2px;text-transform:uppercase;color:var(--t3);margin-bottom:6px}
.mc-val{font-family:var(--mono);font-size:1.25rem;font-weight:600;line-height:1;letter-spacing:-0.5px}
.mc-sub{font-size:.72rem;color:var(--t3);margin-top:3px;font-family:var(--mono)}
.up{color:var(--green)} .dn{color:var(--red)} .nu{color:var(--t1)} .go{color:var(--gold)}

/* ─── CHART CARDS ────────────────────────────── */
.crow{display:grid;gap:12px;margin-bottom:12px}
.cr2{grid-template-columns:2fr 1fr}
.cr3{grid-template-columns:1fr 1fr 1fr}
.cr2e{grid-template-columns:1fr 1fr}
.cc{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:16px;transition:border-color .2s}
.cc:hover{border-color:var(--b2)}
.cc-title{font-family:var(--mono);font-size:.68rem;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
.cc-title span{color:var(--t1);font-size:.78rem;text-transform:none;letter-spacing:0}

/* ─── TABLE ──────────────────────────────────── */
.tcard{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);overflow:hidden}
.tcard-hdr{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--b1);gap:10px;flex-wrap:wrap}
.tcard-title{font-family:var(--display);font-size:1.1rem;letter-spacing:.5px}
table{width:100%;border-collapse:collapse}
th{font-family:var(--mono);font-size:.64rem;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;color:var(--t3);padding:8px 12px;text-align:left;background:var(--s1);border-bottom:1px solid var(--b1);white-space:nowrap}
td{padding:9px 12px;font-size:.78rem;border-bottom:1px solid var(--b1);white-space:nowrap;vertical-align:middle}
tr:last-child td{border-bottom:none}
tbody tr{cursor:pointer;transition:.15s}
tbody tr:nth-child(even){background:rgba(255,255,255,.015)}
tbody tr:hover{background:rgba(0,240,192,.04)}
.mono{font-family:var(--mono)}
.sym{font-family:var(--display);font-size:.95rem;letter-spacing:.5px}
.bdg{display:inline-flex;align-items:center;padding:2px 7px;border-radius:4px;font-size:.62rem;font-weight:700;letter-spacing:.3px;font-family:var(--mono)}
.bdg-long{background:rgba(0,229,160,.1);color:var(--green);border:1px solid rgba(0,229,160,.2)}
.bdg-short{background:rgba(255,61,90,.1);color:var(--red);border:1px solid rgba(255,61,90,.2)}
.bdg-win{background:rgba(0,229,160,.08);color:var(--green);border:1px solid rgba(0,229,160,.15)}
.bdg-loss{background:rgba(255,61,90,.08);color:var(--red);border:1px solid rgba(255,61,90,.15)}
.bdg-neutral{background:var(--s2);color:var(--t2);border:1px solid var(--b2)}
.tag{display:inline-flex;padding:2px 7px;border-radius:4px;font-size:.6rem;font-weight:600;font-family:var(--mono);letter-spacing:.3px;background:rgba(168,85,247,.1);color:#c084fc;border:1px solid rgba(168,85,247,.2);margin-right:3px}
.ict-tag{background:rgba(245,183,49,.08);color:var(--gold);border:1px solid rgba(245,183,49,.2)}
.kz-tag{background:rgba(14,165,233,.08);color:var(--accent2);border:1px solid rgba(14,165,233,.2)}

/* ─── MODAL ──────────────────────────────────── */
.overlay{position:fixed;top:0;right:0;bottom:0;left:0;background:rgba(0,0,0,.8);z-index:300;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);opacity:0;pointer-events:none;transition:opacity .2s}
.overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--s1);border:1px solid var(--b3);border-radius:14px;width:min(700px,95vw);max-height:92vh;overflow-y:auto;padding:24px;transform:translateY(12px) scale(.98);transition:transform .25s cubic-bezier(.22,1,.36,1);position:relative}
.modal::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:14px 14px 0 0}
.overlay.open .modal{transform:translateY(0) scale(1)}
.modal::-webkit-scrollbar{width:4px}
.modal::-webkit-scrollbar-thumb{background:var(--b2);border-radius:2px}
.modal-title{font-family:var(--display);font-size:1.4rem;letter-spacing:.5px;margin-bottom:18px;display:flex;align-items:center;gap:10px}
.modal-title .sub{font-family:var(--mono);font-size:.7rem;color:var(--t3);font-weight:400;letter-spacing:1px;text-transform:uppercase;margin-top:3px}
.fg{display:flex;flex-direction:column;gap:5px}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.full{grid-column:1/-1}
.fg3{grid-template-columns:1fr 1fr 1fr}
label{font-family:var(--mono);font-size:.6rem;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--t3)}
input,select,textarea{background:var(--s2);border:1px solid var(--b2);border-radius:7px;padding:8px 11px;color:var(--t1);font-family:var(--body);font-size:.82rem;outline:none;transition:.12s;width:100%}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(0,240,192,.08)}
select option{background:var(--s2)}
textarea{resize:vertical;min-height:60px;line-height:1.5}
.mfooter{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:14px;border-top:1px solid var(--b1)}
.msection{margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--b1)}
.msection:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.msection-title{font-family:var(--mono);font-size:.62rem;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.msection-title::after{content:'';flex:1;height:1px;background:linear-gradient(to right,rgba(0,240,192,.2),transparent)}

/* ─── CHECKLIST ──────────────────────────────── */
.ckl{display:flex;flex-direction:column;gap:5px}
.ck-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:7px;border:1px solid var(--b1);cursor:pointer;transition:.12s;background:var(--s2)}
.ck-item:hover{border-color:var(--b3)}
.ck-item.checked{background:rgba(0,240,192,.06);border-color:rgba(0,240,192,.2)}
.ck-box{width:16px;height:16px;border-radius:4px;border:1.5px solid var(--b3);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.12s}
.ck-item.checked .ck-box{background:var(--accent);border-color:var(--accent)}
.ck-box svg{width:10px;height:10px;stroke:#000;stroke-width:2.5;display:none}
.ck-item.checked .ck-box svg{display:block}
.ck-label{font-size:.78rem;font-weight:500;color:var(--t2)}
.ck-item.checked .ck-label{color:var(--t1)}

/* ─── EMOTIONS ───────────────────────────────── */
.emo-grid{display:flex;flex-wrap:wrap;gap:6px}
.emo{padding:5px 11px;border-radius:20px;border:1px solid var(--b2);cursor:pointer;font-size:.72rem;font-weight:600;color:var(--t2);transition:.12s;background:var(--s2)}
.emo:hover{border-color:var(--b3);color:var(--t1)}
.emo.sel{background:rgba(0,240,192,.08);color:var(--accent);border-color:rgba(0,240,192,.3)}

/* ─── STARS ──────────────────────────────────── */
.stars{display:flex;gap:4px}
.star{font-size:1.3rem;cursor:pointer;color:var(--t3);transition:.1s;user-select:none;line-height:1}
.star.on{color:var(--gold);text-shadow:0 0 8px rgba(245,183,49,.4)}

/* ─── TAGS INPUT ─────────────────────────────── */
.tinput{display:flex;flex-wrap:wrap;gap:4px;align-items:center;background:var(--s2);border:1px solid var(--b2);border-radius:7px;padding:6px 9px;cursor:text;min-height:38px;transition:.12s}
.tinput:focus-within{border-color:var(--accent);box-shadow:0 0 0 2px rgba(0,240,192,.08)}
.tpill{display:inline-flex;align-items:center;gap:4px;border-radius:4px;padding:2px 8px;font-size:.65rem;font-weight:700;font-family:var(--mono)}
.tpill-ict{background:rgba(245,183,49,.1);color:var(--gold);border:1px solid rgba(245,183,49,.25)}
.tpill-kz{background:rgba(14,165,233,.1);color:var(--accent2);border:1px solid rgba(14,165,233,.25)}
.tpill-custom{background:rgba(168,85,247,.1);color:#c084fc;border:1px solid rgba(168,85,247,.25)}
.tpill .x{cursor:pointer;opacity:.5;font-size:.8rem}
.tpill .x:hover{opacity:1}
.tinput input{border:none;outline:none;background:transparent;color:var(--t1);font-size:.78rem;flex:1;min-width:80px;padding:0;font-family:var(--body)}
.tag-suggestions{background:var(--s2);border:1px solid var(--b3);border-radius:7px;padding:6px;margin-top:4px;display:none;flex-wrap:wrap;gap:4px;max-height:100px;overflow-y:auto}
.tag-suggestions.show{display:flex}
.sug{padding:3px 9px;border-radius:4px;font-size:.65rem;font-weight:700;font-family:var(--mono);cursor:pointer;transition:.1s}
.sug:hover{filter:brightness(1.2)}

/* ─── MISTAKES ───────────────────────────────── */
.mistake-grid{display:flex;flex-wrap:wrap;gap:6px}
.mk{padding:5px 11px;border-radius:6px;border:1px solid var(--b2);cursor:pointer;font-size:.7rem;font-weight:600;font-family:var(--mono);color:var(--t2);transition:.12s;background:var(--s2)}
.mk:hover{border-color:var(--red);color:var(--red)}
.mk.sel{background:rgba(255,61,90,.08);color:var(--red);border-color:rgba(255,61,90,.3)}

/* ─── JOURNAL ─────────────────────────────────── */
.jcard{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:16px;margin-bottom:10px;position:relative;overflow:hidden}
.jcard::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:linear-gradient(to bottom,var(--accent),var(--accent2))}
.jcard-hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;padding-left:8px}
.jcard-date{font-family:var(--display);font-size:1rem;letter-spacing:.3px}
.jcard-meta{font-family:var(--mono);font-size:.6rem;color:var(--t3);margin-top:2px}
.jcard-pnl{font-family:var(--mono);font-size:.9rem;font-weight:600}
.jcard-body{padding-left:8px}
.jsec{margin-bottom:8px}
.jsec-label{font-family:var(--mono);font-size:.64rem;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;color:var(--t3);margin-bottom:3px}
.jsec-text{font-size:.78rem;color:var(--t2);line-height:1.6}
.score-pill{display:inline-flex;align-items:center;gap:4px;background:var(--s2);border:1px solid var(--b2);border-radius:20px;padding:2px 10px;font-family:var(--mono);font-size:.65rem;color:var(--t2)}
.score-pill .val{color:var(--gold);font-weight:600}

/* ─── ANALYTICS ──────────────────────────────── */
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--b1)}
.stat-row:last-child{border-bottom:none}
.stat-k{font-size:.75rem;color:var(--t2)}
.stat-v{font-family:var(--mono);font-size:.75rem}
.prog{height:3px;background:var(--b1);border-radius:2px;overflow:hidden;margin-top:3px}
.prog-fill{height:100%;border-radius:2px;transition:width .5s}

/* ─── HEATMAP ─────────────────────────────────── */
.heatmap-wrap{overflow-x:auto;padding-bottom:4px}
.heatmap{display:grid;grid-template-rows:repeat(7,1fr);grid-auto-flow:column;gap:3px;width:max-content}
.hcell{width:14px;height:14px;border-radius:2px;cursor:default;transition:.1s}
.hcell:hover{transform:scale(1.3)}

/* ─── IMPORT ──────────────────────────────────── */
.drop-zone{border:2px dashed var(--b2);border-radius:var(--r);padding:40px;text-align:center;cursor:pointer;transition:.2s;position:relative;overflow:hidden}
.drop-zone::before{content:'';position:absolute;top:0;right:0;bottom:0;left:0;background:radial-gradient(ellipse at center,rgba(0,240,192,.03) 0%,transparent 70%);pointer-events:none}
.drop-zone:hover,.drop-zone.drag{border-color:var(--accent);background:rgba(0,240,192,.03);box-shadow:0 0 30px rgba(0,240,192,.08);animation:dropPulse 1.5s ease infinite}
@keyframes dropPulse{0%,100%{box-shadow:0 0 30px rgba(0,240,192,.08)}50%{box-shadow:0 0 40px rgba(0,240,192,.14)}}
.drop-icon{font-size:2rem;margin-bottom:8px}
.drop-zone h3{font-family:var(--display);font-size:1.1rem;letter-spacing:.5px;margin-bottom:4px}
.drop-zone p{font-size:.75rem;color:var(--t3)}
.alert-box{background:rgba(0,240,192,.04);border:1px solid rgba(0,240,192,.12);border-radius:8px;padding:12px 14px;font-size:.76rem;color:var(--t2);line-height:1.6;margin-bottom:12px}
.alert-box strong{color:var(--accent)}
.step{display:flex;gap:10px;margin-bottom:8px;align-items:flex-start}
.step-n{width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;font-size:.62rem;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
.step-t{font-size:.76rem;color:var(--t2);line-height:1.5}
.step-t strong{color:var(--t1)}
.import-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px}
.import-card{background:var(--s2);border:1px solid var(--b1);border-radius:var(--r);padding:16px;text-align:center;cursor:pointer;transition:.15s}
.import-card:hover{border-color:var(--accent);background:rgba(0,240,192,.04);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
.import-card.has-data{border-color:var(--green)}
.import-card-icon{font-size:1.6rem;margin-bottom:6px}
.import-card-name{font-family:var(--display);font-size:.9rem;letter-spacing:.3px;margin-bottom:3px}
.import-card-desc{font-size:.68rem;color:var(--t3)}
.import-card-status{margin-top:6px;font-family:var(--mono);font-size:.62rem}

/* ─── SESSION POPUP ───────────────────────────── */
.session-overlay{position:fixed;top:0;right:0;bottom:0;left:0;background:rgba(0,0,0,.85);z-index:500;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px);opacity:0;pointer-events:none;transition:opacity .25s}
.session-overlay.open{opacity:1;pointer-events:all}
.session-modal{background:var(--s1);border:1px solid var(--b3);border-radius:16px;width:min(520px,92vw);max-height:88vh;overflow-y:auto;padding:24px;transform:scale(.95);transition:transform .25s;position:relative}
.session-overlay.open .session-modal{transform:scale(1)}
.session-modal::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2),var(--purple));border-radius:16px 16px 0 0}
.session-modal::-webkit-scrollbar{width:4px}
.session-modal::-webkit-scrollbar-thumb{background:var(--b2);border-radius:2px}
.sesh-title{font-family:var(--display);font-size:1.5rem;letter-spacing:.5px;margin-bottom:4px}
.sesh-sub{font-family:var(--mono);font-size:.62rem;color:var(--t3);letter-spacing:1px;text-transform:uppercase;margin-bottom:18px}
.slider-wrap{display:flex;flex-direction:column;gap:4px;margin-bottom:4px}
.slider-row{display:flex;align-items:center;gap:10px}
input[type=range]{-webkit-appearance:none;appearance:none;flex:1;height:4px;border-radius:2px;background:var(--b2);outline:none;border:none;padding:0}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 8px rgba(0,240,192,.4)}
.slider-val{font-family:var(--mono);font-size:.75rem;color:var(--accent);min-width:18px;text-align:right}
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--b1)}
.toggle-row:last-child{border-bottom:none}
.toggle-label{font-size:.8rem;font-weight:500}
.toggle{width:36px;height:20px;background:var(--b2);border-radius:10px;cursor:pointer;position:relative;transition:.2s;border:none;flex-shrink:0}
.toggle.on{background:var(--accent)}
.toggle::after{content:'';position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;top:3px;left:3px;transition:.2s}
.toggle.on::after{left:19px}
.sesh-fgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}

/* ─── EMPTY ───────────────────────────────────── */
.empty{text-align:center;padding:60px 20px}
.empty-icon{font-size:2.5rem;margin-bottom:12px;opacity:.25;filter:grayscale(.5)}
.empty h3{font-family:var(--display);font-size:1.1rem;letter-spacing:.3px;color:var(--t2);margin-bottom:5px}
.empty p{font-size:.75rem;color:var(--t3);line-height:1.6;max-width:260px;margin:0 auto}

/* ─── FILTER ROW ──────────────────────────────── */
.frow{display:flex;gap:7px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.fchip{padding:5px 12px;border-radius:20px;border:1px solid var(--b2);background:var(--s2);font-size:.7rem;font-weight:600;cursor:pointer;color:var(--t2);transition:.18s ease;font-family:var(--mono)}
.fchip:hover:not(.on){background:var(--s3);color:var(--t1)}
.fchip.on{background:rgba(0,240,192,.08);color:var(--accent);border-color:rgba(0,240,192,.25)}
input.search{background:var(--s2);border:1px solid var(--b2);border-radius:20px;padding:5px 14px;color:var(--t1);font-family:var(--body);font-size:.75rem;outline:none;transition:.12s;width:200px}
input.search:focus{border-color:var(--accent);width:240px}

/* ─── TOAST ───────────────────────────────────── */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--s2);border:1px solid var(--b3);border-radius:10px;padding:10px 22px;font-size:.78rem;color:var(--t1);z-index:999;transition:.3s cubic-bezier(.22,1,.36,1);box-shadow:0 8px 32px rgba(0,0,0,.5);font-family:var(--mono);backdrop-filter:blur(12px)}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.ok{border-color:rgba(0,229,160,.3);color:var(--green)}
.toast.err{border-color:rgba(255,61,90,.3);color:var(--red)}

/* ─── WEEKLY REPORT ───────────────────────────── */
.week-card{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:16px;margin-bottom:10px}
.week-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.week-title{font-family:var(--display);font-size:1rem;letter-spacing:.3px}
.week-pnl{font-family:var(--mono);font-size:1rem;font-weight:600}
.week-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
.ws{background:var(--s2);border-radius:7px;padding:8px;text-align:center}
.ws-label{font-family:var(--mono);font-size:.58rem;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:3px}
.ws-val{font-family:var(--mono);font-size:.85rem;font-weight:600}

/* ─── PROGRESS RING ───────────────────────────── */
.ring-wrap{position:relative;display:inline-flex;align-items:center;justify-content:center}
.ring-wrap svg{transform:rotate(-90deg)}
.ring-label{position:absolute;text-align:center}
.ring-num{font-family:var(--mono);font-size:1.1rem;font-weight:600;color:var(--t1);line-height:1}
.ring-sub{font-size:.6rem;color:var(--t3)}

/* ─── KILLZONE TABLE ──────────────────────────── */
.kz-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--b1)}
.kz-row:last-child{border-bottom:none}
.kz-name{font-family:var(--mono);font-size:.72rem;color:var(--accent2)}
.kz-bar{flex:1;margin:0 12px;height:4px;background:var(--b1);border-radius:2px;overflow:hidden}
.kz-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.kz-val{font-family:var(--mono);font-size:.72rem;min-width:60px;text-align:right}

/* HELP */
.help-tabs{display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap}
.htab{padding:6px 14px;border-radius:20px;border:1px solid var(--b2);background:var(--s2);font-size:.72rem;font-weight:700;cursor:pointer;color:var(--t2);transition:.12s;font-family:var(--mono);letter-spacing:.5px}
.htab.on{background:rgba(0,240,192,.1);color:var(--accent);border-color:rgba(0,240,192,.3)}
.help-section{display:none}.help-section.on{display:block}
.hcard{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:20px;margin-bottom:12px}
.hcard-title{font-family:var(--display);font-size:1.1rem;letter-spacing:.5px;margin-bottom:10px;color:var(--accent)}
.hcard p{font-size:.8rem;color:var(--t2);line-height:1.7;margin-bottom:8px}
.hcard p:last-child{margin-bottom:0}
.hcard strong{color:var(--t1)}
.hcard code{font-family:var(--mono);background:var(--s2);border:1px solid var(--b2);border-radius:4px;padding:1px 6px;font-size:.75rem;color:var(--accent)}
.hstep{display:flex;gap:12px;margin-bottom:12px;align-items:flex-start}
.hstep-n{width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;font-size:.65rem;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;font-family:var(--mono)}
.hstep-body{flex:1}
.hstep-title{font-size:.82rem;font-weight:700;color:var(--t1);margin-bottom:2px}
.hstep-desc{font-size:.76rem;color:var(--t2);line-height:1.6}
.hstep-desc strong{color:var(--accent)}
.metric-explain{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
.me-card{background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:12px}
.me-name{font-family:var(--mono);font-size:.7rem;font-weight:600;color:var(--accent);margin-bottom:4px;letter-spacing:.5px}
.me-def{font-size:.74rem;color:var(--t2);line-height:1.5;margin-bottom:4px}
.me-eg{font-family:var(--mono);font-size:.68rem;color:var(--gold)}
.ict-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
.ict-card{background:var(--s2);border:1px solid rgba(245,183,49,.15);border-radius:8px;padding:12px}
.ict-name{font-family:var(--mono);font-size:.72rem;font-weight:700;color:var(--gold);margin-bottom:5px}
.ict-def{font-size:.74rem;color:var(--t2);line-height:1.5}
.kz-explain{display:flex;flex-direction:column;gap:8px}
.kz-card{background:var(--s2);border:1px solid rgba(14,165,233,.15);border-radius:8px;padding:12px;display:flex;gap:12px;align-items:flex-start}
.kz-time{font-family:var(--mono);font-size:.68rem;color:var(--accent2);min-width:120px;padding-top:2px}
.kz-info-name{font-size:.8rem;font-weight:700;color:var(--t1);margin-bottom:3px}
.kz-info-desc{font-size:.73rem;color:var(--t2);line-height:1.5}
.shortcut-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
.sc-row{display:flex;align-items:center;justify-content:space-between;background:var(--s2);border:1px solid var(--b1);border-radius:7px;padding:9px 12px}
.sc-key{font-family:var(--mono);font-size:.72rem;color:var(--accent)}
.sc-desc{font-size:.74rem;color:var(--t2)}
kbd{background:var(--s3);border:1px solid var(--b3);border-radius:4px;padding:2px 7px;font-family:var(--mono);font-size:.68rem;color:var(--t1);box-shadow:0 2px 0 var(--b3)}
.img-mock{background:var(--s2);border:1px solid var(--b2);border-radius:8px;padding:16px;text-align:center;font-size:.75rem;color:var(--t3);font-family:var(--mono);margin:10px 0}
.warn-box{background:rgba(245,183,49,.05);border:1px solid rgba(245,183,49,.2);border-radius:8px;padding:12px 14px;font-size:.76rem;color:var(--t2);margin:10px 0;line-height:1.6}
.warn-box strong{color:var(--gold)}
.tip-box{background:rgba(0,240,192,.04);border:1px solid rgba(0,240,192,.12);border-radius:8px;padding:12px 14px;font-size:.76rem;color:var(--t2);margin:10px 0;line-height:1.6}
.tip-box strong{color:var(--accent)}
/* FLOATING HELP BTN */
.help-fab{position:fixed;bottom:24px;right:24px;width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(0,240,192,.3);z-index:150;transition:.2s;font-family:var(--mono);font-size:.9rem;font-weight:700;color:#000}
.help-fab:hover{transform:scale(1.1);box-shadow:0 6px 28px rgba(0,240,192,.4)}
/* ONBOARDING TOUR */
.tour-overlay{position:fixed;top:0;right:0;bottom:0;left:0;z-index:400;pointer-events:none}
.tour-highlight{position:fixed;border-radius:10px;box-shadow:0 0 0 9999px rgba(0,0,0,.75);z-index:401;transition:.3s;pointer-events:none}
.tour-tooltip{position:fixed;background:var(--s1);border:1px solid var(--b3);border-radius:12px;padding:18px 20px;width:300px;z-index:402;box-shadow:0 8px 40px rgba(0,0,0,.6);transition:.3s;pointer-events:auto}
.tour-tooltip::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:12px 12px 0 0}
.tour-step-label{font-family:var(--mono);font-size:.58rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--t3);margin-bottom:4px}
.tour-title{font-family:var(--display);font-size:1rem;letter-spacing:.3px;margin-bottom:6px}
.tour-desc{font-size:.76rem;color:var(--t2);line-height:1.6;margin-bottom:14px}
.tour-footer{display:flex;align-items:center;justify-content:space-between}
.tour-dots{display:flex;gap:5px}
.tour-dot{width:6px;height:6px;border-radius:50%;background:var(--b3);transition:.2s}
.tour-dot.on{background:var(--accent);width:16px;border-radius:3px}
.tour-btns{display:flex;gap:7px}
/* ═══ TRADING CALENDAR ═══ */
.cal-hdr{font-size:.6rem;font-weight:700;text-align:center;padding:6px 0;color:var(--t3);text-transform:uppercase;letter-spacing:.08em}
.cal-day{position:relative;min-height:72px;border-radius:6px;padding:5px 6px;font-family:var(--mono);cursor:default;transition:all .15s;border:1px solid transparent}
.cal-day:hover{border-color:var(--accent);transform:translateY(-1px)}
.cal-day.empty{min-height:72px;background:transparent;border:none}
.cal-day.empty:hover{border:none;transform:none}
.cal-day.today{border-color:var(--accent);box-shadow:0 0 12px rgba(0,240,192,.15)}
.cal-day .cal-num{font-size:.65rem;color:var(--t3);margin-bottom:2px}
.cal-day .cal-pnl{font-size:.82rem;font-weight:700;line-height:1.2}
.cal-day .cal-trades{font-size:.55rem;color:var(--t3);margin-top:2px}
.cal-day .cal-streak{position:absolute;top:3px;right:5px;font-size:.55rem}
.cal-day.win{background:rgba(0,229,160,.08)}
.cal-day.win .cal-pnl{color:var(--green)}
.cal-day.loss{background:rgba(255,75,85,.08)}
.cal-day.loss .cal-pnl{color:var(--red)}
.cal-day.flat{background:var(--s2)}
.cal-day.flat .cal-pnl{color:var(--t3)}
.cal-day.no-trade{background:var(--s1);opacity:.4}

/* ═══ MOBILE MENU TOGGLE ═══ */
.menu-toggle{display:none;position:fixed;top:8px;left:8px;z-index:200;width:40px;height:40px;border-radius:10px;background:var(--s2);border:1px solid var(--b2);cursor:pointer;align-items:center;justify-content:center;color:var(--t1);transition:.2s}
.menu-toggle:hover{background:var(--s3);border-color:var(--accent)}
.menu-toggle svg{width:20px;height:20px}
.sidebar-backdrop{display:none;position:fixed;top:0;right:0;bottom:0;left:0;background:rgba(0,0,0,.6);z-index:9;backdrop-filter:blur(4px)}

/* ═══ RESPONSIVE — TABLET (≤900px) ═══ */
@media(max-width:900px){
  .cr2,.cr2e{grid-template-columns:1fr}
  .cr3{grid-template-columns:1fr 1fr}
  .import-grid{grid-template-columns:1fr 1fr}
  .metric-explain,.ict-grid,.shortcut-grid{grid-template-columns:1fr}
  .week-stats{grid-template-columns:repeat(2,1fr)}
}

/* ═══ RESPONSIVE — MOBILE (≤768px) ═══ */
@media(max-width:768px){
  .menu-toggle{display:flex}
  .sidebar{position:fixed;left:-260px;top:0;bottom:0;width:250px;min-width:250px;z-index:100;transition:left .3s cubic-bezier(.22,1,.36,1);box-shadow:none}
  .sidebar.open{left:0;box-shadow:8px 0 40px rgba(0,0,0,.5)}
  .sidebar-backdrop.open{display:block}
  .main{width:100%}
  .topbar{padding:0 12px 0 52px;height:48px;min-height:48px}
  .page-title{font-size:1.15rem}
  .content{padding:12px}
  .balance-bar{padding:10px 12px;gap:14px;flex-wrap:wrap}
  .bb-val{font-size:1.2rem}
  .bb-name{font-size:.85rem}
  .chip-tray{height:140px}
  .chip-tray-hud{top:6px;left:8px}
  .mgrid{grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px}
  .mc{padding:10px 12px}
  .mc-val{font-size:1.1rem}
  .crow{gap:10px;margin-bottom:10px}
  .cr2,.cr2e,.cr3{grid-template-columns:1fr}
  .cc{padding:12px}
  .frow{gap:5px}
  input.search{width:100%;order:-1}
  input.search:focus{width:100%}
  .fgrid{grid-template-columns:1fr}
  .fg3{grid-template-columns:1fr}
  .sesh-fgrid{grid-template-columns:1fr}
  .import-grid{grid-template-columns:1fr}
  .modal{width:95vw;padding:16px;border-radius:12px}
  .modal-title{font-size:1.2rem}
  .session-modal{width:95vw;padding:16px}
  .drop-zone{padding:24px 16px}
  .tcard-hdr{padding:10px 12px}
  th{padding:6px 8px;font-size:.54rem}
  td{padding:7px 8px;font-size:.72rem}
  .help-fab{bottom:16px;right:16px;width:38px;height:38px;font-size:.8rem}
  .sb-footer .acct-card{padding:8px 10px}
  .cal-day{min-height:56px;padding:4px}
  .cal-day .cal-pnl{font-size:.7rem}
  .cal-day .cal-num{font-size:.58rem}
  .cal-day .cal-trades{font-size:.5rem}
  .toast{max-width:90vw;font-size:.72rem;padding:8px 16px}
  .week-stats{grid-template-columns:repeat(2,1fr)}
  .kz-card{flex-direction:column;gap:6px}
  .kz-time{min-width:0}
  /* inline grid settings views */
  #view-settings > div,#view-analytics > div:first-child,#view-ict > div:first-child{grid-template-columns:1fr !important}
  /* inline grid overrides for all 2-col grids */
  [style*="grid-template-columns:1fr 1fr"],[style*="grid-template-columns: 1fr 1fr"]{grid-template-columns:1fr !important}
  [style*="grid-template-columns:repeat(4"]{grid-template-columns:repeat(2,1fr) !important}
}

/* ═══ RESPONSIVE — SMALL MOBILE (≤480px) ═══ */
@media(max-width:480px){
  .topbar{gap:6px;padding:0 8px 0 48px}
  .topbar .btn{padding:4px 8px;font-size:.68rem}
  .topbar .session-btn span{display:none}
  .page-title{font-size:1rem}
  .content{padding:10px 8px}
  .mgrid{grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px}
  .mc{padding:8px 10px}
  .mc-label{font-size:.54rem}
  .mc-val{font-size:1rem}
  .modal{padding:12px}
  .fgrid{gap:8px}
  .cal-day{min-height:48px;padding:3px}
  .cal-day .cal-pnl{font-size:.62rem}
  .cal-hdr{font-size:.5rem;padding:4px 0}
}

</style>
</head>
<body>


<!-- SPLASH SCREEN -->
<div class="splash" id="splash">
  <img class="splash-logo" src="data:image/png;base64,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" alt="TradeEdge ICT">
  <div class="splash-title">TradeEdge</div>
  <div class="splash-sub">Intra Circle Trading</div>
  <div class="splash-bar"><div class="splash-fill" id="splash-fill"></div></div>
</div>
<script>
// Failsafe: always remove splash after 2.5s no matter what
(function(){
  var splash = document.getElementById('splash');
  var fill = document.getElementById('splash-fill');
  if(!splash) return;
  // Animate progress bar
  var steps = [20,45,70,90,100], i = 0;
  var iv = setInterval(function(){
    if(fill && i < steps.length){ fill.style.width = steps[i]+'%'; i++; }
    if(i >= steps.length) clearInterval(iv);
  }, 250);
  // Always remove splash
  setTimeout(function(){
    splash.style.opacity = '0';
    setTimeout(function(){ splash.remove(); }, 600);
  }, 1800);
})();
</script>

<button class="menu-toggle" id="menu-toggle" onclick="toggleSidebar()">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</button>
<div class="sidebar-backdrop" id="sidebar-backdrop" onclick="toggleSidebar()"></div>


<noscript><style>.splash{display:none!important}</style><div style="padding:40px;text-align:center;color:#fff;font-family:sans-serif"><h2>JavaScript Required</h2><p>Please open this file in Safari for full functionality.</p></div></noscript>
<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="logo-wrap">
    <div class="logo-top">
      <div class="logo-icon">
        <img src="data:image/png;base64,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" alt="ICT">
      </div>
      <div class="logo-name">TradeEdge</div>
    </div>
    <div class="logo-sub">Intra Circle Trading · ICT · AMP</div>
  </div>
  <div class="nav">
    <div class="nlabel">Overview</div>
    <div class="ni active" data-view="dashboard" onclick="go('dashboard')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Dashboard
    </div>
    <div class="ni" data-view="trades" onclick="go('trades')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="13" y2="16"/></svg>
      Trade Log
      <span class="badge-count" id="trade-count-badge" style="display:none">0</span>
    </div>
    <div class="ni" data-view="journal" onclick="go('journal')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
      Journal
    </div>
    <div class="nlabel">Analytics</div>
    <div class="ni" data-view="analytics" onclick="go('analytics')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Performance
    </div>
    <div class="ni" data-view="ict" onclick="go('ict')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
      ICT Analytics
    </div>
    <div class="ni" data-view="weekly" onclick="go('weekly')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Weekly Report
    </div>
    <div class="nlabel">Data</div>
    <div class="ni" data-view="import" onclick="go('import')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      Import Data
    </div>
    <div class="ni" data-view="settings" onclick="go('settings')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      Settings
    </div>
    <div class="ni" data-view="help" onclick="go('help')" style="background:rgba(0,240,192,.05);border:1px solid rgba(0,240,192,.15);color:var(--accent)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      Help & Tutorial
    </div>
  </div>
  <div class="sb-footer">
    <div class="acct-card">
      <div class="acct-label">Account · AMP Futures</div>
      <div class="acct-name" id="acct-name">Trader</div>
      <div class="acct-row">
        <div class="acct-bal" id="sb-bal" style="color:var(--t3)">$0.00</div>
        <div class="acct-dot"></div>
      </div>
    </div>
  </div>
</nav>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="page-title" id="page-title">Dashboard</div>
    <button class="btn btn-ghost btn-sm session-btn" onclick="openPreSession()">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <span>Start Session</span>
    </button>
    <button class="btn btn-ghost btn-sm" onclick="go('import')">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      Import
    </button>
    <button class="btn btn-accent btn-sm" onclick="openTrade()">+ Add Trade</button>
  </div>

  <div class="content">

    <!-- ═══ DASHBOARD ═══ -->
    <div class="view active" id="view-dashboard">
      <div id="dash-debug" style="font-size:.7rem;font-family:var(--mono);padding:6px 12px;margin-bottom:8px;background:var(--s2);border-radius:6px;display:none"></div>
      <div class="balance-bar" id="balance-bar">
        <div class="bb-item">
          <div class="bb-label">Account</div>
          <div class="bb-name" id="bb-name">Trader</div>
        </div>
        <div class="bb-sep"></div>
        <div class="bb-item" style="position:relative">
          <div class="bb-label">Account Balance</div>
          <div style="display:flex;align-items:center;gap:10px">
            <div class="bb-val" id="bb-balance" style="color:var(--green)">$0.00</div>
          </div>
          <div id="bb-breakdown" style="font-size:.5rem;font-family:var(--mono);color:rgba(255,255,255,.25);margin-top:2px;letter-spacing:.5px"></div>
        </div>
        <div class="bb-sep"></div>
        <div class="bb-item">
          <div class="bb-label">Net P&L <span id="bb-trade-count" style="font-size:.48rem;color:rgba(255,255,255,.25);font-family:var(--mono)"></span></div>
          <div class="bb-val" id="bb-pnl" style="color:var(--t3);font-size:1.1rem">$0.00</div>
        </div>
      </div>
      <!-- 3D CHIP TRAY -->
      <div class="chip-tray" id="chip-tray">
        <div class="chip-tray-scan"></div>
        <div class="chip-tray-hud">
          <div class="chip-tray-label">Chip Stack</div>
          <div class="chip-tray-count" id="chip-tray-count"></div>
          <button id="chip-test-btn" onclick="window.testChips(50000)" style="pointer-events:auto;position:absolute;top:4px;right:4px;background:rgba(255,255,255,.15);color:#0f8;border:1px solid rgba(0,240,192,.4);border-radius:4px;padding:3px 10px;font-size:.6rem;font-family:var(--mono);cursor:pointer;z-index:10;letter-spacing:1px">TEST $50K</button>
        </div>
        <canvas id="chip-canvas" style="display:none"></canvas>
        <div id="chip-css-fallback" style="display:none"></div>
      </div>
      <div class="mgrid" id="mgrid"></div>
      
      <!-- ═══ TRADING CALENDAR ═══ -->
      <div class="cc" style="margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <button class="btn btn-ghost btn-sm" onclick="calNav(-1)" style="padding:4px 10px">◀</button>
          <div class="cc-title" id="cal-title" style="margin:0;font-size:.85rem">TRADING CALENDAR</div>
          <button class="btn btn-ghost btn-sm" onclick="calNav(1)" style="padding:4px 10px">▶</button>
        </div>
        <div class="cal-summary" id="cal-summary" style="display:flex;gap:16px;justify-content:center;margin-bottom:12px;font-size:.72rem;font-family:var(--mono)"></div>
        <div id="cal-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px"></div>
      </div>
      
      <div class="crow cr2">
        <div class="cc">
          <div class="cc-title">EQUITY CURVE <span id="eq-total"></span></div>
          <svg id="eq-svg" style="width:100%;height:170px;overflow:visible;display:block"></svg>
        </div>
        <div class="cc">
          <div class="cc-title">WIN / LOSS RATIO</div>
          <div style="display:flex;align-items:center;justify-content:center;height:170px">
            <canvas id="donut-c" width="170" height="170"></canvas>
          </div>
        </div>
      </div>
      <div class="crow cr2e">
        <div class="cc">
          <div class="cc-title">P&L BY DAY OF WEEK</div>
          <canvas id="dow-c" style="width:100%;height:120px;display:block"></canvas>
        </div>
        <div class="cc">
          <div class="cc-title">P&L BY KILLZONE</div>
          <div id="kz-chart" style="padding-top:4px"></div>
        </div>
      </div>
    </div>

    <!-- ═══ TRADE LOG ═══ -->
    <div class="view" id="view-trades">
      <div class="frow">
        <input class="search" id="srch" placeholder="Search symbol, tag, setup…" oninput="renderTrades()">
        <div class="fchip on" data-f="all" onclick="setF('all',this)">ALL</div>
        <div class="fchip" data-f="win" onclick="setF('win',this)">WINNERS</div>
        <div class="fchip" data-f="loss" onclick="setF('loss',this)">LOSERS</div>
        <div class="fchip" data-f="long" onclick="setF('long',this)">LONG</div>
        <div class="fchip" data-f="short" onclick="setF('short',this)">SHORT</div>
        <button class="btn btn-ghost btn-sm" style="margin-left:auto" onclick="exportCSV()">Export CSV</button>
      </div>
      <div class="tcard">
        <div class="tcard-hdr">
          <span class="tcard-title">Trade Log</span>
          <span id="tlog-count" style="font-family:var(--mono);font-size:.65rem;color:var(--t3)"></span>
        </div>
        <div style="overflow-x:auto">
          <table>
            <thead><tr>
              <th>Date</th><th>Time</th><th>Symbol</th><th>Side</th><th>Qty</th>
              <th>Entry</th><th>Exit</th><th>SL / $Risk</th><th>TP / $Target</th>
              <th>Gross P&L</th><th>Fees</th><th>Net P&L</th>
              <th>R:R</th><th>Exit Reason</th><th>Setup</th><th>Killzone</th><th>Emotion</th><th>⭐</th><th>Result</th><th>Chart</th>
            </tr></thead>
            <tbody id="trade-tbody"></tbody>
          </table>
        </div>
        <div id="trade-empty" class="empty" style="display:none">
          <div class="empty-icon">📋</div>
          <h3>No trades yet</h3>
          <p>Import your TradingView CSVs or add trades manually.</p>
        </div>
      </div>
    </div>

    <!-- ═══ JOURNAL ═══ -->
    <div class="view" id="view-journal">
      <div style="display:flex;justify-content:flex-end;margin-bottom:14px;gap:8px">
        <button class="btn btn-ghost btn-sm" onclick="logTradeJournal()">📝 Log Post-Trade</button>
        <button class="btn btn-accent btn-sm" onclick="openJournal()">+ Daily Journal</button>
      </div>
      <div id="journal-list"></div>
      <div id="journal-empty" class="empty" style="display:none">
        <div class="empty-icon">✍️</div>
        <h3>No journal entries yet</h3>
        <p>Start your pre-market session or add a daily journal entry.</p>
      </div>
    </div>

    <!-- ═══ ANALYTICS ═══ -->
    <div class="view" id="view-analytics">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="cc">
          <div class="cc-title">PERFORMANCE STATS</div>
          <div id="perf-stats"></div>
        </div>
        <div class="cc">
          <div class="cc-title">P&L BY SYMBOL</div>
          <div id="sym-stats"></div>
        </div>
        <div class="cc" style="grid-column:1/-1">
          <div class="cc-title">ACTIVITY CALENDAR</div>
          <div class="heatmap-wrap"><div class="heatmap" id="heatmap"></div></div>
        </div>
        <div class="cc">
          <div class="cc-title">STREAK ANALYSIS</div>
          <div id="streak-stats"></div>
        </div>
        <div class="cc">
          <div class="cc-title">RISK METRICS</div>
          <div id="risk-stats"></div>
        </div>
        <div class="cc">
          <div class="cc-title">MISTAKE FREQUENCY</div>
          <div id="mistake-stats"></div>
        </div>
        <div class="cc">
          <div class="cc-title">PSYCHOLOGICAL SCORE OVER TIME</div>
          <svg id="psych-svg" style="width:100%;height:120px;display:block;overflow:visible"></svg>
        </div>
      </div>
    </div>

    <!-- ═══ ICT ANALYTICS ═══ -->
    <div class="view" id="view-ict">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="cc" style="grid-column:1/-1">
          <div class="cc-title">ICT SETUP WIN RATE</div>
          <div id="ict-setups"></div>
        </div>
        <div class="cc">
          <div class="cc-title">KILLZONE PERFORMANCE</div>
          <div id="kz-perf"></div>
        </div>
        <div class="cc">
          <div class="cc-title">ICT CHECKLIST COMPLIANCE</div>
          <div id="ckl-compliance"></div>
        </div>
        <div class="cc">
          <div class="cc-title">HTF BIAS ACCURACY</div>
          <div id="bias-stats"></div>
        </div>
        <div class="cc">
          <div class="cc-title">TRADE TIMING ANALYSIS</div>
          <canvas id="timing-c" style="width:100%;height:140px;display:block"></canvas>
        </div>
      </div>
    </div>

    <!-- ═══ WEEKLY REPORT ═══ -->
    <div class="view" id="view-weekly">
      <div id="weekly-list"></div>
      <div id="weekly-empty" class="empty" style="display:none">
        <div class="empty-icon">📅</div>
        <h3>No weekly data yet</h3>
        <p>Add at least a week of trades to see your weekly reports.</p>
      </div>
    </div>

    <!-- ═══ IMPORT ═══ -->
    <div class="view" id="view-import">
      <div class="import-grid">
        <div class="import-card" id="ic-history">
          <div style="font-family:var(--mono);font-size:.58rem;color:var(--accent);letter-spacing:1px;margin-bottom:4px">STEP 1</div>
          <div class="import-card-icon">📊</div>
          <div class="import-card-name">Filled Orders</div>
          <div class="import-card-desc">AMP filled orders CSV — your trades</div>
          <div class="import-card-status" id="ic-history-status" style="color:var(--t3)">No file loaded</div>
        </div>
        <div class="import-card" id="ic-cancelled">
          <div style="font-family:var(--mono);font-size:.58rem;color:var(--accent2);letter-spacing:1px;margin-bottom:4px">STEP 2</div>
          <div class="import-card-icon">🎯</div>
          <div class="import-card-name">Cancelled Orders</div>
          <div class="import-card-desc">AMP cancelled CSV — reconstructs SL/TP</div>
          <div class="import-card-status" id="ic-cancelled-status" style="color:var(--t3)">No file loaded</div>
        </div>
        <div class="import-card" id="ic-pdf">
          <div style="font-family:var(--mono);font-size:.58rem;color:var(--gold);letter-spacing:1px;margin-bottom:4px">STEP 3</div>
          <div class="import-card-icon">📄</div>
          <div class="import-card-name">AMP Statement PDF</div>
          <div class="import-card-desc">Sets starting balance automatically</div>
          <div class="import-card-status" id="ic-pdf-status" style="color:var(--t3)">No files loaded</div>
        </div>
      </div>
      <div id="import-order-warn" style="display:none;background:rgba(245,183,49,.08);border:1px solid rgba(245,183,49,.25);border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:.76rem;color:var(--gold);display:flex;align-items:center;gap:8px">
        <span style="font-size:1.1rem">⚠️</span>
        <span id="import-order-warn-text"></span>
      </div>

      <input type="file" id="fi-smart" accept=".csv,.pdf,.txt,.PDF" style="display:none" onchange="smartImport(event)" multiple>

      <div class="drop-zone" id="drop-zone" ondragover="doDrag(event)" ondragleave="doDragLeave(event)" ondrop="doDrop(event)" onclick="document.getElementById('fi-smart').click()">
        <div class="drop-icon">📂</div>
        <h3>Drop All 3 Files At Once</h3>
        <p>Select filled CSV + cancelled CSV + AMP PDF together — auto-sorted instantly</p>
        <div style="margin-top:10px;display:flex;gap:6px;justify-content:center;flex-wrap:wrap">
          <span class="tag" style="font-size:.6rem">1️⃣ filled-*.csv → Trades</span>
          <span class="tag" style="font-size:.6rem">2️⃣ cancelled-*.csv → SL/TP</span>
          <span class="tag" style="font-size:.6rem">3️⃣ *.pdf → Balance</span>
        </div>
      </div>

      <div id="import-route-log" style="display:none;margin-top:10px">
        <div class="cc" style="border-color:rgba(0,240,192,.2)">
          <div class="cc-title">FILE ROUTING</div>
          <div id="import-route-list" style="font-size:.72rem;font-family:var(--mono)"></div>
        </div>
      </div>

      <div class="alert-box">
        <strong>AMP Import — Drop all 3 files at once:</strong>
        <div style="margin-top:8px">
          <div class="step"><div class="step-n">1</div><div class="step-t">In AMP → Order History → download <strong>Filled Orders</strong> CSV</div></div>
          <div class="step"><div class="step-n">2</div><div class="step-t">In AMP → Order History → download <strong>Cancelled Orders</strong> CSV (reconstructs your SL/TP levels)</div></div>
          <div class="step"><div class="step-n">3</div><div class="step-t">In AMP → Daily Statements → download your latest <strong>PDF statement</strong> (sets starting balance automatically)</div></div>
          <div class="step"><div class="step-n" style="background:linear-gradient(135deg,var(--accent),var(--gold))">✓</div><div class="step-t"><strong>Select all 3 files together</strong> and drop here — order doesn't matter, everything auto-computes</div></div>
        </div>
      </div>

      <div id="import-preview" style="display:none">
        <div class="cc">
          <div class="cc-title">IMPORT LOG <span style="font-size:.65rem;color:var(--green);text-transform:none">Auto-imported ✓</span></div>
          <div style="overflow-x:auto"><table><thead><tr id="prev-head"></tr></thead><tbody id="prev-body"></tbody></table></div>
        </div>
      </div>

      <!-- AMP STATEMENTS SUMMARY -->
      <div id="amp-statements-panel" style="display:none;margin-top:16px">
        <div class="cc">
          <div class="cc-title">AMP STATEMENTS <span id="amp-stmt-count"></span></div>
          <div id="amp-statements-list" style="max-height:300px;overflow-y:auto"></div>
        </div>
      </div>

      <!-- IMPORT HISTORY LOG -->
      <div class="cc" style="margin-top:16px">
        <div class="cc-title">IMPORT HISTORY <span id="import-log-count" style="font-size:.68rem;color:var(--t2);text-transform:none;letter-spacing:0"></span></div>
        <div id="import-log-list">
          <p style="font-size:.72rem;color:var(--t3);padding:8px 0">No imports yet.</p>
        </div>
      </div>
    </div>

    <!-- ═══ SETTINGS ═══ -->
    <div class="view" id="view-settings">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="cc">
          <div class="cc-title">FEE RATES PER SYMBOL</div>
          <p style="font-size:.74rem;color:var(--t3);margin-bottom:12px;line-height:1.5">Set your all-in fee per contract per side. Based on your AMP PDF: MNQ total = $0.90/side.</p>
          <div id="fee-settings"></div>
        <div class="fg" style="margin-top:12px">
          <label>Account Holder Name</label>
          <input id="set-name" placeholder="Auto-detected from AMP PDF" oninput="S.accountName=this.value.trim();save();updateSidebar();">
        </div>
        <div class="fg" style="margin-top:12px">
          <label>Starting Account Balance ($)</label>
          <input id="set-balance" type="number" step="0.01" placeholder="e.g. 223.00" oninput="S.startingBalance=parseFloat(this.value)||0;save();renderDash();updateSidebar();">
          <div style="font-size:.65rem;color:var(--t3);margin-top:2px">Your account balance BEFORE your first trade. Current balance = Starting Balance + Net P&L. Based on your AMP account, enter <strong style="color:var(--accent)">223.00</strong>.</div>
        </div>

          <button class="btn btn-accent btn-sm" style="margin-top:12px;font-family:var(--body)" onclick="saveFees()">Save Fee Rates</button>
        </div>
        <div class="cc">
          <div class="cc-title">AMP EXTRACTED FEES</div>
          <div id="amp-fees-display">
            <p style="font-size:.74rem;color:var(--t3)">Import an AMP PDF statement to see your exact fee breakdown here.</p>
          </div>
        </div>
        <div class="cc" style="grid-column:1/-1">
          <div class="cc-title">DATA MANAGEMENT</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-ghost btn-sm" onclick="exportAllCSV()">Export All Data (CSV)</button>
            <button class="btn btn-ghost btn-sm" onclick="exportJSON()">Backup (JSON)</button>
            <button class="btn btn-ghost btn-sm" onclick="importJSON()">Restore from Backup</button>
            <button class="btn btn-red btn-sm" onclick="clearAll()">Clear All Data</button>
          </div>
        </div>
      </div>
    </div>


    <!-- HELP VIEW -->
    <div class="view" id="view-help"></div>
  </div><!-- .content -->
</div><!-- .main -->

<!-- ═══════════════════════════════════════════════ -->
<!-- ADD TRADE MODAL -->
<!-- ═══════════════════════════════════════════════ -->
<div class="overlay" id="trade-overlay">
  <div class="modal" style="max-width:720px">
    <div class="modal-title" id="trade-modal-title">Add Trade</div>

    <div class="msection">
      <div class="msection-title">Trade Details</div>
      <div class="fgrid fg3" style="margin-bottom:10px">
        <div class="fg"><label>Date</label><input type="date" id="f-date"></div>
        <div class="fg"><label>Time (ET)</label><input type="time" id="f-time"></div>
        <div class="fg"><label>Symbol</label>
          <select id="f-sym">
            <option>MNQ</option><option>MES</option><option>NQ</option><option>ES</option>
            <option>CL</option><option>GC</option><option value="other">Other</option>
          </select>
        </div>
        <div class="fg"><label>Side</label>
          <select id="f-side"><option>Long</option><option>Short</option></select>
        </div>
        <div class="fg"><label>Quantity (contracts)</label><input type="number" id="f-qty" min="1" value="1"></div>
        <div class="fg"><label>Killzone</label>
          <select id="f-kz">
            <option value="">— Select —</option>
            <option>London (2–5am ET)</option>
            <option>NY AM (8:30–11am ET)</option>
            <option>NY Lunch (11am–1pm ET)</option>
            <option>NY PM (1:30–4pm ET)</option>
            <option>Macro Window</option>
            <option>News Event</option>
            <option>Outside Killzone</option>
          </select>
        </div>
      </div>
      <div class="fgrid" style="margin-bottom:0">
        <div class="fg"><label>Entry Price</label><input type="number" id="f-entry" step="0.01"></div>
        <div class="fg"><label>Exit Price</label><input type="number" id="f-exit" step="0.01"></div>
        <div class="fg"><label>Est. SL Price</label><input type="number" id="f-sl" step="0.01" placeholder="From cancelled orders"></div>
        <div class="fg"><label>Est. TP Price</label><input type="number" id="f-tp" step="0.01" placeholder="From cancelled orders"></div>
        <div class="fg"><label>Gross P&L ($)</label><input type="number" id="f-pnl" step="0.01"></div>
        <div class="fg"><label>Total Fees ($)</label><input type="number" id="f-fees" step="0.01" value="0" id="f-fees" placeholder="Auto from AMP PDF"></div>
      </div>
      <div id="sltp-info" style="display:none"></div>
    </div>

    <div class="msection">
      <div class="msection-title">ICT Setup Tags</div>
      <div class="tinput" id="tag-wrap" onclick="this.querySelector('input').focus()">
        <input type="text" id="tag-input" placeholder="Type or pick below…" oninput="filterTags()" onkeydown="tagKey(event)">
      </div>
      <div class="tag-suggestions show" id="tag-sug"></div>
    </div>

    <div class="msection">
      <div class="msection-title">ICT Pre-Trade Checklist</div>
      <div class="ckl" id="checklist"></div>
    </div>

    <div class="msection">
      <div class="msection-title">Psychology</div>
      <div class="fgrid" style="margin-bottom:10px">
        <div class="fg full">
          <label>Emotional State</label>
          <div class="emo-grid" id="emo-grid">
            <div class="emo" onclick="toggleEmo(this)">😌 Calm</div>
            <div class="emo" onclick="toggleEmo(this)">🎯 Focused</div>
            <div class="emo" onclick="toggleEmo(this)">💪 Disciplined</div>
            <div class="emo" onclick="toggleEmo(this)">😎 Confident</div>
            <div class="emo" onclick="toggleEmo(this)">😤 Frustrated</div>
            <div class="emo" onclick="toggleEmo(this)">😰 Anxious</div>
            <div class="emo" onclick="toggleEmo(this)">😴 Tired</div>
            <div class="emo" onclick="toggleEmo(this)">🤑 FOMO</div>
            <div class="emo" onclick="toggleEmo(this)">😡 Revenge</div>
            <div class="emo" onclick="toggleEmo(this)">🧘 Patient</div>
          </div>
        </div>
      </div>
      <div class="fg full" style="margin-bottom:10px">
        <label>Mistakes Made</label>
        <div class="mistake-grid" id="mistake-grid">
          <div class="mk" onclick="toggleMk(this)">Revenge Trade</div>
          <div class="mk" onclick="toggleMk(this)">Moved SL</div>
          <div class="mk" onclick="toggleMk(this)">Overtrading</div>
          <div class="mk" onclick="toggleMk(this)">Early Exit</div>
          <div class="mk" onclick="toggleMk(this)">Hesitation</div>
          <div class="mk" onclick="toggleMk(this)">Off-Plan Entry</div>
          <div class="mk" onclick="toggleMk(this)">Sized Too Big</div>
          <div class="mk" onclick="toggleMk(this)">Chased Move</div>
        </div>
      </div>
      <div class="fg full" style="margin-bottom:10px">
        <label>Execution Rating</label>
        <div class="stars" id="star-row">
          <span class="star" onclick="setStar(1)">★</span>
          <span class="star" onclick="setStar(2)">★</span>
          <span class="star" onclick="setStar(3)">★</span>
          <span class="star" onclick="setStar(4)">★</span>
          <span class="star" onclick="setStar(5)">★</span>
        </div>
      </div>
      <div class="fg full" style="margin-bottom:10px">
        <label>HTF Bias</label>
        <select id="f-bias"><option value="">— Select —</option><option>Bullish</option><option>Bearish</option><option>Neutral</option></select>
      </div>
    </div>

    <div class="msection">
      <div class="msection-title">Notes & Charts</div>
      <div class="fgrid">
        <div class="fg full"><label>Trade Notes / Lesson Learned</label>
          <textarea id="f-notes" placeholder="What happened? Did price respect the OB? Was there a FVG fill? What would you do differently?"></textarea>
        </div>
        <div class="fg"><label>TradingView Chart Link</label><input type="url" id="f-chart-url" placeholder="https://www.tradingview.com/x/..."></div>
        <div class="fg"><label>Screenshot Upload</label><input type="file" id="f-chart-img" accept="image/*" onchange="previewImg(event)"></div>
        <div class="fg full" id="img-preview-wrap" style="display:none">
          <a id="img-preview-link" href="#" target="_blank" title="Click to open full size" style="display:block;position:relative">
            <img id="img-preview" style="max-width:100%;max-height:200px;border-radius:7px;border:1px solid var(--b2);cursor:pointer;display:block" src="">
            <span style="position:absolute;top:6px;right:6px;background:rgba(0,0,0,.6);color:var(--accent);font-family:var(--mono);font-size:.58rem;padding:2px 7px;border-radius:4px;pointer-events:none">↗ open</span>
          </a>
        </div>
      </div>
    </div>

    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeModal('trade-overlay')">Cancel</button>
      <button class="btn btn-red btn-sm" id="del-btn" style="display:none" onclick="deleteTrade()">Delete Trade</button>
      <button class="btn btn-accent" onclick="saveTrade()">Save Trade</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════ -->
<!-- JOURNAL MODAL -->
<!-- ═══════════════════════════════════════════════ -->
<div class="overlay" id="journal-overlay">
  <div class="modal">
    <div class="modal-title">Daily Journal</div>
    <div class="msection">
      <div class="msection-title">Session Info</div>
      <div class="fgrid">
        <div class="fg"><label>Date</label><input type="date" id="j-date"></div>
        <div class="fg"><label>HTF Market Bias</label>
          <select id="j-bias"><option value="">— Select —</option><option>Bullish</option><option>Bearish</option><option>Neutral</option><option>Mixed / Range</option></select>
        </div>
      </div>
    </div>
    <div class="msection">
      <div class="msection-title">Pre-Market Plan</div>
      <div class="fg full">
        <textarea id="j-pre" style="min-height:80px" placeholder="Key levels to watch, liquidity pools, expected price delivery, news events, your edge today…"></textarea>
      </div>
    </div>
    <div class="msection">
      <div class="msection-title">Post-Session Review</div>
      <div class="fg full" style="margin-bottom:10px">
        <textarea id="j-post" style="min-height:80px" placeholder="What happened vs your plan? Did price deliver as expected? What did you learn?"></textarea>
      </div>
    </div>
    <div class="msection">
      <div class="msection-title">Mental & Physical State</div>
      <div class="fgrid">
        <div class="fg"><label>Hours Slept</label><input type="number" id="j-sleep" min="0" max="12" step=".5" placeholder="7.5"></div>
        <div class="fg"><label>Energy Level (1–10)</label><input type="number" id="j-energy" min="1" max="10" placeholder="8"></div>
        <div class="fg"><label>Coffee before 9:30am?</label>
          <select id="j-coffee"><option value="">—</option><option value="yes">Yes ☕</option><option value="no">No</option></select>
        </div>
        <div class="fg"><label>Confidence Level (1–10)</label><input type="number" id="j-confidence" min="1" max="10" placeholder="7"></div>
        <div class="fg full"><label>Mental / Emotional Notes</label>
          <textarea id="j-mental" placeholder="How are you feeling? Any life stress? Distractions? Mental clarity?"></textarea>
        </div>
      </div>
    </div>
    <div class="msection">
      <div class="msection-title">Improvement Focus</div>
      <div class="fg full">
        <textarea id="j-improve" placeholder="One specific thing to work on tomorrow…"></textarea>
      </div>
    </div>
    <div class="msection">
      <div class="msection-title">Charts</div>
      <div class="fgrid">
        <div class="fg"><label>TradingView Chart Link</label><input type="url" id="j-chart-url" placeholder="https://..."></div>
        <div class="fg"><label>Screenshot</label><input type="file" id="j-img" accept="image/*" onchange="previewJImg(event)"></div>
        <div class="fg full" id="j-img-preview-wrap" style="display:none">
          <a id="j-img-preview-link" href="#" target="_blank" title="Click to open full size" style="display:block;position:relative">
            <img id="j-img-preview" style="max-width:100%;max-height:180px;border-radius:7px;border:1px solid var(--b2);cursor:pointer;display:block">
            <span style="position:absolute;top:6px;right:6px;background:rgba(0,0,0,.6);color:var(--accent);font-family:var(--mono);font-size:.58rem;padding:2px 7px;border-radius:4px;pointer-events:none">↗ open</span>
          </a>
        </div>
      </div>
    </div>
    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeModal('journal-overlay')">Cancel</button>
      <button class="btn btn-accent" onclick="saveJournal()">Save Entry</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════ -->
<!-- PRE-SESSION POPUP -->
<!-- ═══════════════════════════════════════════════ -->
<div class="session-overlay" id="pre-sesh-overlay">
  <div class="session-modal">
    <div class="sesh-title" id="sesh-greeting">Good Morning 👋</div>
    <div class="sesh-sub" id="sesh-time-label">PRE-SESSION CHECK-IN</div>

    <div class="msection">
      <div class="msection-title">Physical State</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <div class="fg">
          <label>Hours slept last night</label>
          <div class="slider-row">
            <input type="range" id="ps-sleep" min="0" max="12" step=".5" value="7" oninput="document.getElementById('ps-sleep-val').textContent=this.value">
            <span class="slider-val" id="ps-sleep-val">7</span>
          </div>
        </div>
        <div class="fg">
          <label>Energy level right now (1–10)</label>
          <div class="slider-row">
            <input type="range" id="ps-energy" min="1" max="10" value="7" oninput="document.getElementById('ps-energy-val').textContent=this.value">
            <span class="slider-val" id="ps-energy-val">7</span>
          </div>
        </div>
        <div class="fg">
          <label>Confidence level (1–10)</label>
          <div class="slider-row">
            <input type="range" id="ps-conf" min="1" max="10" value="7" oninput="document.getElementById('ps-conf-val').textContent=this.value">
            <span class="slider-val" id="ps-conf-val">7</span>
          </div>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">☕ Coffee before 9:30am?</span>
          <button class="toggle" id="ps-coffee" onclick="this.classList.toggle('on')"></button>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">📰 Checked economic calendar?</span>
          <button class="toggle" id="ps-cal" onclick="this.classList.toggle('on')"></button>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">📊 Reviewed HTF bias (Daily/4H)?</span>
          <button class="toggle" id="ps-htf" onclick="this.classList.toggle('on')"></button>
        </div>
      </div>
    </div>

    <div class="msection">
      <div class="msection-title">Today's Plan</div>
      <div class="sesh-fgrid">
        <div class="fg">
          <label>HTF Bias</label>
          <select id="ps-bias"><option value="">—</option><option>Bullish</option><option>Bearish</option><option>Neutral</option></select>
        </div>
        <div class="fg">
          <label>Primary Instrument</label>
          <select id="ps-sym"><option>MNQ</option><option>MES</option><option>NQ</option><option>ES</option></select>
        </div>
      </div>
      <div class="fg" style="margin-top:10px">
        <label>Pre-Market Notes / Key Levels</label>
        <textarea id="ps-notes" placeholder="Key liquidity levels, FVGs, OBs to watch, expected Judas swing direction…" style="min-height:70px"></textarea>
      </div>
    </div>

    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeSession()">Skip</button>
      <button class="btn btn-accent" onclick="savePreSession()">Start Trading ✓</button>
    </div>
  </div>
</div>

<!-- POST-TRADE POPUP -->
<div class="session-overlay" id="post-trade-overlay">
  <div class="session-modal">
    <div class="sesh-title">Trade Closed 📊</div>
    <div class="sesh-sub">POST-TRADE DEBRIEF</div>

    <div class="msection">
      <div class="msection-title">Quick Entry</div>
      <div class="sesh-fgrid">
        <div class="fg"><label>Symbol</label>
          <select id="pt-sym"><option>MNQ</option><option>MES</option><option>NQ</option><option>ES</option></select>
        </div>
        <div class="fg"><label>Result</label>
          <select id="pt-result"><option value="win">Win ✅</option><option value="loss">Loss ❌</option><option value="be">Breakeven ➖</option></select>
        </div>
        <div class="fg"><label>Net P&L ($)</label><input type="number" id="pt-pnl" step="0.01"></div>
        <div class="fg"><label>Setup Used</label>
          <select id="pt-setup">
            <option value="">— Select —</option>
            <option>FVG</option><option>Order Block</option><option>Breaker Block</option>
            <option>Liquidity Sweep</option><option>OTE</option><option>Turtle Soup</option>
            <option>Judas Swing</option><option>MSS</option><option>Silver Bullet</option>
            <option>1st Presented FVG</option><option>ORG</option>
          </select>
        </div>
      </div>
    </div>

    <div class="msection">
      <div class="msection-title">ICT Checklist — This Trade</div>
      <div class="ckl" id="pt-checklist"></div>
    </div>

    <div class="msection">
      <div class="msection-title">Psychology</div>
      <div class="emo-grid" id="pt-emo">
        <div class="emo" onclick="toggleEmo(this)">😌 Calm</div>
        <div class="emo" onclick="toggleEmo(this)">🎯 Focused</div>
        <div class="emo" onclick="toggleEmo(this)">💪 Disciplined</div>
        <div class="emo" onclick="toggleEmo(this)">😤 Frustrated</div>
        <div class="emo" onclick="toggleEmo(this)">😰 Anxious</div>
        <div class="emo" onclick="toggleEmo(this)">🤑 FOMO</div>
        <div class="emo" onclick="toggleEmo(this)">😡 Revenge</div>
      </div>
      <div class="fg" style="margin-top:10px">
        <label>Mistakes (if any)</label>
        <div class="mistake-grid" id="pt-mistakes">
          <div class="mk" onclick="toggleMk(this)">Revenge Trade</div>
          <div class="mk" onclick="toggleMk(this)">Moved SL</div>
          <div class="mk" onclick="toggleMk(this)">Early Exit</div>
          <div class="mk" onclick="toggleMk(this)">Off-Plan</div>
          <div class="mk" onclick="toggleMk(this)">Chased</div>
        </div>
      </div>
    </div>

    <div class="msection">
      <div class="msection-title">Quick Note</div>
      <textarea id="pt-notes" placeholder="What happened? Did price respect the level? Any lesson?" style="min-height:55px"></textarea>
      <div class="fg" style="margin-top:8px">
        <label>Chart Link (optional)</label>
        <input type="url" id="pt-chart" placeholder="https://www.tradingview.com/x/...">
      </div>
    </div>

    <div class="mfooter">
      <button class="btn btn-ghost" onclick="closeSession('post-trade-overlay')">Skip</button>
      <button class="btn btn-accent" onclick="savePostTrade()">Log Trade ✓</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ══════════════════════════════════════════════════════════
// STATE
// ══════════════════════════════════════════════════════════
const SK = 'tradeedge_ict_v2';
let S = {
  trades: [],
  journal: [],
  ampFees: null,
  ampStatements: [],
  importLog: [],
  feeRates: { MNQ:0.90, MES:0.90, NQ:2.25, ES:2.25 },
  pendingImport: [],
  pendingCancelled: [],
  editIdx: null,
  curTags: [],
  curRating: 0,
  tradeFilter: 'all',
  accountName: '',
  startingBalance: 0,
};

function load(){
  try{
    const d=localStorage.getItem(SK);
    if(d){
      const p=JSON.parse(d);
      // Merge with defaults, ensuring arrays exist
      S={...S,...p};
      if(!Array.isArray(S.trades))S.trades=[];
      if(!Array.isArray(S.journal))S.journal=[];
      if(!Array.isArray(S.ampStatements))S.ampStatements=[];
      if(!Array.isArray(S.importLog))S.importLog=[];
      if(!S.feeRates)S.feeRates={MNQ:0.90,MES:0.90,NQ:2.25,ES:2.25};
      // Migration: clear AMP statements parsed from raw binary (they have no valid balance)
      if(S.ampStatements&&S.ampStatements.length&&!S._ampMigrated){
        var hasBadData=S.ampStatements.every(function(s){return !s.balance&&!s.netLiq;});
        if(hasBadData){
          console.log('[TradeEdge] Clearing '+S.ampStatements.length+' AMP statements parsed from raw PDF binary — please re-import');
          S.ampStatements=[];S.accountName='';S.startingBalance=0;S._ampMigrated=true;
        }
      }
      // Migration v2: if startingBalance doesn't match any known NLV, reset it so AMP re-import fixes it
      if(S._ampMigrated&&!S._ampMigV2&&S.startingBalance&&S.ampStatements&&!S.ampStatements.length){
        console.log('[TradeEdge] Resetting stale startingBalance: $'+S.startingBalance+' — re-import AMP PDF');
        S.startingBalance=0;S._ampMigV2=true;
      }
      // Try to recover accountName from existing statements if not set
      if(!S.accountName&&S.ampStatements&&S.ampStatements.length){
        for(var si=S.ampStatements.length-1;si>=0;si--){if(S.ampStatements[si].accountName){S.accountName=S.ampStatements[si].accountName;break;}}
      }
      console.log('[TradeEdge] Loaded state: trades='+S.trades.length+', journal='+S.journal.length+', statements='+S.ampStatements.length+', name='+S.accountName);
      // Remove stale PDF synthetic trades when CSV already covers same date+symbol
      if(S.trades&&S.trades.length){
        var before=S.trades.length;
        S.trades=S.trades.filter(function(t){
          var isPDFTrade=!t.source||t.source.includes('AMP Statement');
          if(!isPDFTrade)return true;
          var csvCovers=S.trades.some(function(et){
            return et!==t&&et.date===t.date&&et.symbol===t.symbol&&
                   et.source&&!et.source.includes('AMP Statement');
          });
          return !csvCovers;
        });
        if(S.trades.length<before)console.log('[TradeEdge] Removed '+(before-S.trades.length)+' duplicate PDF trade(s)');
      }
      // Always recompute starting balance on load — fixes stale values saved before this fix
      _recomputeStartingBalance();
    }
  }catch(e){console.error('[TradeEdge] Load error:',e);}
}
function save(){
  try{localStorage.setItem(SK,JSON.stringify({trades:S.trades,journal:S.journal,ampFees:S.ampFees,ampStatements:S.ampStatements||[],importLog:S.importLog||[],feeRates:S.feeRates,accountName:S.accountName||'',startingBalance:S.startingBalance||0,_welcomed:S._welcomed||false,_ampMigrated:true,_ampMigV2:true}))}catch(e){console.error('[TradeEdge] Save failed:',e);try{toast('Save failed — storage may be full','err')}catch(_){}}
}
load();

// ══════════════════════════════════════════════════════════
// NAV
// ══════════════════════════════════════════════════════════
const pageTitles={dashboard:'Dashboard',trades:'Trade Log',journal:'Journal',analytics:'Performance Analytics',ict:'ICT Analytics',weekly:'Weekly Report',import:'Import Data',settings:'Settings',help:'Help & Tutorial'};
function go(v){
  document.querySelectorAll('.view').forEach(el=>el.classList.remove('active'));
  document.getElementById('view-'+v).classList.add('active');
  document.querySelectorAll('.ni').forEach(el=>el.classList.toggle('active',el.dataset.view===v));
  document.getElementById('page-title').textContent=pageTitles[v]||v;
  if(v==='dashboard'){renderDash();_lastChipBalance=-1;_chipInitRetries=0;if(typeof _3d!=='undefined'){if(!_3d.inited){try{init3DChips();}catch(e){console.error('[TradeEdge] go(dashboard) init3DChips error:',e);}}if(_3d.chipGroup){while(_3d.chipGroup.children.length>0)_3d.chipGroup.remove(_3d.chipGroup.children[0]);_3d.allChips=[];_3d.stacks=[];_3d._fidgets=[];}}updateSidebar();return;} // Force chip slam from above every time
    if(v==='settings'){var ni=document.getElementById('set-name');if(ni)ni.value=S.accountName||'';var bi=document.getElementById('set-balance');if(bi)bi.value=S.startingBalance||'';}
  if(v==='trades')renderTrades();
  if(v==='journal')renderJournal();
  if(v==='analytics')renderAnalytics();
  if(v==='ict')renderICT();
  if(v==='weekly')renderWeekly();
  if(v==='import')updateImportStatus();
  if(v==='settings')renderSettings();
  if(v==='import'){if(typeof renderImportLog==='function')renderImportLog();if(typeof renderAMPStatements==='function')renderAMPStatements();}
  if(v==='help'){renderHelp();}
  updateSidebar();
}

// ══════════════════════════════════════════════════════════
// METRICS CALCULATION
// ══════════════════════════════════════════════════════════
function calcMetrics(trades){
  if(!trades.length)return{};
  // Get the net P&L for each trade: prefer netPnl, else compute pnl - fees
  function np(t){
    if(t.netPnl!=null && t.netPnl!==0) return t.netPnl;
    return (t.pnl||0) - (t.fees||0);
  }
  const pnls=trades.map(np);
  const wins=trades.filter(t=>np(t)>0);
  const losses=trades.filter(t=>np(t)<0);
  const net=pnls.reduce((a,b)=>a+b,0);
  const gross=trades.reduce((a,t)=>a+(t.pnl||0),0);
  const fees=trades.reduce((a,t)=>a+(t.fees||0),0);
  const winRate=wins.length/trades.length;
  const avgWin=wins.length?wins.reduce((a,t)=>a+np(t),0)/wins.length:0;
  const avgLoss=losses.length?Math.abs(losses.reduce((a,t)=>a+np(t),0)/losses.length):0;
  const grossWins=wins.reduce((a,t)=>a+np(t),0);
  const grossLoss=Math.abs(losses.reduce((a,t)=>a+np(t),0));
  const pf=grossLoss?grossWins/grossLoss:Infinity;
  const exp=(winRate*avgWin)-((1-winRate)*avgLoss);
  let eq=0,peak=0,maxDD=0;
  for(const t of trades){eq+=np(t);if(eq>peak)peak=eq;const dd=peak-eq;if(dd>maxDD)maxDD=dd;}
  let cW=0,cL=0,mW=0,mL=0;
  for(const t of trades){
    if(np(t)>0){cW++;cL=0}else{cL++;cW=0}
    mW=Math.max(mW,cW);mL=Math.max(mL,cL);
  }
  const rrVals=trades.filter(t=>t.rr).map(t=>t.rr);
  const avgRR=rrVals.length?rrVals.reduce((a,b)=>a+b,0)/rrVals.length:0;
  // SL/TP metrics
  const withSL=trades.filter(t=>t.slDollar);
  const withTP=trades.filter(t=>t.tpDollar);
  const avgRisk=withSL.length?withSL.reduce((a,t)=>a+Math.abs(t.slDollar),0)/withSL.length:0;
  const avgTarget=withTP.length?withTP.reduce((a,t)=>a+Math.abs(t.tpDollar),0)/withTP.length:0;
  const slHits=trades.filter(t=>t.exitReason==='SL Hit').length;
  const tpHits=trades.filter(t=>t.exitReason==='TP Hit').length;
  const manualExits=trades.filter(t=>t.exitReason==='Manual Exit').length;
  const actualRVals=trades.filter(t=>t.actualR!=null).map(t=>t.actualR);
  const avgActualR=actualRVals.length?actualRVals.reduce((a,b)=>a+b,0)/actualRVals.length:0;
  // TopStep-inspired metrics
  const bestTrade=trades.length?Math.max(...pnls):0;
  const worstTrade=trades.length?Math.min(...pnls):0;
  const totalContracts=trades.reduce((s,t)=>s+(t.qty||1),0);
  const longs=trades.filter(t=>t.side==='Long'||t.side==='Buy').length;
  const shorts=trades.filter(t=>t.side==='Short'||t.side==='Sell').length;
  const longPct=trades.length?longs/trades.length:0;
  // Equity high/low
  let eqHigh=0,eqLow=0,eqCur=0;
  const sorted=[...trades].sort((a,b)=>new Date(a.date+' '+(a.time||'00:00'))-new Date(b.date+' '+(b.time||'00:00')));
  sorted.forEach(t=>{eqCur+=np(t);if(eqCur>eqHigh)eqHigh=eqCur;if(eqCur<eqLow)eqLow=eqCur;});
  // Best day % of total profit
  const dayPnl={};trades.forEach(t=>{if(!t.date)return;const d=t.date;if(!dayPnl[d])dayPnl[d]=0;dayPnl[d]+=np(t);});
  const dayVals=Object.values(dayPnl);
  const bestDayPnl=dayVals.length?Math.max(...dayVals):0;
  const bestDayPct=(grossWins>0&&bestDayPnl>0)?bestDayPnl/grossWins:0;
  return{gross,fees,net,winRate,avgWin,avgLoss,pf,exp,maxDD,mW,mL,
    total:trades.length,wins:wins.length,losses:losses.length,avgRR,
    avgRisk,avgTarget,slHits,tpHits,manualExits,avgActualR,
    withSL:withSL.length,withTP:withTP.length,
    bestTrade,worstTrade,totalContracts,longPct,longs,shorts,
    eqHigh,eqLow,bestDayPnl,bestDayPct};
}

// ══════════════════════════════════════════════════════════
// FORMAT
// ══════════════════════════════════════════════════════════
function f$(n,show=true){
  if(n==null||isNaN(n))return'—';
  const s=Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  const sign=n<0?'-':show?'+':'';
  return sign+'$'+s;
}
function fpct(n){return n==null?'—':(n*100).toFixed(1)+'%'}
function fnum(n,d=2){return n==null||isNaN(n)?'—':n.toFixed(d)}

// ══════════════════════════════════════════════════════════
// DASHBOARD
// ══════════════════════════════════════════════════════════
function renderDash(){
  try{
  const m=calcMetrics(S.trades);
  console.log('[TradeEdge] renderDash called. Trades:', S.trades.length, 'Metrics:', JSON.stringify(m));
  
  // Debug banner if trades exist but metrics empty
  const debugEl=document.getElementById('dash-debug');
  if(debugEl){
    if(S.trades.length){
      var balStr=S.startingBalance?(' · Start: '+f$(S.startingBalance,false)+' + P&L: '+f$(m.net,true)+' = '+f$(S.startingBalance+(m.net||0),false)):'';
      debugEl.innerHTML=`<span style="color:var(--accent)">${S.trades.length} trades</span> · Gross: ${f$(m.gross)} · Net: <b>${f$(m.net)}</b>${balStr}`;
      debugEl.style.display='block';
    } else {
      debugEl.innerHTML='<span style="color:var(--t3)">No trades — import data to see metrics</span>';
      debugEl.style.display='block';
    }
  }
  
  const cards=[
    {l:'Gross P&L',v:f$(m.gross),c:(m.gross||0)>=0?'up':'dn',line:(m.gross||0)>=0?'var(--green)':'var(--red)',glow:'rgba(0,229,160,.05)'},
    {l:'Net P&L',v:f$(m.net),c:(m.net||0)>=0?'up':'dn',line:(m.net||0)>=0?'var(--green)':'var(--red)',glow:'rgba(0,229,160,.05)'},
    {l:'Win Rate',v:fpct(m.winRate),c:'nu',line:'var(--accent)',glow:'rgba(0,240,192,.05)'},
    {l:'Profit Factor',v:isFinite(m.pf)?fnum(m.pf):(m.pf===Infinity?'∞':'—'),c:(m.pf||0)>=1?'up':'dn',line:'var(--accent2)'},
    {l:'Expectancy',v:f$(m.exp),c:(m.exp||0)>=0?'up':'dn',line:'var(--gold)'},
    {l:'Avg Winner',v:f$(m.avgWin),c:'up',line:'var(--green)'},
    {l:'Avg Loser',v:f$(-(m.avgLoss||0)),c:'dn',line:'var(--red)'},
    {l:'Avg R:R',v:fnum(m.avgRR),c:'nu',line:'var(--purple)'},
    {l:'Total Trades',v:m.total||0,c:'nu',line:'var(--accent)'},
    {l:'Max Drawdown',v:f$(-(m.maxDD||0)),c:'dn',line:'var(--red)'},
    {l:'Total Fees',v:f$(-(m.fees||0)),c:'dn',line:'var(--gold)'},
    {l:'Best Streak',v:m.mW||0,c:'up',line:'var(--green)'},
    {l:'Avg $ Risk (SL)',v:m.avgRisk?f$(-m.avgRisk):'—',c:'dn',line:'var(--red)'},
    {l:'Avg $ Target (TP)',v:m.avgTarget?f$(m.avgTarget):'—',c:'up',line:'var(--green)'},
    {l:'Avg Actual R',v:m.avgActualR?fnum(m.avgActualR)+'R':'—',c:m.avgActualR>=0?'up':'dn',line:'var(--purple)'},
    {l:'SL Hits',v:m.slHits||0,c:'dn',line:'var(--red)'},
    {l:'TP Hits',v:m.tpHits||0,c:'up',line:'var(--green)'},
    {l:'Manual Exits',v:m.manualExits||0,c:'nu',line:'var(--gold)'},
    {l:'Best Trade',v:f$(m.bestTrade),c:'up',line:'var(--green)'},
    {l:'Worst Trade',v:f$(m.worstTrade),c:'dn',line:'var(--red)'},
    {l:'Total Contracts',v:m.totalContracts||0,c:'nu',line:'var(--accent2)'},
    {l:'Long / Short',v:m.longs+'L / '+m.shorts+'S',c:'nu',line:'var(--purple)'},
    {l:'P&L High',v:f$(m.eqHigh),c:'up',line:'var(--green)'},
    {l:'P&L Low',v:f$(m.eqLow),c:'dn',line:'var(--red)'},
    {l:'Best Day',v:f$(m.bestDayPnl),c:'up',line:'var(--green)'},
    {l:'Best Day % of Wins',v:fpct(m.bestDayPct),c:'nu',line:'var(--gold)'},
  ];
  document.getElementById('mgrid').innerHTML=cards.map(c=>`
    <div class="mc" style="--mc-line:${c.line||'var(--accent)'};--mc-glow:${c.glow||'rgba(0,240,192,.05)'}">
      <div class="mc-label">${c.l}</div>
      <div class="mc-val ${c.c}">${c.v}</div>
    </div>`).join('');
  drawEquity();drawDonut();drawDOW();drawKZChart();renderCalendar();
  }catch(err){
    console.error('[TradeEdge] Dashboard render error:',err);
    document.getElementById('mgrid').innerHTML=`<div style="color:var(--red);padding:20px;font-family:var(--mono);font-size:.8rem">Dashboard error: ${escapeHtml(err.message)}<br>Trades in memory: ${S.trades.length}</div>`;
  }
}

function updateSidebar(){
  const m=calcMetrics(S.trades);
  const el=document.getElementById('sb-bal');
  // Update account name everywhere
  const name=S.accountName||'Trader';
  const nameEl=document.getElementById('acct-name');if(nameEl)nameEl.textContent=name;
  const bbName=document.getElementById('bb-name');if(bbName)bbName.textContent=name;
  const greet=document.getElementById('sesh-greeting');
  if(greet){const h=new Date().getHours();const tod=h<12?'Good Morning':h<17?'Good Afternoon':'Good Evening';greet.textContent=tod+', '+(S.accountName?S.accountName.split(' ')[0]:'Trader')+' 👋';}
  // Update balance bar
  const bbBal=document.getElementById('bb-balance');
  const bbPnl=document.getElementById('bb-pnl');
  // Always prefer startingBalance + net P&L (includes all trades, not just those in AMP statements)
  var currentBal=S.startingBalance?(S.startingBalance+(m.net||0)):0;
  if(!currentBal&&S.ampStatements&&S.ampStatements.length){
    currentBal=S.ampStatements[S.ampStatements.length-1].balance||0;
  }
  console.log('[TradeEdge] Balance breakdown: startingBal=$'+S.startingBalance+', tradeCount='+S.trades.length+', netPnl=$'+(m.net||0).toFixed(2)+', currentBal=$'+currentBal.toFixed(2));
  // Sidebar balance
  el.textContent=f$(currentBal,false);
  el.style.color=currentBal>=0?'var(--green)':'var(--red)';
  // Dashboard balance bar
  if(bbBal){bbBal.textContent=f$(currentBal,false);bbBal.style.color=currentBal>=0?'var(--green)':'var(--red)';}
  if(bbPnl){bbPnl.textContent=f$(m.net||0,false);bbPnl.style.color=(!m.net||m.net>=0)?'var(--green)':'var(--red)';}
  // Balance breakdown (starting + P&L)
  var bbBreak=document.getElementById('bb-breakdown');
  if(bbBreak&&S.startingBalance){
    bbBreak.textContent='start '+f$(S.startingBalance,false)+' + p&l '+f$(m.net||0,true);
  }else if(bbBreak){bbBreak.textContent='';}
  // Trade count next to P&L label
  var bbTC=document.getElementById('bb-trade-count');
  if(bbTC){bbTC.textContent=S.trades.length?'('+S.trades.length+' trades)':'';}
  // Poker chips
  renderChips(currentBal);
  // Self-destruct check
  if(S.trades.length>0&&S.startingBalance>0&&currentBal<=0&&!_nukeTriggered){triggerSelfDestruct();}
  const tb=document.getElementById('trade-count-badge');
  if(S.trades.length){tb.style.display='';tb.textContent=S.trades.length}else{tb.style.display='none'}
}

// ══════════════════════════════════════════════════════════
// EQUITY CURVE
// ══════════════════════════════════════════════════════════
function drawEquity(){
  const svg=document.getElementById('eq-svg');
  svg.innerHTML='';
  const trades=[...S.trades].sort((a,b)=>new Date(a.date+' '+(a.time||'00:00'))-new Date(b.date+' '+(b.time||'00:00')));
  if(!trades.length){
    const t=document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x','50%');t.setAttribute('y','50%');t.setAttribute('fill','#3d4f6e');
    t.setAttribute('text-anchor','middle');t.setAttribute('font-size','12');t.setAttribute('font-family','IBM Plex Mono');
    t.textContent='Import trades to see equity curve';svg.appendChild(t);return;
  }
  let cum=0;
  const pts=[{x:0,y:0}];
  trades.forEach(t=>{const np=t.netPnl!=null&&t.netPnl!==0?t.netPnl:(t.pnl||0)-(t.fees||0);cum+=np;pts.push({x:pts.length,y:cum})});
  const W=600,H=160,P=20;
  const ys=pts.map(p=>p.y);
  const minY=Math.min(...ys),maxY=Math.max(...ys);
  const rng=maxY-minY||1;
  const maxX=pts.length-1||1;
  const px=x=>P+(x/maxX)*(W-2*P);
  const py=y=>P+(1-(y-minY)/rng)*(H-2*P);
  svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
  // Grid lines
  for(let i=0;i<=4;i++){
    const gl=document.createElementNS('http://www.w3.org/2000/svg','line');
    const y=P+i*(H-2*P)/4;
    gl.setAttribute('x1',P);gl.setAttribute('x2',W-P);gl.setAttribute('y1',y);gl.setAttribute('y2',y);
    gl.setAttribute('stroke','#1a2035');gl.setAttribute('stroke-width','1');svg.appendChild(gl);
  }
  // Zero line
  const z=py(0);
  if(z>P&&z<H-P){
    const zl=document.createElementNS('http://www.w3.org/2000/svg','line');
    zl.setAttribute('x1',P);zl.setAttribute('x2',W-P);zl.setAttribute('y1',z);zl.setAttribute('y2',z);
    zl.setAttribute('stroke','#2d3f5e');zl.setAttribute('stroke-dasharray','4,4');zl.setAttribute('stroke-width','1');
    svg.appendChild(zl);
  }
  const isUp=cum>=0;
  const color=isUp?'#00e5a0':'#ff3d5a';
  const fillColor=isUp?'rgba(0,229,160,0.06)':'rgba(255,61,90,0.06)';
  // Area
  const poly=document.createElementNS('http://www.w3.org/2000/svg','polygon');
  const apts=pts.map(p=>`${px(p.x)},${py(p.y)}`).join(' ');
  poly.setAttribute('points',apts+` ${px(maxX)},${H-P} ${px(0)},${H-P}`);
  poly.setAttribute('fill',fillColor);svg.appendChild(poly);
  // Line
  const line=document.createElementNS('http://www.w3.org/2000/svg','polyline');
  line.setAttribute('points',pts.map(p=>`${px(p.x)},${py(p.y)}`).join(' '));
  line.setAttribute('fill','none');line.setAttribute('stroke',color);line.setAttribute('stroke-width','2');
  svg.appendChild(line);
  // End dot
  const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
  dot.setAttribute('cx',px(maxX));dot.setAttribute('cy',py(cum));dot.setAttribute('r','4');
  dot.setAttribute('fill',color);dot.setAttribute('filter',`drop-shadow(0 0 4px ${color})`);
  svg.appendChild(dot);
  document.getElementById('eq-total').textContent=f$(cum);
}

// ══════════════════════════════════════════════════════════
// DONUT CHART
// ══════════════════════════════════════════════════════════
function drawDonut(){
  const c=document.getElementById('donut-c');
  const ctx=c.getContext('2d');
  ctx.clearRect(0,0,170,170);
  const wins=S.trades.filter(t=>(t.netPnl||t.pnl||0)>0).length;
  const losses=S.trades.filter(t=>(t.netPnl||t.pnl||0)<0).length;
  const total=wins+losses;
  const cx=85,cy=85,r=65,ir=42;
  if(!total){
    ctx.fillStyle='#3d4f6e';ctx.font='11px IBM Plex Mono';ctx.textAlign='center';ctx.fillText('No data',cx,cy+4);return;
  }
  const wa=(wins/total)*Math.PI*2;
  ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,-Math.PI/2,-Math.PI/2+wa);ctx.fillStyle='#00e5a0';ctx.fill();
  ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,-Math.PI/2+wa,-Math.PI/2+Math.PI*2);ctx.fillStyle='#ff3d5a';ctx.fill();
  ctx.beginPath();ctx.arc(cx,cy,ir,0,Math.PI*2);ctx.fillStyle='#0c0f17';ctx.fill();
  ctx.fillStyle='#e8edf8';ctx.font='bold 16px IBM Plex Mono';ctx.textAlign='center';ctx.fillText(fpct(wins/total),cx,cy+4);
  ctx.fillStyle='#3d4f6e';ctx.font='9px IBM Plex Mono';ctx.fillText('WIN RATE',cx,cy+18);
  ctx.fillStyle='#00e5a0';ctx.fillRect(14,155,8,8);ctx.fillStyle='#7b8db0';ctx.font='10px Manrope';ctx.textAlign='left';ctx.fillText(`${wins} Wins`,26,163);
  ctx.fillStyle='#ff3d5a';ctx.fillRect(90,155,8,8);ctx.fillStyle='#7b8db0';ctx.fillText(`${losses} Losses`,102,163);
}

// ══════════════════════════════════════════════════════════
// DOW CHART
// ══════════════════════════════════════════════════════════
function drawDOW(){
  const c=document.getElementById('dow-c');
  c.width=c.parentElement.clientWidth||400;
  const ctx=c.getContext('2d');
  const W=c.width,H=120;
  ctx.clearRect(0,0,W,H);
  const days=['Mon','Tue','Wed','Thu','Fri'];
  const byDay=[0,0,0,0,0];
  S.trades.forEach(t=>{
    const d=new Date((t.date||'2000-01-01')+'T12:00:00').getDay();
    const idx=[1,2,3,4,5].indexOf(d);
    if(idx>=0)byDay[idx]+=(t.netPnl||t.pnl||0);
  });
  const max=Math.max(...byDay.map(Math.abs))||1;
  const bw=(W-40)/5,pad=6,barH=H-30;
  days.forEach((d,i)=>{
    const x=20+i*bw+pad/2,bwi=bw-pad,v=byDay[i];
    const h=Math.abs(v/max)*barH*.75;
    const y=v>=0?H-20-h:H-20;
    ctx.fillStyle=v>=0?'rgba(0,229,160,0.7)':'rgba(255,61,90,0.7)';
    if(h>0)ctx.fillRect(x,y,bwi,h);
    ctx.fillStyle='#3d4f6e';ctx.font='9px IBM Plex Mono';ctx.textAlign='center';
    ctx.fillText(d,x+bwi/2,H-5);
    if(Math.abs(v)>0){
      ctx.fillStyle=v>=0?'#00e5a0':'#ff3d5a';
      ctx.font='8px IBM Plex Mono';
      ctx.fillText((v>=0?'+':'')+v.toFixed(0),x+bwi/2,v>=0?y-3:y+h+10);
    }
  });
}

// ══════════════════════════════════════════════════════════
// KILLZONE CHART
// ══════════════════════════════════════════════════════════
function drawKZChart(){
  const kzMap={};
  S.trades.forEach(t=>{
    const kz=t.killzone||'Unknown';
    if(!kzMap[kz])kzMap[kz]={pnl:0,cnt:0,wins:0};
    kzMap[kz].pnl+=(t.netPnl||t.pnl||0);
    kzMap[kz].cnt++;
    if((t.netPnl||t.pnl||0)>0)kzMap[kz].wins++;
  });
  const el=document.getElementById('kz-chart');
  if(!Object.keys(kzMap).length){el.innerHTML='<p style="font-size:.72rem;color:var(--t3);padding:10px 0">No killzone data yet.</p>';return;}
  const maxPnl=Math.max(...Object.values(kzMap).map(v=>Math.abs(v.pnl)))||1;
  el.innerHTML=Object.entries(kzMap).sort((a,b)=>b[1].pnl-a[1].pnl).map(([kz,v])=>`
    <div class="kz-row">
      <span class="kz-name">${kz.split(' ')[0]}</span>
      <div class="kz-bar"><div class="kz-fill" style="width:${Math.abs(v.pnl/maxPnl)*100}%;background:${v.pnl>=0?'linear-gradient(90deg,var(--green),var(--accent))':'linear-gradient(90deg,var(--red),#ff7090)'}"></div></div>
      <span class="kz-val" style="color:${v.pnl>=0?'var(--green)':'var(--red)'}">${f$(v.pnl)} <span style="color:var(--t3)">${v.cnt}T</span></span>
    </div>`).join('');
}

// ══════════════════════════════════════════════════════════
// TRADING CALENDAR
// ══════════════════════════════════════════════════════════
let calDate=new Date();
function calNav(dir){
  calDate.setMonth(calDate.getMonth()+dir);
  renderCalendar();
}
function renderCalendar(){
  const grid=document.getElementById('cal-grid');
  const title=document.getElementById('cal-title');
  const summary=document.getElementById('cal-summary');
  if(!grid)return;

  const year=calDate.getFullYear();
  const month=calDate.getMonth();
  const today=new Date();
  const monthNames=['January','February','March','April','May','June','July','August','September','October','November','December'];
  title.textContent=monthNames[month]+' '+year;

  // Aggregate daily P&L
  const dayMap={};
  S.trades.forEach(t=>{
    if(!t.date)return;
    const d=new Date(t.date);
    if(d.getFullYear()===year&&d.getMonth()===month){
      const day=d.getDate();
      if(!dayMap[day])dayMap[day]={pnl:0,net:0,trades:0,wins:0,losses:0};
      const np=t.netPnl!=null&&t.netPnl!==0?t.netPnl:(t.pnl||0)-(t.fees||0);
      dayMap[day].pnl+=(t.pnl||0);
      dayMap[day].net+=np;
      dayMap[day].trades++;
      if(np>0)dayMap[day].wins++;
      else if(np<0)dayMap[day].losses++;
    }
  });

  // Monthly summary
  const monthTrades=Object.values(dayMap);
  const monthNet=monthTrades.reduce((s,d)=>s+d.net,0);
  const monthGross=monthTrades.reduce((s,d)=>s+d.pnl,0);
  const tradingDays=monthTrades.length;
  const greenDays=monthTrades.filter(d=>d.net>0).length;
  const redDays=monthTrades.filter(d=>d.net<0).length;
  const totalTrades=monthTrades.reduce((s,d)=>s+d.trades,0);
  const bestDay=monthTrades.length?Math.max(...monthTrades.map(d=>d.net)):0;
  const worstDay=monthTrades.length?Math.min(...monthTrades.map(d=>d.net)):0;

  summary.innerHTML=`
    <span>Net: <strong style="color:${monthNet>=0?'var(--green)':'var(--red)'}">${f$(monthNet)}</strong></span>
    <span>Days: <strong style="color:var(--accent)">${tradingDays}</strong> <span style="color:var(--green)">(${greenDays}W</span>/<span style="color:var(--red)">${redDays}L)</span></span>
    <span>Trades: <strong>${totalTrades}</strong></span>
    <span>Best: <strong style="color:var(--green)">${f$(bestDay)}</strong></span>
    <span>Worst: <strong style="color:var(--red)">${f$(worstDay)}</strong></span>
  `;

  // Build calendar grid
  const firstDay=new Date(year,month,1).getDay();
  const daysInMonth=new Date(year,month+1,0).getDate();
  const dayNames=['SUN','MON','TUE','WED','THU','FRI','SAT'];

  let html=dayNames.map(d=>`<div class="cal-hdr">${d}</div>`).join('');

  // Empty cells before first day
  for(let i=0;i<firstDay;i++){
    html+=`<div class="cal-day empty"></div>`;
  }

  // Running balance for the month
  let runBal=0;
  for(let d=1;d<=daysInMonth;d++){
    const data=dayMap[d];
    const isToday=today.getFullYear()===year&&today.getMonth()===month&&today.getDate()===d;
    const dow=new Date(year,month,d).getDay();
    const isWeekend=dow===0||dow===6;

    if(data){
      runBal+=data.net;
      const cls=data.net>0?'win':data.net<0?'loss':'flat';
      html+=`<div class="cal-day ${cls}${isToday?' today':''}" title="${monthNames[month]} ${d}: ${data.trades} trades, Net ${f$(data.net)}">
        <div class="cal-num">${d}</div>
        <div class="cal-pnl">${f$(data.net)}</div>
        <div class="cal-trades">${data.trades}T · ${data.wins}W/${data.losses}L</div>
      </div>`;
    } else {
      html+=`<div class="cal-day ${isWeekend?'no-trade':'empty'}${isToday?' today':''}">
        <div class="cal-num" style="color:var(--t3)">${d}</div>
        ${isWeekend?'':'<div style="font-size:.55rem;color:var(--t3);margin-top:8px">—</div>'}
      </div>`;
    }
  }

  grid.innerHTML=html;
}

// ══════════════════════════════════════════════════════════
// TRADE LOG
// ══════════════════════════════════════════════════════════
let tradeFilter='all';
function setF(f,el){
  tradeFilter=f;
  document.querySelectorAll('.fchip').forEach(e=>e.classList.remove('on'));
  el.classList.add('on');renderTrades();
}
function renderTrades(){
  const q=(document.getElementById('srch')||{}).value?.toLowerCase()||'';
  let trades=[...S.trades].sort((a,b)=>new Date(b.date+' '+(b.time||'00:00'))-new Date(a.date+' '+(a.time||'00:00')));
  if(q)trades=trades.filter(t=>t.symbol?.toLowerCase().includes(q)||(t.tags||[]).some(g=>g.toLowerCase().includes(q))||t.setup?.toLowerCase().includes(q));
  if(tradeFilter==='win')trades=trades.filter(t=>(t.netPnl||t.pnl||0)>0);
  if(tradeFilter==='loss')trades=trades.filter(t=>(t.netPnl||t.pnl||0)<0);
  if(tradeFilter==='long')trades=trades.filter(t=>t.side?.toLowerCase()==='long'||t.side==='Buy');
  if(tradeFilter==='short')trades=trades.filter(t=>t.side?.toLowerCase()==='short'||t.side==='Sell');
  const tbody=document.getElementById('trade-tbody');
  const empty=document.getElementById('trade-empty');
  document.getElementById('tlog-count').textContent=`${trades.length} trades`;
  empty.style.display=trades.length?'none':'block';
  tbody.innerHTML=trades.map(t=>{
    const idx=S.trades.indexOf(t);
    const pnl=t.netPnl||t.pnl||0;
    const isLong=t.side?.toLowerCase()==='long'||t.side==='Buy';
    const rr=t.rr?fnum(t.rr)+'R':'—';
    const tags=(t.tags||[]).map(g=>{
      const isICT=['FVG','Order Block','Breaker Block','Liquidity Sweep','OTE','Turtle Soup','Judas Swing','MSS','Silver Bullet','1st Presented FVG','ORG'].includes(g);
      return `<span class="tag ${isICT?'ict-tag':''}">${escapeHtml(g)}</span>`;
    }).join('');
    return `<tr onclick="editTrade(${idx})">
      <td class="mono">${t.date||'—'}</td>
      <td class="mono" style="color:var(--t3)">${t.time||'—'}</td>
      <td class="sym">${escapeHtml(t.symbol)||'—'}</td>
      <td><span class="bdg ${isLong?'bdg-long':'bdg-short'}">${isLong?'LONG':'SHORT'}</span></td>
      <td class="mono">${t.qty||1}</td>
      <td class="mono">${t.entry||'—'}</td>
      <td class="mono">${t.exit||'—'}</td>
      <td class="mono" style="color:var(--red)">${t.slPrice||t.sl||'—'}${t.slDollar?'<br><span style="font-size:.65rem;opacity:.7">'+f$(t.slDollar)+'</span>':''}${(t.slHistory||[]).length>1?'<br><span style="font-size:.6rem;color:var(--gold)">'+t.slHistory.length+' adj</span>':''}</td>
      <td class="mono" style="color:var(--green)">${t.tpPrice||t.tp||'—'}${t.tpDollar?'<br><span style="font-size:.65rem;opacity:.7">'+f$(t.tpDollar)+'</span>':''}${(t.tpHistory||[]).length>1?'<br><span style="font-size:.6rem;color:var(--gold)">'+t.tpHistory.length+' adj</span>':''}</td>
      <td class="mono" style="color:${pnl>=0?'var(--green)':'var(--red)'}">${f$(t.pnl)}</td>
      <td class="mono" style="color:var(--t3)">${t.fees?f$(-t.fees):'—'}</td>
      <td class="mono" style="color:${pnl>=0?'var(--green)':'var(--red)'};font-weight:600">${f$(pnl)}</td>
      <td class="mono">${t.rr?fnum(t.rr)+'R':'—'}</td>
      <td class="mono" style="font-size:.68rem;color:${t.exitReason==='TP Hit'?'var(--green)':t.exitReason==='SL Hit'?'var(--red)':'var(--t3)'}">${escapeHtml(t.exitReason)||'—'}</td>
      <td>${tags||'<span style="color:var(--t3)">—</span>'}</td>
      <td><span class="tag kz-tag" style="display:${t.killzone?'inline-flex':'none'}">${escapeHtml(t.killzone)}</span></td>
      <td style="font-size:.85rem">${escapeHtml(t.emotion)||'—'}</td>
      <td style="color:var(--gold)">${'★'.repeat(t.rating||0)}</td>
      <td><span class="bdg ${pnl>=0?'bdg-win':'bdg-loss'}">${pnl>=0?'WIN':'LOSS'}</span></td>
      <td>${t.chartImg?`<a href="${escapeHtml(t.chartImg)}" target="_blank" onclick="event.stopPropagation()" title="View screenshot" style="color:var(--accent);font-size:.85rem;text-decoration:none">📷</a>`:t.chartUrl?`<a href="${escapeHtml(t.chartUrl)}" target="_blank" onclick="event.stopPropagation()" title="View chart" style="color:var(--accent2);font-size:.85rem;text-decoration:none">📊</a>`:'<span style="color:var(--t3);font-size:.75rem">—</span>'}</td>
    </tr>`;
  }).join('');
}

// ══════════════════════════════════════════════════════════
// ADD / EDIT TRADE
// ══════════════════════════════════════════════════════════
const ICT_TAGS=[
  {t:'FVG',type:'ict'},{t:'Order Block',type:'ict'},{t:'Breaker Block',type:'ict'},
  {t:'Liquidity Sweep',type:'ict'},{t:'OTE',type:'ict'},{t:'Turtle Soup',type:'ict'},
  {t:'Judas Swing',type:'ict'},{t:'MSS',type:'ict'},{t:'Silver Bullet',type:'ict'},
  {t:'1st Presented FVG',type:'ict'},{t:'ORG',type:'ict'},
  {t:'London KZ',type:'kz'},{t:'NY AM KZ',type:'kz'},{t:'NY PM KZ',type:'kz'},
  {t:'Macro Window',type:'kz'},{t:'News Event',type:'kz'},
];
const CKL_ITEMS=[
  'HTF Bias correct? (Daily/4H aligned)',
  'Did I wait for Killzone?',
  'Did I identify liquidity target first?',
  'Was there a MSS/ChoCH before entry?',
  'Did I enter on LTF confirmation?',
  'Did I take partials at 50% of range?',
  'Did I let it run to the target?',
  'Was there a news event I ignored?',
  'Did I trade during a Macro window?',
];

function openTrade(){
  S.editIdx=null;S.curTags=[];S.curRating=0;
  document.getElementById('trade-modal-title').textContent='Add Trade';
  document.getElementById('del-btn').style.display='none';
  document.getElementById('f-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('f-time').value='';
  document.getElementById('f-sym').value='MNQ';
  document.getElementById('f-side').value='Long';
  document.getElementById('f-qty').value=1;
  document.getElementById('f-kz').value='';
  document.getElementById('f-entry').value='';
  document.getElementById('f-exit').value='';
  document.getElementById('f-sl').value='';
  document.getElementById('f-tp').value='';
  document.getElementById('f-pnl').value='';
  document.getElementById('f-fees').value=feeForSymbol('MNQ');
  document.getElementById('f-bias').value='';
  document.getElementById('f-notes').value='';
  document.getElementById('f-chart-url').value='';
  document.getElementById('img-preview-wrap').style.display='none';
  document.querySelectorAll('#emo-grid .emo').forEach(e=>e.classList.remove('sel'));
  document.querySelectorAll('#mistake-grid .mk').forEach(e=>e.classList.remove('sel'));
  renderTagWrap();renderTagSuggestions();renderChecklist();renderStars();
  openModal('trade-overlay');
}
function editTrade(idx){
  const t=S.trades[idx];S.editIdx=idx;S.curTags=[...(t.tags||[])];S.curRating=t.rating||0;
  document.getElementById('trade-modal-title').textContent='Edit Trade';
  document.getElementById('del-btn').style.display='';
  document.getElementById('f-date').value=t.date||'';
  document.getElementById('f-time').value=t.time||'';
  document.getElementById('f-sym').value=t.symbol||'MNQ';
  document.getElementById('f-side').value=t.side||'Long';
  document.getElementById('f-qty').value=t.qty||1;
  document.getElementById('f-kz').value=t.killzone||'';
  document.getElementById('f-entry').value=t.entry||'';
  document.getElementById('f-exit').value=t.exit||'';
  document.getElementById('f-sl').value=t.slPrice||t.sl||'';
  document.getElementById('f-tp').value=t.tpPrice||t.tp||'';
  document.getElementById('f-pnl').value=t.pnl||'';
  document.getElementById('f-fees').value=t.fees||0;
  document.getElementById('f-bias').value=t.bias||'';
  document.getElementById('f-notes').value=t.notes||'';
  document.getElementById('f-chart-url').value=t.chartUrl||'';
  document.querySelectorAll('#emo-grid .emo').forEach(e=>{e.classList.toggle('sel',e.textContent.trim()===t.emotion)});
  document.querySelectorAll('#mistake-grid .mk').forEach(e=>{e.classList.toggle('sel',(t.mistakes||[]).includes(e.textContent.trim()))});
  if(t.chartImg){document.getElementById('img-preview').src=t.chartImg;document.getElementById('img-preview-link').href=t.chartImg;document.getElementById('img-preview-wrap').style.display='block';}
  else document.getElementById('img-preview-wrap').style.display='none';
  // Render SL/TP reconstruction info
  const sltpEl=document.getElementById('sltp-info');
  if(sltpEl){
    const hasSLTP=(t.slPrice||t.tpPrice||t.exitReason);
    if(hasSLTP){
      let html=`<div style="font-size:.72rem;font-family:var(--mono);padding:10px;background:var(--s2);border-radius:8px;margin-bottom:12px">`;
      html+=`<div style="font-weight:600;color:var(--accent);margin-bottom:6px">📊 AUTO-DETECTED FROM CANCELLED ORDERS</div>`;
      if(t.exitReason) html+=`<div style="margin-bottom:4px">Exit: <strong style="color:${t.exitReason==='TP Hit'?'var(--green)':t.exitReason==='SL Hit'?'var(--red)':'var(--gold)'}">${t.exitReason}</strong>${t.actualR!=null?' ('+fnum(t.actualR)+'R)':''}</div>`;
      if(t.slPrice) html+=`<div style="margin-bottom:4px">SL: <strong style="color:var(--red)">${t.slPrice}</strong> <span style="color:var(--t3)">(${f$(t.slDollar)} risk)</span></div>`;
      if(t.tpPrice) html+=`<div style="margin-bottom:4px">TP: <strong style="color:var(--green)">${t.tpPrice}</strong> <span style="color:var(--t3)">(${f$(t.tpDollar)} target)</span></div>`;
      if(t.rr) html+=`<div style="margin-bottom:4px">Planned R:R: <strong style="color:var(--accent)">${fnum(t.rr)}</strong></div>`;
      // Show adjustment history
      if((t.slHistory||[]).length>1){
        html+=`<div style="margin-top:6px;padding-top:6px;border-top:1px solid var(--s3)"><strong style="color:var(--gold)">SL Adjustments (${t.slHistory.length}):</strong></div>`;
        t.slHistory.forEach((h,i)=>{
          html+=`<div style="color:var(--t2);padding-left:8px">${i+1}. ${h.price} (${f$(h.dollar)}) — ${h.time||''}</div>`;
        });
      }
      if((t.tpHistory||[]).length>1){
        html+=`<div style="margin-top:6px;padding-top:6px;border-top:1px solid var(--s3)"><strong style="color:var(--gold)">TP Adjustments (${t.tpHistory.length}):</strong></div>`;
        t.tpHistory.forEach((h,i)=>{
          html+=`<div style="color:var(--t2);padding-left:8px">${i+1}. ${h.price} (${f$(h.dollar)}) — ${h.time||''}</div>`;
        });
      }
      html+=`</div>`;
      sltpEl.innerHTML=html;
      sltpEl.style.display='block';
    } else {
      sltpEl.innerHTML='';
      sltpEl.style.display='none';
    }
  }
  renderTagWrap();renderTagSuggestions();
  renderChecklist(t.checklist||{});
  renderStars();openModal('trade-overlay');
}
function saveTrade(){
  const sym=document.getElementById('f-sym').value;
  const pnl=parseFloat(document.getElementById('f-pnl').value)||0;
  const fees=parseFloat(document.getElementById('f-fees').value)||feeForSymbol(sym);
  const _pf=id=>{const v=parseFloat(document.getElementById(id).value);return isNaN(v)?null:v;};
  const entry=_pf('f-entry');
  const exit=_pf('f-exit');
  const sl=_pf('f-sl');
  const tp=_pf('f-tp');
  const side=document.getElementById('f-side').value;
  let rr=null;
  if(entry&&sl&&tp){
    const risk=Math.abs(entry-sl);const reward=Math.abs(tp-entry);
    if(risk>0)rr=reward/risk;
  }
  const checklist={};
  document.querySelectorAll('#checklist .ck-item').forEach(el=>{
    checklist[el.dataset.key]=el.classList.contains('checked');
  });
  const emotion=document.querySelector('#emo-grid .emo.sel')?.textContent.trim()||'';
  const mistakes=[...document.querySelectorAll('#mistake-grid .mk.sel')].map(e=>e.textContent.trim());
  // Preserve reconstructed SL/TP data from existing trade
  const existing=S.editIdx!=null?S.trades[S.editIdx]:{};
  const trade={
    date:document.getElementById('f-date').value,
    time:document.getElementById('f-time').value,
    symbol:sym,side,qty:parseInt(document.getElementById('f-qty').value)||1,
    killzone:document.getElementById('f-kz').value,
    entry,exit,sl,tp,
    slPrice:sl||existing.slPrice||null,
    tpPrice:tp||existing.tpPrice||null,
    slDollar:existing.slDollar||null,
    tpDollar:existing.tpDollar||null,
    slHistory:existing.slHistory||[],
    tpHistory:existing.tpHistory||[],
    entryOrderId:existing.entryOrderId||null,
    exitOrderId:existing.exitOrderId||null,
    entryPlacingTime:existing.entryPlacingTime||null,
    exitPlacingTime:existing.exitPlacingTime||null,
    entryOrderType:existing.entryOrderType||null,
    exitOrderType:existing.exitOrderType||null,
    exitReason:existing.exitReason||null,
    actualR:existing.actualR||null,
    pnl,fees,netPnl:pnl-fees,rr:rr||existing.rr||null,
    tags:[...S.curTags],checklist,
    bias:document.getElementById('f-bias').value,
    emotion,mistakes,rating:S.curRating,
    notes:document.getElementById('f-notes').value,
    chartUrl:document.getElementById('f-chart-url').value,
    chartImg:document.getElementById('img-preview').src&&document.getElementById('img-preview-wrap').style.display!=='none'?document.getElementById('img-preview').src:null,
    importedAt:existing.importedAt||new Date().toISOString(),
    source:existing.source||'Manual'
  };
  if(S.editIdx!=null)S.trades[S.editIdx]=trade;
  else S.trades.push(trade);
  save();closeModal('trade-overlay');toast('Trade saved ✓','ok');
  renderTrades();updateSidebar();
}
function deleteTrade(){
  if(!confirm('Delete this trade?'))return;
  S.trades.splice(S.editIdx,1);save();closeModal('trade-overlay');toast('Trade deleted','ok');
  renderTrades();updateSidebar();
}
function feeForSymbol(sym){
  return S.feeRates[sym]||2.25;
}
function escapeHtml(s){
  if(!s)return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// ══════════════════════════════════════════════════════════
// TAGS
// ══════════════════════════════════════════════════════════
function renderTagWrap(){
  const wrap=document.getElementById('tag-wrap');
  const inp=document.getElementById('tag-input');
  [...wrap.querySelectorAll('.tpill')].forEach(e=>e.remove());
  S.curTags.forEach((t,i)=>{
    const isICT=ICT_TAGS.some(x=>x.t===t&&x.type==='ict');
    const isKZ=ICT_TAGS.some(x=>x.t===t&&x.type==='kz');
    const pill=document.createElement('div');
    pill.className=`tpill ${isICT?'tpill-ict':isKZ?'tpill-kz':'tpill-custom'}`;
    pill.innerHTML=`${escapeHtml(t)}<span class="x" onclick="removeTag(${i})">✕</span>`;
    wrap.insertBefore(pill,inp);
  });
}
function removeTag(i){S.curTags.splice(i,1);renderTagWrap();}
function renderTagSuggestions(q=''){
  const sug=document.getElementById('tag-sug');
  const filtered=ICT_TAGS.filter(t=>!S.curTags.includes(t.t)&&(q?t.t.toLowerCase().includes(q.toLowerCase()):true));
  sug.innerHTML=filtered.map(t=>`<div class="sug ${t.type==='ict'?'tpill-ict':'tpill-kz'}" onclick="addTag('${escapeHtml(t.t)}')">${escapeHtml(t.t)}</div>`).join('');
}
function filterTags(){renderTagSuggestions(document.getElementById('tag-input').value);}
function addTag(t){
  if(!S.curTags.includes(t))S.curTags.push(t);
  document.getElementById('tag-input').value='';
  renderTagWrap();renderTagSuggestions();
}
function tagKey(e){
  if(e.key==='Enter'||e.key===','){
    const v=document.getElementById('tag-input').value.trim();
    if(v){addTag(v);}e.preventDefault();
  }
}

// ══════════════════════════════════════════════════════════
// CHECKLIST
// ══════════════════════════════════════════════════════════
function renderChecklist(state={}){
  document.getElementById('checklist').innerHTML=CKL_ITEMS.map(item=>`
    <div class="ck-item ${state[item]?'checked':''}" data-key="${item}" onclick="this.classList.toggle('checked')">
      <div class="ck-box"><svg viewBox="0 0 12 12"><polyline points="1,6 4,10 11,2"/></svg></div>
      <span class="ck-label">${item}</span>
    </div>`).join('');
  // Post-trade checklist
  const ptCkl=document.getElementById('pt-checklist');
  if(ptCkl)ptCkl.innerHTML=CKL_ITEMS.slice(0,6).map(item=>`
    <div class="ck-item" data-key="${item}" onclick="this.classList.toggle('checked')">
      <div class="ck-box"><svg viewBox="0 0 12 12"><polyline points="1,6 4,10 11,2"/></svg></div>
      <span class="ck-label">${item}</span>
    </div>`).join('');
}

// ══════════════════════════════════════════════════════════
// STARS / EMOTIONS / MISTAKES
// ══════════════════════════════════════════════════════════
function setStar(n){S.curRating=n;renderStars();}
function renderStars(){
  document.querySelectorAll('#star-row .star').forEach((s,i)=>s.classList.toggle('on',i<S.curRating));
}
function toggleEmo(el){
  el.parentElement.querySelectorAll('.emo').forEach(e=>e.classList.remove('sel'));
  el.classList.add('sel');
}
function toggleMk(el){el.classList.toggle('sel');}

// ══════════════════════════════════════════════════════════
// JOURNAL
// ══════════════════════════════════════════════════════════
function openJournal(){
  document.getElementById('j-date').value=new Date().toISOString().split('T')[0];
  ['j-bias','j-pre','j-post','j-mental','j-improve','j-chart-url'].forEach(id=>{
    const el=document.getElementById(id);if(el)el.value='';
  });
  document.getElementById('j-sleep').value='';
  document.getElementById('j-energy').value='';
  document.getElementById('j-coffee').value='';
  document.getElementById('j-confidence').value='';
  document.getElementById('j-img-preview-wrap').style.display='none';
  openModal('journal-overlay');
}
function saveJournal(){
  const entry={
    date:document.getElementById('j-date').value,
    bias:document.getElementById('j-bias').value,
    pre:document.getElementById('j-pre').value,
    post:document.getElementById('j-post').value,
    mental:document.getElementById('j-mental').value,
    improve:document.getElementById('j-improve').value,
    chartUrl:document.getElementById('j-chart-url').value,
    chartImg:document.getElementById('j-img-preview-wrap').style.display!=='none'?document.getElementById('j-img-preview').src||null:null,
    sleep:document.getElementById('j-sleep').value,
    energy:document.getElementById('j-energy').value,
    coffee:document.getElementById('j-coffee').value,
    confidence:document.getElementById('j-confidence').value,
    createdAt:new Date().toISOString(),
  };
  S.journal.push(entry);save();closeModal('journal-overlay');
  toast('Journal entry saved ✓','ok');renderJournal();
}
function renderJournal(){
  const list=document.getElementById('journal-list');
  const entries=[...S.journal].sort((a,b)=>new Date(b.date)-new Date(a.date));
  document.getElementById('journal-empty').style.display=entries.length?'none':'block';
  list.innerHTML=entries.map((e,i)=>{
    const dayTrades=S.trades.filter(t=>t.date===e.date);
    const dayPnl=dayTrades.reduce((a,t)=>a+(t.netPnl||t.pnl||0),0);
    const psychScore=calcPsychScore(e,dayTrades);
    return `<div class="jcard">
      <div class="jcard-hdr">
        <div>
          <div class="jcard-date">${new Date(e.date+'T12:00:00').toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}</div>
          <div class="jcard-meta">${dayTrades.length} trades · ${e.bias||'No bias set'} · Sleep: ${e.sleep||'?'}h · Energy: ${e.energy||'?'}/10</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="score-pill">Psych <span class="val">${psychScore}/10</span></div>
          <div class="jcard-pnl" style="color:${dayPnl>=0?'var(--green)':'var(--red)'}">${f$(dayPnl)}</div>
          <button class="btn btn-ghost btn-sm" onclick="deleteJournal(${i})" style="padding:3px 8px">✕</button>
        </div>
      </div>
      <div class="jcard-body">
        ${e.pre?`<div class="jsec"><div class="jsec-label">Pre-Market Plan</div><div class="jsec-text">${escapeHtml(e.pre)}</div></div>`:''}
        ${e.post?`<div class="jsec"><div class="jsec-label">Post-Session Review</div><div class="jsec-text">${escapeHtml(e.post)}</div></div>`:''}
        ${e.mental?`<div class="jsec"><div class="jsec-label">Mental Notes</div><div class="jsec-text">${escapeHtml(e.mental)}</div></div>`:''}
        ${e.improve?`<div class="jsec"><div class="jsec-label">Focus for Tomorrow</div><div class="jsec-text">${escapeHtml(e.improve)}</div></div>`:''}
        ${e.chartUrl||e.chartImg?`<div style="margin-top:8px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          ${e.chartUrl?`<a href="${escapeHtml(e.chartUrl)}" target="_blank" style="color:var(--accent);font-size:.75rem;font-family:var(--mono);text-decoration:none">📊 View Chart →</a>`:''}
          ${e.chartImg?`<a href="${escapeHtml(e.chartImg)}" target="_blank" style="display:inline-block;position:relative" title="Click to open screenshot"><img src="${escapeHtml(e.chartImg)}" style="max-width:180px;max-height:90px;border-radius:6px;border:1px solid var(--b2);cursor:pointer;vertical-align:middle"><span style="position:absolute;top:3px;right:3px;background:rgba(0,0,0,.6);color:var(--accent);font-family:var(--mono);font-size:.52rem;padding:1px 5px;border-radius:3px">↗</span></a>`:''}
        </div>`:''}
      </div>
    </div>`;
  }).join('');
}
function deleteJournal(i){
  if(!confirm('Delete this journal entry?'))return;
  const entries=[...S.journal].sort((a,b)=>new Date(b.date)-new Date(a.date));
  const target=entries[i];
  const realIdx=S.journal.indexOf(target);
  if(realIdx>-1)S.journal.splice(realIdx,1);
  save();renderJournal();
}
function calcPsychScore(entry,trades){
  let score=5;
  if(entry.sleep>=7)score+=1;if(entry.sleep<5)score-=1;
  if(entry.energy>=7)score+=1;if(entry.energy<4)score-=1;
  if(entry.confidence>=7)score+=1;
  const mistakes=trades.flatMap(t=>t.mistakes||[]);
  if(mistakes.includes('Revenge Trade'))score-=2;
  if(mistakes.includes('Moved SL'))score-=1;
  if(mistakes.includes('Off-Plan Entry'))score-=1;
  return Math.max(1,Math.min(10,score));
}

// ══════════════════════════════════════════════════════════
// SESSION COMPANION
// ══════════════════════════════════════════════════════════
function openPreSession(){
  const now=new Date();
  document.getElementById('sesh-time-label').textContent=`PRE-SESSION CHECK-IN · ${now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})} ET`;
  document.getElementById('ps-sleep').value=7;document.getElementById('ps-sleep-val').textContent='7';
  document.getElementById('ps-energy').value=7;document.getElementById('ps-energy-val').textContent='7';
  document.getElementById('ps-conf').value=7;document.getElementById('ps-conf-val').textContent='7';
  document.getElementById('ps-coffee').classList.remove('on');
  document.getElementById('ps-cal').classList.remove('on');
  document.getElementById('ps-htf').classList.remove('on');
  document.getElementById('ps-bias').value='';
  document.getElementById('ps-notes').value='';
  document.getElementById('pre-sesh-overlay').classList.add('open');
}
function savePreSession(){
  const entry={
    date:new Date().toISOString().split('T')[0],
    sleep:document.getElementById('ps-sleep').value,
    energy:document.getElementById('ps-energy').value,
    confidence:document.getElementById('ps-conf').value,
    coffee:document.getElementById('ps-coffee').classList.contains('on')?'yes':'no',
    checkedCal:document.getElementById('ps-cal').classList.contains('on'),
    reviewedHTF:document.getElementById('ps-htf').classList.contains('on'),
    bias:document.getElementById('ps-bias').value,
    pre:document.getElementById('ps-notes').value,
    createdAt:new Date().toISOString(),
  };
  // Merge with existing journal entry for today if exists
  const existing=S.journal.findIndex(j=>j.date===entry.date);
  if(existing>=0)S.journal[existing]={...S.journal[existing],...entry};
  else S.journal.push(entry);
  save();closeSession();toast('Session started — good luck! 🎯','ok');
}
function logTradeJournal(){
  renderChecklist();
  document.getElementById('pt-sym').value='MNQ';
  document.getElementById('pt-result').value='win';
  document.getElementById('pt-pnl').value='';
  document.getElementById('pt-setup').value='';
  document.getElementById('pt-notes').value='';
  document.getElementById('pt-chart').value='';
  document.querySelectorAll('#pt-emo .emo').forEach(e=>e.classList.remove('sel'));
  document.querySelectorAll('#pt-mistakes .mk').forEach(e=>e.classList.remove('sel'));
  document.getElementById('post-trade-overlay').classList.add('open');
}
function savePostTrade(){
  const checklist={};
  document.querySelectorAll('#pt-checklist .ck-item').forEach(el=>{
    checklist[el.dataset.key]=el.classList.contains('checked');
  });
  const emotion=document.querySelector('#pt-emo .emo.sel')?.textContent.trim()||'';
  const mistakes=[...document.querySelectorAll('#pt-mistakes .mk.sel')].map(e=>e.textContent.trim());
  const sym=document.getElementById('pt-sym').value;
  const pnl=parseFloat(document.getElementById('pt-pnl').value)||0;
  const fees=feeForSymbol(sym);
  const trade={
    date:new Date().toISOString().split('T')[0],
    time:new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:false}),
    symbol:sym,side:'Long',qty:1,
    pnl,fees,netPnl:pnl-fees,
    tags:[document.getElementById('pt-setup').value].filter(Boolean),
    checklist,emotion,mistakes,
    notes:document.getElementById('pt-notes').value,
    chartUrl:document.getElementById('pt-chart').value,
    importedAt:new Date().toISOString(),
  };
  S.trades.push(trade);save();
  closeSession('post-trade-overlay');toast('Trade logged ✓','ok');
  updateSidebar();
}
function closeSession(id='pre-sesh-overlay'){document.getElementById(id).classList.remove('open');}

// ══════════════════════════════════════════════════════════
// ANALYTICS
// ══════════════════════════════════════════════════════════
function renderAnalytics(){
  const m=calcMetrics(S.trades);
  document.getElementById('perf-stats').innerHTML=[
    ['Net P&L',f$(m.net),m.net>=0?'var(--green)':'var(--red)'],
    ['Gross P&L',f$(m.gross||m.net),'var(--t1)'],
    ['Total Fees',f$(-m.fees),'var(--gold)'],
    ['Win Rate',fpct(m.winRate),'var(--t1)'],
    ['Profit Factor',isFinite(m.pf)?fnum(m.pf):'∞',m.pf>=1?'var(--green)':'var(--red)'],
    ['Expectancy',f$(m.exp),m.exp>=0?'var(--green)':'var(--red)'],
    ['Avg Winner',f$(m.avgWin),'var(--green)'],
    ['Avg Loser',f$(-m.avgLoss),'var(--red)'],
    ['Avg R:R',fnum(m.avgRR),'var(--t1)'],
    ['Total Trades',m.total||0,'var(--t1)'],
    ['Winners / Losers',`${m.wins||0} / ${m.losses||0}`,'var(--t1)'],
    ['Max Drawdown',f$(-m.maxDD),'var(--red)'],
  ].map(([k,v,c])=>`<div class="stat-row"><span class="stat-k">${k}</span><span class="stat-v" style="color:${c}">${v}</span></div>`).join('');

  // By symbol
  const syms={};
  S.trades.forEach(t=>{
    if(!t.symbol)return;
    if(!syms[t.symbol])syms[t.symbol]={pnl:0,cnt:0};
    syms[t.symbol].pnl+=(t.netPnl||t.pnl||0);syms[t.symbol].cnt++;
  });
  const maxSymPnl=Math.max(...Object.values(syms).map(v=>Math.abs(v.pnl)))||1;
  document.getElementById('sym-stats').innerHTML=Object.entries(syms).sort((a,b)=>b[1].pnl-a[1].pnl).map(([s,v])=>`
    <div class="stat-row">
      <span class="stat-k">${escapeHtml(s)} <span style="color:var(--t3)">(${v.cnt})</span></span>
      <span class="stat-v" style="color:${v.pnl>=0?'var(--green)':'var(--red)'}">${f$(v.pnl)}</span>
    </div>
    <div class="prog"><div class="prog-fill" style="width:${Math.min(100,Math.abs(v.pnl/maxSymPnl)*100)}%;background:${v.pnl>=0?'var(--green)':'var(--red)'}"></div></div>
  `).join('');

  // Streaks
  document.getElementById('streak-stats').innerHTML=[
    ['Best Win Streak',m.mW||0,'var(--green)'],
    ['Worst Loss Streak',m.mL||0,'var(--red)'],
    ['Total Winners',m.wins||0,'var(--green)'],
    ['Total Losers',m.losses||0,'var(--red)'],
  ].map(([k,v,c])=>`<div class="stat-row"><span class="stat-k">${k}</span><span class="stat-v" style="color:${c}">${v}</span></div>`).join('');

  // Risk
  document.getElementById('risk-stats').innerHTML=[
    ['Max Drawdown',f$(-m.maxDD),'var(--red)'],
    ['Total Fees Paid',f$(-m.fees),'var(--gold)'],
    ['Avg R:R Achieved',fnum(m.avgRR),'var(--t1)'],
    ['Best Trade',f$(Math.max(...S.trades.map(t=>t.netPnl||t.pnl||0).concat([0]))),'var(--green)'],
    ['Worst Trade',f$(Math.min(...S.trades.map(t=>t.netPnl||t.pnl||0).concat([0]))),'var(--red)'],
  ].map(([k,v,c])=>`<div class="stat-row"><span class="stat-k">${k}</span><span class="stat-v" style="color:${c}">${v}</span></div>`).join('');

  // Mistakes
  const mkCounts={};
  S.trades.forEach(t=>(t.mistakes||[]).forEach(mk=>{mkCounts[mk]=(mkCounts[mk]||0)+1;}));
  const maxMk=Math.max(...Object.values(mkCounts))||1;
  document.getElementById('mistake-stats').innerHTML=Object.entries(mkCounts).sort((a,b)=>b[1]-a[1]).map(([mk,cnt])=>`
    <div class="stat-row">
      <span class="stat-k">${escapeHtml(mk)}</span>
      <span class="stat-v" style="color:var(--red)">${cnt}x</span>
    </div>
    <div class="prog"><div class="prog-fill" style="width:${(cnt/maxMk)*100}%;background:var(--red);opacity:.7"></div></div>
  `).join('')||'<p style="font-size:.72rem;color:var(--t3);padding:8px 0">No mistakes logged yet. Keep it up! 💪</p>';

  // Heatmap
  renderHeatmap();
  // Psych score over time
  drawPsychCurve();
}

// ══════════════════════════════════════════════════════════
// HEATMAP
// ══════════════════════════════════════════════════════════
function renderHeatmap(){
  const el=document.getElementById('heatmap');
  const today=new Date();
  const start=new Date(today);
  start.setDate(start.getDate()-90);
  const dateMap={};
  S.trades.forEach(t=>{
    if(!t.date)return;
    const pnl=t.netPnl||t.pnl||0;
    dateMap[t.date]=(dateMap[t.date]||0)+pnl;
  });
  const cells=[];
  for(let d=new Date(start);d<=today;d.setDate(d.getDate()+1)){
    const ds=d.toISOString().split('T')[0];
    cells.push({date:ds,pnl:dateMap[ds]||0,hasData:!!dateMap[ds]});
  }
  el.innerHTML=cells.map(c=>{
    const intensity=c.hasData?Math.min(1,Math.abs(c.pnl)/200):0;
    const bg=!c.hasData?'var(--b1)':c.pnl>=0?`rgba(0,229,160,${0.15+intensity*0.7})`:`rgba(255,61,90,${0.15+intensity*0.7})`;
    return `<div class="hcell" style="background:${bg}" title="${c.date}: ${c.hasData?f$(c.pnl):'No trades'}"></div>`;
  }).join('');
}

// ══════════════════════════════════════════════════════════
// PSYCH CURVE
// ══════════════════════════════════════════════════════════
function drawPsychCurve(){
  const svg=document.getElementById('psych-svg');
  svg.innerHTML='';
  const entries=[...S.journal].sort((a,b)=>new Date(a.date)-new Date(b.date)).filter(e=>e.date);
  if(entries.length<2){
    const t=document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x','50%');t.setAttribute('y','50%');t.setAttribute('fill','#3d4f6e');
    t.setAttribute('text-anchor','middle');t.setAttribute('font-size','11');t.setAttribute('font-family','IBM Plex Mono');
    t.textContent='Journal more entries to see psychological trend';svg.appendChild(t);return;
  }
  const W=400,H=110,P=15;
  svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
  const scores=entries.map(e=>calcPsychScore(e,S.trades.filter(t=>t.date===e.date)));
  const maxX=entries.length-1||1;
  const px=x=>P+(x/maxX)*(W-2*P);
  const py=y=>P+(1-(y-1)/9)*(H-2*P);
  const line=document.createElementNS('http://www.w3.org/2000/svg','polyline');
  line.setAttribute('points',scores.map((s,i)=>`${px(i)},${py(s)}`).join(' '));
  line.setAttribute('fill','none');line.setAttribute('stroke','var(--purple)');line.setAttribute('stroke-width','2');
  svg.appendChild(line);
  scores.forEach((s,i)=>{
    const dot=document.createElementNS('http://www.w3.org/2000/svg','circle');
    dot.setAttribute('cx',px(i));dot.setAttribute('cy',py(s));dot.setAttribute('r','3');
    dot.setAttribute('fill','var(--purple)');svg.appendChild(dot);
  });
}

// ══════════════════════════════════════════════════════════
// ICT ANALYTICS
// ══════════════════════════════════════════════════════════
function renderICT(){
  // Setup win rates
  const setups={};
  S.trades.forEach(t=>{
    (t.tags||[]).forEach(tag=>{
      if(!setups[tag])setups[tag]={wins:0,total:0,pnl:0};
      setups[tag].total++;setups[tag].pnl+=(t.netPnl||t.pnl||0);
      if((t.netPnl||t.pnl||0)>0)setups[tag].wins++;
    });
  });
  document.getElementById('ict-setups').innerHTML=Object.keys(setups).length?
    Object.entries(setups).sort((a,b)=>b[1].pnl-a[1].pnl).map(([s,v])=>`
      <div style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px">
          <span style="font-family:var(--mono);font-size:.72rem;color:var(--gold)">${escapeHtml(s)}</span>
          <span style="font-family:var(--mono);font-size:.7rem">
            <span style="color:${v.pnl>=0?'var(--green)':'var(--red)'}">${f$(v.pnl)}</span>
            <span style="color:var(--t3);margin-left:8px">${fpct(v.wins/v.total)} WR · ${v.total}T</span>
          </span>
        </div>
        <div class="prog"><div class="prog-fill" style="width:${(v.wins/v.total)*100}%;background:${v.wins/v.total>=0.5?'var(--green)':'var(--red)'}"></div></div>
      </div>`).join('')
    :'<p style="font-size:.72rem;color:var(--t3)">Add ICT setup tags to your trades to see win rates by concept.</p>';

  // Killzone perf
  const kzPerf={};
  S.trades.forEach(t=>{
    const kz=t.killzone||'Unknown';
    if(!kzPerf[kz])kzPerf[kz]={wins:0,total:0,pnl:0};
    kzPerf[kz].total++;kzPerf[kz].pnl+=(t.netPnl||t.pnl||0);
    if((t.netPnl||t.pnl||0)>0)kzPerf[kz].wins++;
  });
  document.getElementById('kz-perf').innerHTML=Object.entries(kzPerf).sort((a,b)=>b[1].pnl-a[1].pnl).map(([kz,v])=>`
    <div class="stat-row">
      <span class="stat-k" style="color:var(--accent2)">${escapeHtml(kz)}</span>
      <span class="stat-v">
        <span style="color:${v.pnl>=0?'var(--green)':'var(--red)'}">${f$(v.pnl)}</span>
        <span style="color:var(--t3);font-size:.65rem;margin-left:6px">${fpct(v.wins/v.total)} WR</span>
      </span>
    </div>`).join('')||'<p style="font-size:.72rem;color:var(--t3)">No killzone data yet.</p>';

  // Checklist compliance
  const cklTotals={};const cklChecked={};
  S.trades.forEach(t=>{
    Object.entries(t.checklist||{}).forEach(([k,v])=>{
      cklTotals[k]=(cklTotals[k]||0)+1;
      if(v)cklChecked[k]=(cklChecked[k]||0)+1;
    });
  });
  document.getElementById('ckl-compliance').innerHTML=Object.keys(cklTotals).length?
    CKL_ITEMS.filter(k=>cklTotals[k]).map(k=>{
      const rate=(cklChecked[k]||0)/(cklTotals[k]||1);
      return `<div style="margin-bottom:6px">
        <div style="display:flex;justify-content:space-between;margin-bottom:2px">
          <span style="font-size:.68rem;color:var(--t2)">${k.substring(0,35)}${k.length>35?'…':''}</span>
          <span style="font-family:var(--mono);font-size:.68rem;color:${rate>=0.7?'var(--green)':'var(--red)'}">${fpct(rate)}</span>
        </div>
        <div class="prog"><div class="prog-fill" style="width:${rate*100}%;background:${rate>=0.7?'var(--green)':'var(--red)'}"></div></div>
      </div>`;}).join('')
    :'<p style="font-size:.72rem;color:var(--t3)">Complete the ICT checklist on trades to see compliance.</p>';

  // Bias accuracy
  const biasCorrect=S.trades.filter(t=>t.bias&&((t.bias==='Bullish'&&(t.netPnl||t.pnl||0)>0)||(t.bias==='Bearish'&&(t.netPnl||t.pnl||0)<0))).length;
  const biasTotal=S.trades.filter(t=>t.bias&&t.bias!=='Neutral').length;
  document.getElementById('bias-stats').innerHTML=`
    <div class="stat-row"><span class="stat-k">HTF Bias Accuracy</span><span class="stat-v" style="color:${biasTotal?fpct(biasCorrect/biasTotal):'—'}">${biasTotal?fpct(biasCorrect/biasTotal):'—'}</span></div>
    <div class="stat-row"><span class="stat-k">Bullish Bias Trades</span><span class="stat-v">${S.trades.filter(t=>t.bias==='Bullish').length}</span></div>
    <div class="stat-row"><span class="stat-k">Bearish Bias Trades</span><span class="stat-v">${S.trades.filter(t=>t.bias==='Bearish').length}</span></div>
    <div class="stat-row"><span class="stat-k">Traded Against Bias</span><span class="stat-v" style="color:var(--red)">${biasTotal-biasCorrect}</span></div>`;
}

// ══════════════════════════════════════════════════════════
// WEEKLY REPORT
// ══════════════════════════════════════════════════════════
function renderWeekly(){
  const el=document.getElementById('weekly-list');
  const empty=document.getElementById('weekly-empty');
  if(!S.trades.length){el.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  // Group by week
  const weeks={};
  S.trades.forEach(t=>{
    if(!t.date)return;
    const d=new Date(t.date+'T12:00:00');
    const dow=d.getDay();const mon=new Date(d);mon.setDate(d.getDate()-(dow===0?6:dow-1));
    const wk=mon.toISOString().split('T')[0];
    if(!weeks[wk])weeks[wk]={trades:[],start:mon};
    weeks[wk].trades.push(t);
  });
  el.innerHTML=Object.entries(weeks).sort((a,b)=>new Date(b[0])-new Date(a[0])).map(([wk,{trades,start}])=>{
    const end=new Date(start);end.setDate(start.getDate()+4);
    const m=calcMetrics(trades);
    const fmt=d=>d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    return `<div class="week-card">
      <div class="week-hdr">
        <div class="week-title">Week of ${fmt(start)} — ${fmt(end)}</div>
        <div class="week-pnl" style="color:${m.net>=0?'var(--green)':'var(--red)'}">${f$(m.net)}</div>
      </div>
      <div class="week-stats">
        <div class="ws"><div class="ws-label">Trades</div><div class="ws-val">${m.total}</div></div>
        <div class="ws"><div class="ws-label">Win Rate</div><div class="ws-val" style="color:${m.winRate>=.5?'var(--green)':'var(--red)'}">${fpct(m.winRate)}</div></div>
        <div class="ws"><div class="ws-label">Profit Factor</div><div class="ws-val" style="color:${m.pf>=1?'var(--green)':'var(--red)'}">${isFinite(m.pf)?fnum(m.pf):'∞'}</div></div>
        <div class="ws"><div class="ws-label">Fees Paid</div><div class="ws-val" style="color:var(--gold)">${f$(-m.fees)}</div></div>
      </div>
    </div>`;
  }).join('');
}

// ══════════════════════════════════════════════════════════
// IMPORT ENGINE (Complete Rewrite)
// ══════════════════════════════════════════════════════════
let pendingRows=[];
let pendingTrades=[];
let importMode='';
let lastImportFileName='';

function importHistory(e){
  const file=e.target.files[0];if(!file)return;
  lastImportFileName=file.name;
  // Reset file input so same file can be re-imported
  if(e.target.value) e.target.value='';
  const reader=new FileReader();
  reader.onload=ev=>{
    const text=ev.target.result;
    const rows=parseCSV(text);
    if(!rows.length){toast('Could not parse CSV — check format','err');return;}
    pendingRows=rows;
    const headers=Object.keys(rows[0]);
    const hl=headers.map(h=>h.toLowerCase());
    console.log('[TradeEdge] CSV Headers:', headers);
    console.log('[TradeEdge] First row:', JSON.stringify(rows[0]));

    // Detect format by checking which columns exist
    const hasFillPrice=hl.some(h=>h.includes('fill price'));
    const hasPnL=hl.some(h=>h.match(/p[&\/]?l|profit|result/i));
    const hasEntryExit=hl.some(h=>h.includes('entry'));
    const hasClosingTime=hl.some(h=>h.includes('closing time')||h.includes('status time'));

    if(hasEntryExit){
      importMode='account_history';
      pendingTrades=rows.map(r=>mapRow(r)).filter(Boolean);
    } else if(hasFillPrice||hasClosingTime){
      importMode='history_fills';
      pendingTrades=pairFills(rows);
    } else if(hasPnL){
      importMode='generic_pnl';
      pendingTrades=rows.map(r=>mapRow(r)).filter(Boolean);
    } else {
      importMode='generic';
      pendingTrades=rows.map(r=>mapRow(r)).filter(Boolean);
    }

    console.log('[TradeEdge] Mode:', importMode, '| Trades:', pendingTrades.length);
    if(pendingTrades.length) console.log('[TradeEdge] Sample:', JSON.stringify(pendingTrades[0]));

    showPreview(rows);
    showTradePreview(pendingTrades);
    document.getElementById('ic-history-status').textContent=`✓ ${rows.length} rows → ${pendingTrades.length} trades`;
    document.getElementById('ic-history-status').style.color='var(--green)';
    document.getElementById('ic-history').classList.add('has-data');
    toast(`${pendingTrades.length} trades parsed`,'ok');
  };
  reader.readAsText(file);
}

// Robust CSV parser — handles quotes, commas inside quotes, tabs
function parseCSV(text){
  const lines=text.trim().split(/\r?\n/);
  if(lines.length<2)return[];
  const d=lines[0].includes('\t')?'\t':',';
  function split(line){
    const r=[];let c='';let q=false;
    for(let i=0;i<line.length;i++){
      if(line[i]==='"'){q=!q;continue;}
      if(line[i]===d&&!q){r.push(c.trim());c='';continue;}
      c+=line[i];
    }
    r.push(c.trim());return r;
  }
  const hdrs=split(lines[0]);
  return lines.slice(1).filter(l=>l.trim()).map(line=>{
    const v=split(line);
    const o={};hdrs.forEach((h,i)=>o[h]=v[i]!==undefined?v[i]:'');
    return o;
  });
}

// --- Column value helpers (case-insensitive, partial match) ---
function gv(row,...names){
  const keys=Object.keys(row);
  for(const n of names){
    const e=keys.find(k=>k.toLowerCase()===n.toLowerCase());
    if(e&&row[e]!=='')return row[e];
  }
  for(const n of names){
    const p=keys.find(k=>k.toLowerCase().includes(n.toLowerCase()));
    if(p&&row[p]!=='')return row[p];
  }
  return '';
}
function gn(row,...names){
  let v=gv(row,...names);if(!v)return 0;
  v=String(v).replace(/[$,\s]/g,'');
  if(v.startsWith('(')&&v.endsWith(')'))v='-'+v.slice(1,-1);
  return parseFloat(v)||0;
}

// Parse date+time from various formats
function pdt(str){
  if(!str)return{date:'',time:''};
  str=str.trim();
  if(str.includes('T')){const[d,t]=str.split('T');return{date:d,time:t.substring(0,5)};}
  const p=str.split(/[\s]+/);
  let dp=p[0]||'',tp=p.slice(1).join(' ')||'';
  const m=dp.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m)dp=`${m[3]}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}`;
  dp=dp.replace(/\//g,'-');
  if(tp){
    const a=tp.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?/i);
    if(a){let h=parseInt(a[1]);
      if(a[4]&&a[4].toUpperCase()==='PM'&&h!==12)h+=12;
      if(a[4]&&a[4].toUpperCase()==='AM'&&h===12)h=0;
      tp=`${String(h).padStart(2,'0')}:${a[2]}`;}
  }
  return{date:dp,time:tp};
}

// Normalize symbol: F.US.MNQH26→MNQ, CME_MINI:MESH2025→MES, NQ1!→NQ
function nsym(s){
  if(!s)return'';s=s.toUpperCase().trim();
  // Strip exchange prefixes: "CME_MINI:", "F.US.", "COMEX:", etc.
  s=s.replace(/^[A-Z_]+:/,'');
  s=s.replace(/^F\.[A-Z]+\./,''); // F.US.MNQH26 → MNQH26
  s=s.replace(/^[A-Z]+\./,'');    // CME.ESH26 → ESH26
  const m=s.match(/^([A-Z]{2,4}?)[FGHJKMNQUVXZ]\d{2,4}$/);
  if(m)return m[1];
  return s.replace(/\d*!$/,'');
}

// Detect ICT killzone from time (ET assumed)
function dkz(time){
  if(!time)return'';
  const m=time.match(/(\d{1,2}):(\d{2})/);if(!m)return'';
  const mins=parseInt(m[1])*60+parseInt(m[2]);
  if(mins>=120&&mins<=300)return'London (2–5am ET)';
  if(mins>=510&&mins<=660)return'NY AM (8:30–11am ET)';
  if(mins>=660&&mins<=780)return'NY Lunch (11am–1pm ET)';
  if(mins>=810&&mins<=960)return'NY PM (1:30–4pm ET)';
  if(mins%60>=50||mins%60<=10)return'Macro Window';
  return'Outside Killzone';
}

function isbuy(v){if(!v)return true;const l=v.toLowerCase();return l.includes('buy')||l==='long'||l==='b';}

// Tick value per point for P&L calculation
function getTickValue(sym){
  return{MNQ:2,MES:5,NQ:20,ES:50,CL:1000,MCL:100,GC:100,MGC:10,YM:5,MYM:0.5,RTY:50,M2K:5}[sym]||1;
}

// Map a single row to a complete trade (account history / generic with P&L)
function mapRow(row){
  const dtStr=gv(row,'Status Time','Closing Time','Close Time','Close Date','Date','Time','Timestamp','Trade Date','Fill Time','Placing Time');
  const{date,time}=pdt(dtStr);
  const sym=nsym(gv(row,'Symbol','Instrument','Contract','Market','Ticker'));
  const side=isbuy(gv(row,'Side','Direction','Type','Action','Buy/Sell'))?'Long':'Short';
  const qty=Math.abs(gn(row,'Fill Qty','Filled Qty','Qty','Quantity','Size','Contracts','Volume'))||1;
  const entry=gn(row,'Entry Price','Avg Entry','Open Price','Entry','Avg Fill Price','Fill Price','Price');
  const exit=gn(row,'Exit Price','Close Price','Avg Close','Exit');
  const pnl=gn(row,'P&L','PnL','Profit','Net P&L','Realized P&L','P/L','Gross P/L','Result');
  const comm=gn(row,'Commission','Comm','Fees','Fee');
  if(!sym&&!date&&!pnl)return null;
  let calcPnl=pnl;
  if(!pnl&&entry&&exit){
    calcPnl=(side==='Long'?(exit-entry):(entry-exit))*getTickValue(sym)*qty;
  }
  const fees=comm||feeForSymbol(sym)*qty*2;
  return{date,time,symbol:sym,side,qty,entry:entry||null,exit:exit||null,sl:null,tp:null,
    pnl:calcPnl,fees,netPnl:calcPnl-fees,rr:null,tags:[],checklist:{},mistakes:[],rating:0,
    killzone:dkz(time),emotion:'',bias:'',notes:'',chartUrl:'',chartImg:null,
    importedAt:new Date().toISOString(),source:'CSV ('+importMode+')'};
}

// Pair individual fills (Buy row + Sell row) into round-trip trades
function pairFills(rows){
  const fills=rows.map(row=>{
    const dtStr=gv(row,'Status Time','Closing Time','Close Time','Fill Time','Date','Time','Timestamp','Trade Date','Placing Time');
    const{date,time}=pdt(dtStr);
    const placingStr=gv(row,'Placing Time');
    const{date:pDate,time:pTime}=pdt(placingStr);
    const sym=nsym(gv(row,'Symbol','Instrument','Contract','Market','Ticker'));
    const buy=isbuy(gv(row,'Side','Direction','Type','Action','Buy/Sell'));
    const qty=Math.abs(gn(row,'Fill Qty','Filled Qty','Qty','Quantity','Size','Contracts'))||1;
    const price=gn(row,'Avg Fill Price','Fill Price','Price','Avg Price','Exec Price','Trade Price');
    const comm=gn(row,'Commission','Comm','Fees','Fee');
    const pnl=gn(row,'P&L','PnL','Profit','Net P&L','P/L');
    const orderId=gv(row,'Order ID','OrderID','Order Id');
    const orderType=gv(row,'Type','Order Type');
    const stopPrice=gn(row,'Stop Price');
    const limitPrice=gn(row,'Limit Price');
    if(!sym&&!price)return null;
    const sortKey=(date||'9999')+' '+(time||'00:00');
    const placingKey=pDate?pDate+' '+(pTime||'00:00'):'';
    return{date,time,sym:sym||'UNKNOWN',buy,qty,price,comm,pnl,sortKey,
      placingTime:placingKey,orderId,orderType,stopPrice,limitPrice};
  }).filter(Boolean);

  console.log('[TradeEdge] Fills parsed:', fills.length);
  if(fills.length) console.log('[TradeEdge] Sample fill:', JSON.stringify(fills[0]));
  fills.sort((a,b)=>a.sortKey.localeCompare(b.sortKey));

  const trades=[];
  const bySymbol={};
  fills.forEach(f=>{if(!bySymbol[f.sym])bySymbol[f.sym]=[];bySymbol[f.sym].push(f);});

  Object.entries(bySymbol).forEach(([sym,sf])=>{
    if(sf.length>0 && sf.every(f=>f.pnl)){
      sf.forEach(f=>{
        const fees=f.comm||feeForSymbol(sym)*f.qty*2;
        trades.push({
          date:f.date,time:f.time,symbol:sym,side:f.buy?'Long':'Short',qty:f.qty,
          entry:f.price,exit:null,sl:null,tp:null,slPrice:null,tpPrice:null,
          slDollar:null,tpDollar:null,slHistory:[],tpHistory:[],
          entryOrderId:f.orderId,exitOrderId:null,
          entryPlacingTime:f.placingTime,exitPlacingTime:null,
          entryOrderType:f.orderType,exitOrderType:null,
          pnl:f.pnl,fees,netPnl:f.pnl-fees,
          rr:null,tags:[],checklist:{},mistakes:[],rating:0,
          killzone:dkz(f.time),emotion:'',bias:'',notes:'',chartUrl:'',chartImg:null,
          importedAt:new Date().toISOString(),source:'TV History (with P&L)'
        });
      });
      return;
    }

    const buyQ=sf.filter(f=>f.buy);
    const sellQ=sf.filter(f=>!f.buy);
    const bCopy=[...buyQ], sCopy=[...sellQ];

    while(bCopy.length && sCopy.length){
      const b=bCopy[0], s=sCopy[0];
      if(b.sortKey<=s.sortKey){
        bCopy.shift(); sCopy.shift();
        const mq=Math.min(b.qty,s.qty);
        const calcPnl=(s.price-b.price)*getTickValue(sym)*mq;
        const tc=(b.comm||0)+(s.comm||0);
        const fees=tc||feeForSymbol(sym)*mq*2;
        trades.push({
          date:b.date,time:b.time,symbol:sym,side:'Long',qty:mq,
          entry:b.price,exit:s.price,sl:null,tp:null,slPrice:null,tpPrice:null,
          slDollar:null,tpDollar:null,slHistory:[],tpHistory:[],
          entryOrderId:b.orderId,exitOrderId:s.orderId,
          entryPlacingTime:b.placingTime,exitPlacingTime:s.placingTime,
          entryOrderType:b.orderType,exitOrderType:s.orderType,
          exitStopPrice:s.stopPrice||null,exitLimitPrice:s.limitPrice||null,
          pnl:calcPnl,fees,netPnl:calcPnl-fees,
          rr:null,tags:[],checklist:{},mistakes:[],rating:0,
          killzone:dkz(b.time),emotion:'',bias:'',notes:'',chartUrl:'',chartImg:null,
          importedAt:new Date().toISOString(),source:'TV History (paired)'
        });
      } else {
        sCopy.shift(); bCopy.shift();
        const mq=Math.min(b.qty,s.qty);
        const calcPnl=(s.price-b.price)*getTickValue(sym)*mq;
        const tc=(b.comm||0)+(s.comm||0);
        const fees=tc||feeForSymbol(sym)*mq*2;
        trades.push({
          date:s.date,time:s.time,symbol:sym,side:'Short',qty:mq,
          entry:s.price,exit:b.price,sl:null,tp:null,slPrice:null,tpPrice:null,
          slDollar:null,tpDollar:null,slHistory:[],tpHistory:[],
          entryOrderId:s.orderId,exitOrderId:b.orderId,
          entryPlacingTime:s.placingTime,exitPlacingTime:b.placingTime,
          entryOrderType:s.orderType,exitOrderType:b.orderType,
          exitStopPrice:b.stopPrice||null,exitLimitPrice:b.limitPrice||null,
          pnl:calcPnl,fees,netPnl:calcPnl-fees,
          rr:null,tags:[],checklist:{},mistakes:[],rating:0,
          killzone:dkz(s.time),emotion:'',bias:'',notes:'',chartUrl:'',chartImg:null,
          importedAt:new Date().toISOString(),source:'TV History (paired)'
        });
      }
    }

    [...bCopy,...sCopy].forEach(f=>{
      const fees=f.comm||feeForSymbol(sym)*f.qty;
      trades.push({
        date:f.date,time:f.time,symbol:sym,side:f.buy?'Long':'Short',qty:f.qty,
        entry:f.price,exit:null,sl:null,tp:null,slPrice:null,tpPrice:null,
        slDollar:null,tpDollar:null,slHistory:[],tpHistory:[],
        entryOrderId:f.orderId,exitOrderId:null,
        entryPlacingTime:f.placingTime,exitPlacingTime:null,
        entryOrderType:f.orderType,exitOrderType:null,
        pnl:f.pnl||0,fees,netPnl:(f.pnl||0)-fees,
        rr:null,tags:[],checklist:{},mistakes:[],rating:0,
        killzone:dkz(f.time),emotion:'',bias:'',notes:'Unmatched fill',chartUrl:'',chartImg:null,
        importedAt:new Date().toISOString(),source:'TV History (unmatched)'
      });
    });
  });

  console.log('[TradeEdge] Paired trades:', trades.length);
  if(trades.length) console.log('[TradeEdge] First trade:', JSON.stringify(trades[0]));
  return trades;
}

// ══════════════════════════════════════════════════════════
// ══════════════════════════════════════════════════════════
// SL/TP RECONSTRUCTION FROM CANCELLED ORDERS + FILLED EXITS
// ══════════════════════════════════════════════════════════
function reconstructSLTP(){
  if(!S.trades.length){console.log('[TradeEdge] SL/TP: No trades');return;}

  // Parse cancelled orders if available
  let orders=[];
  const cancelled=S.pendingCancelled;
  if(cancelled&&cancelled.length){
    orders=cancelled.map(row=>{
      const dtStr=gv(row,'Status Time','Closing Time','Close Time');
      const{date,time}=pdt(dtStr);
      const placingStr=gv(row,'Placing Time');
      const{date:pDate,time:pTime}=pdt(placingStr);
      const sym=nsym(gv(row,'Symbol','Instrument','Contract','Market','Ticker'));
      const side=gv(row,'Side','Direction').toLowerCase();
      const type=gv(row,'Type','Order Type').toLowerCase();
      const qty=Math.abs(gn(row,'Qty','Quantity'))||1;
      const limitPrice=gn(row,'Limit Price');
      const stopPrice=gn(row,'Stop Price');
      const price=limitPrice||stopPrice||0;
      const orderId=gv(row,'Order ID','OrderID');
      const cancelTime=date+' '+(time||'00:00');
      const placingTime=pDate?pDate+' '+(pTime||'00:00'):'';
      const isBuy=side.includes('buy');
      const isStop=type.includes('stop')&&!type.includes('take');
      const isLimit=type.includes('limit');
      const isTP=type.includes('take profit')||type.includes('tp');
      return{date,time,sym,side,type,qty,limitPrice,stopPrice,price,orderId,cancelTime,placingTime,isBuy,isStop,isLimit,isTP};
    }).filter(o=>o.sym&&o.price);
    console.log('[TradeEdge] SL/TP: Parsed',orders.length,'cancelled orders');
  }

  function toMs(t){try{return new Date(t.replace(' ','T')).getTime();}catch(e){return NaN;}}

  S.trades.forEach(trade=>{
    if(!trade.entry||!trade.date)return;
    const tv=getTickValue(trade.symbol);
    const isLong=trade.side==='Long';

    // ═══ STEP 1: SL from exit order's stop price (the SL that actually got hit) ═══
    if(trade.exitStopPrice){
      const et=(trade.exitOrderType||'').toLowerCase();
      if(et.includes('stop')){
        const slPrice=trade.exitStopPrice;
        const slDollar=isLong?(slPrice-trade.entry)*tv*trade.qty:(trade.entry-slPrice)*tv*trade.qty;
        trade.slPrice=slPrice;
        trade.slDollar=slDollar;
        if(!trade.slHistory||!trade.slHistory.length){
          trade.slHistory=[{price:slPrice,dollar:slDollar,time:trade.exitPlacingTime||'',source:'filled'}];
        }
      }
    }

    // ═══ STEP 2: Exit reason from order type ═══
    if(trade.exitOrderType){
      const et=trade.exitOrderType.toLowerCase();
      if(et.includes('stop')&&!et.includes('take')) trade.exitReason='SL Hit';
      else if(et.includes('limit')||et.includes('take profit')||et.includes('tp')) trade.exitReason='TP Hit';
      else if(et.includes('market')) trade.exitReason='Manual Exit';
      else trade.exitReason='Unknown';
    }

    // ═══ STEP 3: TP + SL adjustments from cancelled orders ═══
    if(!orders.length){
      if(trade.slDollar) trade.actualR=Math.abs((trade.pnl||0)/Math.abs(trade.slDollar))*(trade.pnl>=0?1:-1);
      return;
    }

    const entryTime=trade.entryPlacingTime||trade.date+' '+(trade.time||'00:00');
    const exitTime=trade.exitPlacingTime||trade.date+' 23:59';
    const entryMs=toMs(entryTime);
    const exitMs=toMs(exitTime);

    // Only match cancelled orders placed between entry-5min and exit
    const candidates=orders.filter(o=>{
      if(o.sym!==trade.symbol||o.date!==trade.date)return false;
      const pMs=toMs(o.placingTime||o.cancelTime);
      if(isNaN(pMs)||isNaN(entryMs))return true;
      return pMs>=(entryMs-300000)&&pMs<=exitMs;
    });

    // Find TP orders
    const tpCandidates=[];
    candidates.forEach(o=>{
      if(isLong){
        if(!o.isBuy&&(o.isLimit||o.isTP)&&o.price>trade.entry)tpCandidates.push(o);
      }else{
        if(o.isBuy&&(o.isLimit||o.isTP)&&o.price<trade.entry)tpCandidates.push(o);
      }
    });

    // Find SL adjustment orders (cancelled SL = SL was moved)
    const slAdjCandidates=[];
    candidates.forEach(o=>{
      if(isLong){
        if(!o.isBuy&&o.isStop&&o.price<trade.entry)slAdjCandidates.push(o);
      }else{
        if(o.isBuy&&o.isStop&&o.price>trade.entry)slAdjCandidates.push(o);
      }
    });

    // Build SL history (adjustments + final hit)
    if(slAdjCandidates.length){
      const slHist=[];
      const seen=new Set();
      slAdjCandidates.sort((a,b)=>(a.placingTime||a.cancelTime).localeCompare(b.placingTime||b.cancelTime));
      slAdjCandidates.forEach(o=>{
        if(seen.has(o.price))return;
        seen.add(o.price);
        const d=isLong?(o.price-trade.entry)*tv*trade.qty:(trade.entry-o.price)*tv*trade.qty;
        slHist.push({price:o.price,dollar:d,time:o.placingTime||o.cancelTime,orderId:o.orderId,source:'cancelled'});
      });
      // Add the final SL (the one that hit) at end if not already there
      if(trade.slPrice&&!seen.has(trade.slPrice)){
        slHist.push({price:trade.slPrice,dollar:trade.slDollar,time:trade.exitPlacingTime||'',source:'filled'});
      }
      if(slHist.length)trade.slHistory=slHist;
      // If no exit SL yet, use first cancelled as initial
      if(!trade.slPrice&&slHist.length){trade.slPrice=slHist[0].price;trade.slDollar=slHist[0].dollar;}
    }

    // Build TP history
    const tpHist=[];
    const seenTP=new Set();
    tpCandidates.sort((a,b)=>(a.placingTime||a.cancelTime).localeCompare(b.placingTime||b.cancelTime));
    tpCandidates.forEach(o=>{
      if(seenTP.has(o.price))return;
      seenTP.add(o.price);
      const d=isLong?(o.price-trade.entry)*tv*trade.qty:(trade.entry-o.price)*tv*trade.qty;
      tpHist.push({price:o.price,dollar:Math.abs(d),time:o.placingTime||o.cancelTime,orderId:o.orderId});
    });
    if(tpHist.length){
      trade.tpPrice=tpHist[0].price;
      trade.tpDollar=tpHist[0].dollar;
      trade.tpHistory=tpHist;
    }

    // R:R from SL and TP
    if(trade.slDollar&&trade.tpDollar)trade.rr=Math.abs(trade.tpDollar/Math.abs(trade.slDollar));

    // Actual R multiple
    if(trade.slDollar)trade.actualR=Math.abs((trade.pnl||0)/Math.abs(trade.slDollar))*(trade.pnl>=0?1:-1);

    console.log('[TradeEdge] SL/TP:',trade.date,trade.time,trade.side,
      '| SL:',trade.slPrice,'('+f$(trade.slDollar)+')',
      '| TP:',trade.tpPrice,'('+f$(trade.tpDollar)+')',
      '| R:R:',trade.rr?fnum(trade.rr):'—',
      '| Exit:',trade.exitReason||'—',
      '| ActualR:',trade.actualR?fnum(trade.actualR):'—');
  });

  save();
  console.log('[TradeEdge] SL/TP reconstruction complete');
}

function showPreview(rows){
  if(!rows.length)return;
  document.getElementById('import-preview').style.display='block';
  const k=Object.keys(rows[0]);
  document.getElementById('prev-head').innerHTML='<th>#</th>'+k.map(h=>`<th>${escapeHtml(h)}</th>`).join('');
  document.getElementById('prev-body').innerHTML=rows.slice(0,8).map((r,i)=>
    `<tr><td class="mono" style="color:var(--t3)">${i+1}</td>${k.map(h=>`<td>${escapeHtml(r[h]||'')}</td>`).join('')}</tr>`
  ).join('');
}

function showTradePreview(trades){
  const container=document.getElementById('import-preview');
  let tp=document.getElementById('trade-preview');
  if(!tp){tp=document.createElement('div');tp.id='trade-preview';container.appendChild(tp);}
  if(!trades.length){
    tp.innerHTML=`<div class="cc" style="margin-top:12px;border-color:var(--red)">
      <div class="cc-title" style="color:var(--red)">⚠ NO TRADES PARSED</div>
      <p style="font-size:.76rem;color:var(--t2);line-height:1.6">Could not match fills into trades. Open browser console (Cmd+Option+J) for debug info.<br>
      Expected columns: <strong>Side, Qty, Fill Price, Closing Time, Symbol</strong> (History tab) or <strong>Symbol, Side, Entry Price, Close Price, P&L</strong> (Account History).</p>
      <p style="font-size:.68rem;color:var(--t3);margin-top:8px;font-family:var(--mono)">Mode: ${importMode} | Raw rows: ${pendingRows.length} | Headers: ${pendingRows.length?Object.keys(pendingRows[0]).join(', '):'none'}</p>
    </div>`;return;
  }
  const totalPnl=trades.reduce((s,t)=>s+(t.pnl||0),0);
  const totalNet=trades.reduce((s,t)=>s+(t.netPnl||0),0);
  const totalFees=trades.reduce((s,t)=>s+(t.fees||0),0);
  tp.innerHTML=`
    <div class="cc" style="margin-top:12px;border-color:rgba(0,240,192,.3)">
      <div class="cc-title">✓ PARSED TRADES (${trades.length})
        <span style="font-size:.68rem;color:var(--accent);text-transform:none;letter-spacing:0">Mode: ${importMode}</span>
      </div>
      <div style="display:flex;gap:16px;margin-bottom:10px;font-size:.72rem;font-family:var(--mono)">
        <span>Gross: <strong style="color:${totalPnl>=0?'var(--green)':'var(--red)'}">${f$(totalPnl)}</strong></span>
        <span>Fees: <strong style="color:var(--gold)">${f$(-totalFees)}</strong></span>
        <span>Net: <strong style="color:${totalNet>=0?'var(--green)':'var(--red)'}">${f$(totalNet)}</strong></span>
      </div>
      <div style="overflow-x:auto"><table>
        <thead><tr><th>Date</th><th>Time</th><th>Symbol</th><th>Side</th><th>Qty</th><th>Entry</th><th>Exit</th><th>Gross P&L</th><th>Fees</th><th>Net P&L</th><th>KZ</th></tr></thead>
        <tbody>${trades.slice(0,10).map(t=>`<tr>
          <td class="mono">${t.date||'—'}</td>
          <td class="mono" style="color:var(--t3)">${t.time||'—'}</td>
          <td class="sym">${escapeHtml(t.symbol)||'—'}</td>
          <td><span class="bdg ${t.side==='Long'?'bdg-long':'bdg-short'}">${t.side}</span></td>
          <td class="mono">${t.qty}</td>
          <td class="mono">${t.entry||'—'}</td>
          <td class="mono">${t.exit||'—'}</td>
          <td class="mono" style="color:${(t.pnl||0)>=0?'var(--green)':'var(--red)'}">${f$(t.pnl)}</td>
          <td class="mono" style="color:var(--gold)">${f$(-t.fees)}</td>
          <td class="mono" style="color:${(t.netPnl||0)>=0?'var(--green)':'var(--red)'}; font-weight:600">${f$(t.netPnl)}</td>
          <td style="font-size:.6rem">${t.killzone?t.killzone.split('(')[0].trim():'—'}</td>
        </tr>`).join('')}
        ${trades.length>10?`<tr><td colspan="11" style="text-align:center;color:var(--t3)">… +${trades.length-10} more</td></tr>`:''}
        </tbody></table></div>
    </div>`;
}

// Called after EITHER trades or PDF are imported — always gives the right starting balance
// Show/hide the import order warning banner
function updateImportStatus(){
  var warn=document.getElementById('import-order-warn');
  var warnText=document.getElementById('import-order-warn-text');
  if(!warn||!warnText)return;
  var hasTrades=S.trades&&S.trades.length>0;
  var hasPDF=S.ampStatements&&S.ampStatements.length>0;
  if(hasPDF&&!hasTrades){
    warnText.textContent='PDF loaded but no filled orders CSV yet — drop your filled orders CSV to compute starting balance.';
    warn.style.display='flex';
  } else if(hasTrades&&!hasPDF){
    warnText.textContent='Trades loaded but no AMP PDF yet — drop your AMP daily statement PDF to auto-set your starting balance ($'+S.startingBalance+' currently manual).';
    warn.style.display='flex';
  } else if(hasTrades&&hasPDF&&S.startingBalance>0){
    warn.style.display='none'; // All good
  } else {
    warn.style.display='none';
  }
}

function _recomputeStartingBalance(){
  if(!S.ampStatements||!S.ampStatements.length||!S.trades||!S.trades.length)return;
  var latestStmt=null,latestDate='';
  S.ampStatements.forEach(function(st){if(!latestDate||st.tradeDate>latestDate){latestDate=st.tradeDate;latestStmt=st;}});
  var nlv=latestStmt?(latestStmt.netLiq||latestStmt.balance||0):0;
  if(!nlv)return;
  var totalNetPnl=S.trades.reduce(function(sum,t){return sum+(t.netPnl||t.pnl||0);},0);
  var implied=Math.round((nlv-totalNetPnl)*100)/100;
  if(implied>0){
    S.startingBalance=implied;
    console.log('[TradeEdge] Starting balance recomputed: NLV $'+nlv+' − net P&L $'+totalNetPnl.toFixed(2)+' = $'+implied);
    // Update settings input if visible
    var bi=document.getElementById('set-balance');if(bi&&bi!==document.activeElement)bi.value=implied;
    renderDash();updateSidebar();
    updateImportStatus();
  }
}

function confirmImport(){
  if(!pendingTrades.length){toast('No trades to import — upload a CSV first','err');return;}
  let added=0,skipped=0;
  pendingTrades.forEach(t=>{
    if(!t)return;
    const k=`${t.date}|${t.time}|${t.symbol}|${t.side}|${t.entry||''}|${t.pnl||''}`;
    if(S.trades.some(e=>`${e.date}|${e.time}|${e.symbol}|${e.side}|${e.entry||''}|${e.pnl||''}`===k)){skipped++;return;}
    S.trades.push(t);added++;
  });
  console.log('[TradeEdge] Import confirmed:', added, 'added,', skipped, 'skipped. Total trades:', S.trades.length);
  if(S.trades.length) console.log('[TradeEdge] Last trade:', JSON.stringify(S.trades[S.trades.length-1]));
  if(!S.importLog) S.importLog=[];
  S.importLog.push({type:'CSV',mode:importMode,fileName:lastImportFileName||'Unknown',tradesAdded:added,tradesSkipped:skipped,date:new Date().toISOString()});
  // Reconstruct SL/TP from cancelled orders if available
  if(S.pendingCancelled&&S.pendingCancelled.length){
    reconstructSLTP();
  }
  // Recompute starting balance now that trades exist — works even if PDF was imported first
  _recomputeStartingBalance();
  save();
  pendingRows=[];pendingTrades=[];
  document.getElementById('import-preview').style.display='none';
  const tp=document.getElementById('trade-preview');if(tp)tp.remove();
  toast(`✓ Imported ${added} trades (${skipped} duplicates skipped)`,'ok');
  if(typeof renderImportLog==='function')renderImportLog();
  updateSidebar();
  go('dashboard');
}

// ══════════════════════════════════════════════════════════
// PDF TEXT EXTRACTION (using pdf.js)
// ══════════════════════════════════════════════════════════
async function extractPDFText(file){
  if(!window.pdfjsLib){console.error('[TradeEdge] pdf.js not loaded');return '';}
  const buf=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:buf}).promise;
  let text='';
  for(let i=1;i<=pdf.numPages;i++){
    const page=await pdf.getPage(i);
    const content=await page.getTextContent();
    text+=content.items.map(function(item){return item.str;}).join(' ')+'\n';
  }
  console.log('[TradeEdge] PDF extracted text (first 500):', text.substring(0,500));
  return text;
}

// ══════════════════════════════════════════════════════════
// AMP PDF IMPORT — supports MULTIPLE files at once
// ══════════════════════════════════════════════════════════
function importPDFs(e){
  const files=[...e.target.files];if(!files.length)return;
  let processed=0,totalNew=0;
  if(!S.ampStatements)S.ampStatements=[];
  if(!S.importLog)S.importLog=[];

  files.forEach(function(file){
    extractPDFText(file).then(function(text){
      if(!text||text.length<50){
        // Fallback: try raw text read if pdf.js failed
        var reader=new FileReader();
        reader.onload=function(ev){processAMPText(ev.target.result,file);};
        reader.readAsText(file);
      } else {
        processAMPText(text,file);
      }
    }).catch(function(err){
      console.error('[TradeEdge] PDF extraction error:', err);
      // Fallback to raw read
      var reader=new FileReader();
      reader.onload=function(ev){processAMPText(ev.target.result,file);};
      reader.readAsText(file);
    });
  });

  function processAMPText(text,file){
    var result=parseAMPStatement(text,file.name);
    if(result){
      var alreadyExists=S.ampStatements.some(function(s){return s.tradeDate===result.tradeDate&&s.fileName===result.fileName;});
      if(!alreadyExists){
        S.ampStatements.push(result);
        if(result.accountName)S.accountName=result.accountName;
        totalNew++;
        if(result.trades&&result.trades.length){
          result.trades.forEach(function(t){
            // Skip PDF synthetic trade if CSV already covers this date+symbol
            var hasCSVTrade=S.trades.some(function(et){
              return et.date===t.date&&et.symbol===t.symbol&&
                     et.source&&!et.source.includes('AMP Statement');
            });
            if(!hasCSVTrade){S.trades.push(t);}
          });
        }
        S.importLog.push({type:'AMP PDF',fileName:file.name,tradeDate:result.tradeDate,
          realizedPnl:result.realizedPnl,totalFees:result.fees.total,balance:result.balance,
          tradesExtracted:result.trades?result.trades.length:0,date:new Date().toISOString()});
      }
    }
    processed++;
    if(processed===files.length){
      S.ampStatements.sort(function(a,b){return new Date(a.tradeDate)-new Date(b.tradeDate);});
      if(S.ampStatements.length){S.ampFees=S.ampStatements[S.ampStatements.length-1].fees;}
      // Try to compute starting balance (needs both trades + NLV)
      _recomputeStartingBalance();
      save();
      document.getElementById('ic-pdf-status').textContent='✓ '+S.ampStatements.length+' statements ('+totalNew+' new)';
      document.getElementById('ic-pdf-status').style.color='var(--green)';
      document.getElementById('ic-pdf').classList.add('has-data');
      // Warn if trades not yet imported
      if(!S.trades.length){
        toast('✓ PDF loaded — now drop your filled orders CSV to complete setup','warn');
      } else {
        toast('✓ '+files.length+' PDF'+(files.length>1?'s':'')+' processed · Starting balance: $'+S.startingBalance,'ok');
      }
      if(typeof renderAMPStatements==='function')renderAMPStatements();
      if(typeof renderImportLog==='function')renderImportLog();
      renderDash();
      updateSidebar();
      updateImportStatus();
    }
  }
}

function parseAMPStatement(text,fileName){
  if(!text||text.length<50)return null;
  console.log('[TradeEdge] Parsing AMP PDF:', fileName, '| Length:', text.length);
  
  // Month name map for DD-MON-YY format
  const MON={JAN:'01',FEB:'02',MAR:'03',APR:'04',MAY:'05',JUN:'06',JUL:'07',AUG:'08',SEP:'09',OCT:'10',NOV:'11',DEC:'12'};
  function ampDate(s){
    if(!s)return'';
    const m=s.match(/(\d{1,2})-([A-Z]{3})-(\d{2,4})/i);
    if(m){let y=m[3];if(y.length===2)y=(parseInt(y)>50?'19':'20')+y;return`${y}-${MON[m[2].toUpperCase()]||'01'}-${m[1].padStart(2,'0')}`;}
    const m2=s.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
    if(m2){let y=m2[3];if(y.length===2)y=(parseInt(y)>50?'19':'20')+y;return`${y}-${m2[1].padStart(2,'0')}-${m2[2].padStart(2,'0')}`;}
    return s;
  }
  
  // Extract account name - with pdf.js we now have actual text
  let accountName='';
  console.log('[TradeEdge] Parsing text (first 300):', text.substring(0,300));
  
  // Pattern 1: Name right before date (e.g. "Ricardo Samitier 19-FEB-26")
  // Pattern 1: Name before date - but skip if it starts with common doc words
  var nm1raw=text.match(/([A-Za-z]{2,}\s+[A-Za-z]{2,}(?:\s+[A-Za-z]{2,})?)\s+\d{1,2}-[A-Z]{3}-\d{2,4}/);
  var nm1=nm1raw;
  if(nm1&&/(statement|daily|report|account|summary|page)/i.test(nm1[1].split(/\s+/)[0])){
    // First word is junk, try dropping it
    var parts=nm1[1].trim().split(/\s+/);
    if(parts.length>=3){nm1=[null,parts.slice(1).join(' ')];}
    else{nm1=null;}
  }
  // Pattern 2: Name field
  const nm2=text.match(/(?:Name|Client|Account\s*Holder)[:\s]+([A-Za-z]{2,}\s+[A-Za-z]{2,}(?:\s+[A-Za-z]{2,})?)/i);
  // Pattern 3: Standalone name-like text in first 200 chars (2-3 words, only letters)
  const first200=text.substring(0,200);
  const words=first200.split(/\s+/);
  let nm3=null;
  for(var wi=0;wi<words.length-1;wi++){
    if(/^[A-Za-z]{2,}$/.test(words[wi])&&/^[A-Za-z]{2,}$/.test(words[wi+1])){
      var candidate=words[wi]+' '+words[wi+1];
      if(words[wi+2]&&/^[A-Za-z]{2,}$/.test(words[wi+2]))candidate+=' '+words[wi+2];
      // Skip common non-name words
      var low=candidate.toLowerCase();
      if(!/(daily|account|summary|trade|report|custom|futures|clearing|commission|exchange|purchase|commodity|federal|national|statement|page|processed|balance|profit|equity|margin|option|market|value|initial|maintenance|debit|credit|introduced|riviera|gables|florida)/i.test(low)){
        nm3=candidate;break;
      }
    }
  }
  
  var rawName=nm1?nm1[1]:nm2?nm2[1]:nm3;
  console.log('[TradeEdge] Name patterns:', {p1:nm1?nm1[1]:'none',p2:nm2?nm2[1]:'none',p3:nm3||'none',chosen:rawName||'none'});
  if(rawName){
    accountName=rawName.trim().replace(/\s+/g,' ').toLowerCase().replace(/\b\w/g,function(c){return c.toUpperCase();});
  }
  console.log('[TradeEdge] Account name:', accountName);
  const dm=text.match(/(\d{1,2}-[A-Z]{3}-\d{2,4})/i)||text.match(/Account Summary as of\s+(\d{1,2}\/\d{1,2}\/\d{2,4})/i);
  let tradeDate=dm?ampDate(dm[1]):'';
  
  // Parse amounts with DR/CR sign convention (DR=negative, CR=positive)
  function drcr(re){
    const m=text.match(re);if(!m)return 0;
    const v=parseFloat(m[1].replace(/,/g,''))||0;
    return m[2]&&m[2].toUpperCase()==='DR'?-v:v;
  }
  function posVal(re){const m=text.match(re);return m?parseFloat(m[1].replace(/,/g,''))||0:0;}
  
  // Fees
  const fees={exchange:0,nfa:0,clearing:0,cqg:0,commission:0,total:0};
  fees.exchange=posVal(/EXCHANGE\s+(?:USD\s+)?([\d,.]+)\s+DR/i);
  fees.nfa=posVal(/NFA\s+(?:USD\s+)?([\d,.]+)\s+DR/i);
  fees.clearing=posVal(/CLEARING[.\s]+(?:USD\s+)?([\d,.]+)\s+DR/i);
  fees.cqg=posVal(/CQG\s*(?:TRF)?\s+(?:USD\s+)?([\d,.]+)\s+DR/i);
  fees.commission=posVal(/COMMISSION\s+(?:USD\s+)?([\d,.]+)\s+DR/i);
  fees.total=posVal(/TOTAL\s+COMMISSION\s*(?:&|AND)\s*FEES\s+([\d,.]+)\s+DR/i);
  if(!fees.total)fees.total=fees.exchange+fees.nfa+fees.clearing+fees.cqg+fees.commission;
  
  // P&L: "REALIZED PROFIT/LOSS 53.50 DR" → -53.50 (loss)
  const realizedPnl=drcr(/REALIZED\s+PROFIT\/LOSS\s+([\d,.]+)\s+(DR|CR)/i);
  const balance=drcr(/NEW\s+CASH\s+BALANCE\s+([\d,.]+)\s+(DR|CR)/i);
  const netLiq=drcr(/NET\s+LIQUIDATING\s+VALUE\s+([\d,.]+)\s+(DR|CR)/i);
  const cashBalance=drcr(/ACCOUNT\s+CASH\s+BALANCE\s+([\d,.]+)\s+(DR|CR)/i);
  
  // Try to extract oldest balance from "Last 5 values" history
  var oldestBalance=0;
  // Find the Last 5 values section and grab all CR values from it
  var last5Idx=text.search(/Last\s+5\s+values/i);
  if(last5Idx>=0){
    var last5Text=text.substring(last5Idx,last5Idx+500);
    console.log('[TradeEdge] Last 5 values section:', last5Text.substring(0,200));
    var crValues=[];
    var crRe=/([\d,.]+)\s+CR/g;
    var crm;
    while((crm=crRe.exec(last5Text))!==null){
      crValues.push(parseFloat(crm[1].replace(/,/g,''))||0);
    }
    console.log('[TradeEdge] Last 5 CR values:', crValues);
    // First entry = oldest NLV in the window (the pre-period balance for this statement's range)
    if(crValues.length){oldestBalance=crValues[0];}
    console.log('[TradeEdge] Oldest NLV from Last 5:', oldestBalance);
  }
  
  // P&S total: "P&S USD 53.50 DR"
  const psm=text.match(/P\s*&\s*S\s+(?:USD\s+)?([\d,.]+)\s+(DR|CR)/i);
  const psPnl=psm?((psm[2].toUpperCase()==='DR'?-1:1)*parseFloat(psm[1].replace(/,/g,''))):0;
  
  // Average prices
  const avgLongM=text.match(/AVERAGE\s+LONG\s+([\d,.]+)/i);
  const avgShortM=text.match(/AVERAGE\s+SHORT\s+([\d,.]+)/i);
  const avgLong=avgLongM?parseFloat(avgLongM[1].replace(/,/g,'')):0;
  const avgShort=avgShortM?parseFloat(avgShortM[1].replace(/,/g,'')):0;
  
  // Extract symbol from trade lines
  let tradeSym='';
  const symMatch=text.match(/(?:CME|CBOT|NYMEX|COMEX)\s+\d*\s*\d*\s*(\w+)\s+Future/i);
  if(symMatch) tradeSym=nsym(symMatch[1]);
  
  // Build round-trip trade from avg prices + P&S
  const trades=[];
  const usePnl=psPnl||realizedPnl;
  if(avgLong&&avgShort&&tradeSym){
    // Determine trade direction from the P&S result
    // If AVERAGE LONG > AVERAGE SHORT, bought high sold low = short that profited? No.
    // Actually: AVERAGE LONG is the avg buy price, AVERAGE SHORT is the avg sell price
    // If you buy at 24834.50 (LONG) and sell at 24807.75 (SHORT), that's a LONG trade at a loss
    // P&S = (sell - buy) * tick * qty = (24807.75 - 24834.50) * 2 * 1 = -53.50 ✓ matches the PDF
    
    // So: entry = AVERAGE LONG (buy price), exit = AVERAGE SHORT (sell price) for a long
    // But we need to check: who bought first?
    // Look at trade order in the PDF to determine
    
    // For the general case: if P&S is negative and avgLong > avgShort → long trade that lost
    // If P&S is positive and avgShort > avgLong → long trade that won
    // Just use the prices directly
    
    const qty=1; // Default, or extract from TOTAL line
    const qtyMatch=text.match(/TOTAL\s+(\d+)\s+(\d+)/i);
    const totalQty=qtyMatch?Math.max(parseInt(qtyMatch[1])||0,parseInt(qtyMatch[2])||0):1;
    
    // entry=buy price, exit=sell price → side is Long
    trades.push({
      date:tradeDate,time:'',symbol:tradeSym,side:'Long',qty:totalQty,
      entry:avgLong,exit:avgShort,sl:null,tp:null,
      pnl:usePnl,fees:fees.total,netPnl:usePnl-fees.total,
      rr:null,tags:[],checklist:{},mistakes:[],rating:0,
      killzone:'',emotion:'',bias:'',notes:'From AMP statement',chartUrl:'',chartImg:null,
      importedAt:new Date().toISOString(),source:'AMP Statement: '+fileName
    });
  }
  
  console.log('[TradeEdge] AMP PDF result:', {tradeDate,realizedPnl,balance,netLiq,fees,psPnl,avgLong,avgShort,tradeSym,trades:trades.length});
  
  // Store the Last 5 NLV values for balance history memory
  var balanceHistory=[];
  var last5Idx2=text.search(/Last\s+5\s+values/i);
  if(last5Idx2>=0){
    var l5=text.substring(last5Idx2,last5Idx2+500);
    var l5re=/([\d,.]+)\s+CR\s+([\d,.]+|0\.00)\s*(today)?/gi,l5m;
    while((l5m=l5re.exec(l5))!==null){
      balanceHistory.push({nlv:parseFloat(l5m[1].replace(/,/g,''))||0,change:parseFloat(l5m[2].replace(/,/g,''))||0,isToday:!!l5m[3]});
    }
  }
  return{tradeDate,fileName,fees,realizedPnl,balance,netLiq,cashBalance,oldestBalance,balanceHistory,trades,accountName,importedAt:new Date().toISOString()};
}

// ══════════════════════════════════════════════════════════
// AMP STATEMENTS PANEL & IMPORT HISTORY LOG
// ══════════════════════════════════════════════════════════
function renderAMPStatements(){
  const panel=document.getElementById('amp-statements-panel');
  if(!panel)return;
  if(!S.ampStatements||!S.ampStatements.length){panel.style.display='none';return;}
  panel.style.display='block';
  document.getElementById('amp-stmt-count').textContent=`${S.ampStatements.length} statement${S.ampStatements.length>1?'s':''}`;
  const stmts=[...S.ampStatements].sort((a,b)=>new Date(b.tradeDate)-new Date(a.tradeDate));
  const totalPnl=stmts.reduce((a,s)=>a+s.realizedPnl,0);
  const totalFees=stmts.reduce((a,s)=>a+s.fees.total,0);
  const latestBal=stmts[0]?.balance||0;
  const list=document.getElementById('amp-statements-list');
  list.innerHTML=`
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px">
      <div style="background:var(--s2);border-radius:7px;padding:10px;text-align:center">
        <div style="font-family:var(--mono);font-size:.58rem;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:3px">Total P&L</div>
        <div style="font-family:var(--mono);font-size:.9rem;font-weight:600;color:${totalPnl>=0?'var(--green)':'var(--red)'}">${f$(totalPnl)}</div>
      </div>
      <div style="background:var(--s2);border-radius:7px;padding:10px;text-align:center">
        <div style="font-family:var(--mono);font-size:.58rem;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:3px">Total Fees</div>
        <div style="font-family:var(--mono);font-size:.9rem;font-weight:600;color:var(--gold)">${f$(-totalFees)}</div>
      </div>
      <div style="background:var(--s2);border-radius:7px;padding:10px;text-align:center">
        <div style="font-family:var(--mono);font-size:.58rem;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:3px">Balance</div>
        <div style="font-family:var(--mono);font-size:.9rem;font-weight:600;color:var(--green)">${f$(latestBal,false)}</div>
      </div>
      <div style="background:var(--s2);border-radius:7px;padding:10px;text-align:center">
        <div style="font-family:var(--mono);font-size:.58rem;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:3px">Statements</div>
        <div style="font-family:var(--mono);font-size:.9rem;font-weight:600;color:var(--t1)">${stmts.length}</div>
      </div>
    </div>
    <div style="overflow-x:auto"><table><thead><tr>
      <th>Date</th><th>File</th><th>P&L</th><th>Fees</th><th>Balance</th><th>Trades</th>
    </tr></thead><tbody>${stmts.map(s=>`<tr>
      <td class="mono">${s.tradeDate||'—'}</td>
      <td style="font-size:.7rem;max-width:120px;overflow:hidden;text-overflow:ellipsis" title="${escapeHtml(s.fileName)}">${escapeHtml(s.fileName)}</td>
      <td class="mono" style="color:${s.realizedPnl>=0?'var(--green)':'var(--red)'}">${f$(s.realizedPnl)}</td>
      <td class="mono" style="color:var(--gold)">${f$(-s.fees.total)}</td>
      <td class="mono">${s.balance?f$(s.balance,false):'—'}</td>
      <td class="mono">${s.trades?.length||0}</td>
    </tr>`).join('')}</tbody></table></div>`;
  // Update Settings AMP display
  const latest=stmts[0];
  const ampEl=document.getElementById('amp-fees-display');
  if(ampEl&&latest) ampEl.innerHTML=`
    <p style="font-size:.7rem;color:var(--accent);margin-bottom:8px;font-family:var(--mono)">Latest: ${latest.tradeDate}</p>
    <div class="stat-row"><span class="stat-k">Exchange</span><span class="stat-v" style="color:var(--gold)">$${latest.fees.exchange.toFixed(2)}</span></div>
    <div class="stat-row"><span class="stat-k">NFA</span><span class="stat-v" style="color:var(--gold)">$${latest.fees.nfa.toFixed(2)}</span></div>
    <div class="stat-row"><span class="stat-k">Clearing</span><span class="stat-v" style="color:var(--gold)">$${latest.fees.clearing.toFixed(2)}</span></div>
    <div class="stat-row"><span class="stat-k">CQG</span><span class="stat-v" style="color:var(--gold)">$${latest.fees.cqg.toFixed(2)}</span></div>
    <div class="stat-row"><span class="stat-k">Commission</span><span class="stat-v" style="color:var(--gold)">$${latest.fees.commission.toFixed(2)}</span></div>
    <div class="stat-row"><span class="stat-k"><strong>Total RT</strong></span><span class="stat-v" style="color:var(--red);font-weight:600">$${latest.fees.total.toFixed(2)}</span></div>
    <div class="stat-row"><span class="stat-k">Balance</span><span class="stat-v" style="color:var(--green)">$${(latest.balance||0).toFixed(2)}</span></div>
    <div style="margin-top:8px;font-size:.68rem;color:var(--t3)">${S.ampStatements.length} statements on file</div>`;
}

function renderImportLog(){
  const logEl=document.getElementById('import-log-list');
  const countEl=document.getElementById('import-log-count');
  if(!logEl)return;
  if(!S.importLog||!S.importLog.length){
    logEl.innerHTML='<p style="font-size:.72rem;color:var(--t3);padding:8px 0">No imports yet.</p>';
    if(countEl)countEl.textContent='';return;
  }
  if(countEl)countEl.textContent=`${S.importLog.length} file${S.importLog.length>1?'s':''}`;
  const logs=[...S.importLog].reverse();
  logEl.innerHTML=`<div style="overflow-x:auto"><table>
    <thead><tr><th>When</th><th>Type</th><th>File</th><th>Details</th></tr></thead>
    <tbody>${logs.map(l=>{
      const d=new Date(l.date);
      const ds=d.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' '+d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
      let det='';
      if(l.type==='CSV') det=`${l.tradesAdded||0} added, ${l.tradesSkipped||0} skipped`;
      else if(l.type==='AMP PDF') det=`P&L: ${f$(l.realizedPnl||0)} · Fees: ${f$(-(l.totalFees||0))}`;
      else if(l.type==='Cancelled CSV') det=`${l.ordersLoaded||0} orders`;
      return`<tr>
        <td class="mono" style="font-size:.7rem">${ds}</td>
        <td><span class="bdg ${l.type==='AMP PDF'?'bdg-neutral':'bdg-long'}" style="font-size:.58rem">${l.type}</span></td>
        <td style="font-size:.72rem;max-width:160px;overflow:hidden;text-overflow:ellipsis" title="${escapeHtml(l.fileName)}">${escapeHtml(l.fileName)||'—'}</td>
        <td style="font-size:.7rem">${det}</td>
      </tr>`;}).join('')}
    </tbody></table></div>`;
}

// Cancelled CSV for SL/TP
function importCancelled(e){
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const rows=parseCSV(ev.target.result);
    S.pendingCancelled=rows;
    document.getElementById('ic-cancelled-status').textContent=`✓ ${rows.length} cancelled orders`;
    document.getElementById('ic-cancelled-status').style.color='var(--green)';
    document.getElementById('ic-cancelled').classList.add('has-data');
    if(!S.importLog)S.importLog=[];
    S.importLog.push({type:'Cancelled CSV',fileName:file.name,ordersLoaded:rows.length,date:new Date().toISOString()});
    save();if(typeof renderImportLog==='function')renderImportLog();
    toast(`${rows.length} cancelled orders loaded`,'ok');
  };reader.readAsText(file);
}

// Drag & drop
function doDrag(e){e.preventDefault();document.getElementById('drop-zone').classList.add('drag');}
function doDragLeave(){document.getElementById('drop-zone').classList.remove('drag');}
function doDrop(e){
  e.preventDefault();document.getElementById('drop-zone').classList.remove('drag');
  const files=[...e.dataTransfer.files];
  if(files.length) routeFiles(files);
}

// Smart import — auto-detect file type from name/extension/content
function smartImport(e){
  const files=[...e.target.files];
  if(!files.length)return;
  // Reset input so same files can be re-imported
  e.target.value='';
  routeFiles(files);
}

function classifyFile(file){
  const name=file.name.toLowerCase();
  const ext=name.split('.').pop();
  
  // PDFs → always AMP statements
  if(ext==='pdf') return 'amp_pdf';
  
  // CSVs → check filename patterns
  if(ext==='csv'||ext==='txt'){
    if(name.includes('cancelled')||name.includes('cancel')) return 'cancelled';
    if(name.includes('filled')||name.includes('history')||name.includes('order')) return 'filled';
    // If no clear pattern, we'll peek at content to decide
    return 'csv_unknown';
  }
  
  return 'unknown';
}

function routeFiles(files){
  const routed={filled:[],cancelled:[],amp_pdf:[],unknown:[]};
  const routeLog=[];
  
  // First pass: classify by filename
  const csvUnknown=[];
  files.forEach(f=>{
    const type=classifyFile(f);
    if(type==='csv_unknown'){
      csvUnknown.push(f);
    } else if(type==='amp_pdf'){
      routed.amp_pdf.push(f);
      routeLog.push({name:f.name,type:'AMP Statement',icon:'📄',color:'var(--gold)'});
    } else if(type==='cancelled'){
      routed.cancelled.push(f);
      routeLog.push({name:f.name,type:'SL/TP Data (cancelled orders)',icon:'🎯',color:'var(--accent2)'});
    } else if(type==='filled'){
      routed.filled.push(f);
      routeLog.push({name:f.name,type:'Filled Orders',icon:'📊',color:'var(--green)'});
    } else {
      routed.unknown.push(f);
      routeLog.push({name:f.name,type:'Unknown (skipped)',icon:'❓',color:'var(--t3)'});
    }
  });
  
  // Second pass: peek at CSV headers to classify unknowns
  let pendingCSV=csvUnknown.length;
  if(!pendingCSV) processRouted(routed,routeLog);
  
  csvUnknown.forEach(f=>{
    const reader=new FileReader();
    reader.onload=ev=>{
      const firstLine=(ev.target.result||'').split('\n')[0].toLowerCase();
      if(firstLine.includes('cancel')){
        routed.cancelled.push(f);
        routeLog.push({name:f.name,type:'Cancelled Orders (auto-detected)',icon:'❌',color:'var(--red)'});
      } else if(firstLine.includes('fill')||firstLine.includes('side')||firstLine.includes('price')){
        routed.filled.push(f);
        routeLog.push({name:f.name,type:'Filled Orders (auto-detected)',icon:'📊',color:'var(--green)'});
      } else {
        routed.filled.push(f); // Default to filled
        routeLog.push({name:f.name,type:'Filled Orders (default)',icon:'📊',color:'var(--accent)'});
      }
      pendingCSV--;
      if(!pendingCSV) processRouted(routed,routeLog);
    };
    reader.readAsText(f.slice(0,500)); // Only read first 500 bytes for header peek
  });
}

function processRouted(routed,routeLog){
  // Show routing log
  const logEl=document.getElementById('import-route-log');
  const listEl=document.getElementById('import-route-list');
  if(routeLog.length>1||routed.amp_pdf.length||routed.cancelled.length){
    logEl.style.display='block';
    listEl.innerHTML=routeLog.map(r=>
      `<div style="padding:4px 0;display:flex;align-items:center;gap:8px">
        <span>${r.icon}</span>
        <span style="color:var(--t2);flex:1;overflow:hidden;text-overflow:ellipsis">${escapeHtml(r.name)}</span>
        <span style="color:${r.color};font-size:.65rem;white-space:nowrap">${r.type}</span>
      </div>`).join('');
  }
  
  // Process each category
  if(routed.filled.length){
    // Use the first filled CSV for trade import
    const synth={target:{files:routed.filled}};
    lastImportFileName=routed.filled.map(f=>f.name).join(', ');
    const file=routed.filled[0];
    const reader=new FileReader();
    reader.onload=ev=>{
      const text=ev.target.result;
      const rows=parseCSV(text);
      if(!rows.length){toast('Could not parse CSV','err');return;}
      pendingRows=rows;
      const headers=Object.keys(rows[0]);
      const hl=headers.map(h=>h.toLowerCase());
      console.log('[TradeEdge] CSV Headers:',headers);
      
      const hasFillPrice=hl.some(h=>h.includes('fill price'));
      const hasPnL=hl.some(h=>h.match(/p[&\/]?l|profit|result/i));
      const hasEntryExit=hl.some(h=>h.includes('entry'));
      const hasClosingTime=hl.some(h=>h.includes('closing time')||h.includes('status time'));
      
      if(hasEntryExit){importMode='account_history';pendingTrades=rows.map(r=>mapRow(r)).filter(Boolean);}
      else if(hasFillPrice||hasClosingTime){importMode='history_fills';pendingTrades=pairFills(rows);}
      else if(hasPnL){importMode='generic_pnl';pendingTrades=rows.map(r=>mapRow(r)).filter(Boolean);}
      else{importMode='generic';pendingTrades=rows.map(r=>mapRow(r)).filter(Boolean);}
      
      console.log('[TradeEdge] Mode:',importMode,'| Trades:',pendingTrades.length);
      document.getElementById('ic-history-status').textContent=`✓ ${rows.length} rows → ${pendingTrades.length} trades`;
      document.getElementById('ic-history-status').style.color='var(--green)';
      document.getElementById('ic-history').classList.add('has-data');
      // AUTO-CONFIRM: import immediately without requiring manual confirm
      if(pendingTrades.length){
        let added=0,skipped=0;
        pendingTrades.forEach(t=>{
          if(!t)return;
          const k=`${t.date}|${t.time}|${t.symbol}|${t.side}|${t.entry||''}|${t.pnl||''}`;
          if(S.trades.some(e=>`${e.date}|${e.time}|${e.symbol}|${e.side}|${e.entry||''}|${e.pnl||''}`===k)){skipped++;return;}
          S.trades.push(t);added++;
        });
        if(!S.importLog)S.importLog=[];
        S.importLog.push({type:'CSV',mode:importMode,fileName:lastImportFileName||'Unknown',tradesAdded:added,tradesSkipped:skipped,date:new Date().toISOString()});
        if(S.pendingCancelled&&S.pendingCancelled.length) reconstructSLTP();
        save();
        if(typeof renderImportLog==='function')renderImportLog();
        updateSidebar();
        toast(`✓ Auto-imported ${added} trades (${skipped} duplicates skipped)`,'ok');
        console.log('[TradeEdge] Auto-import:',added,'added,',skipped,'skipped');
      } else {
        toast('No trades found in CSV','err');
      }
    };
    reader.readAsText(file);
  }
  
  if(routed.cancelled.length){
    const file=routed.cancelled[0];
    const reader=new FileReader();
    reader.onload=ev=>{
      const rows=parseCSV(ev.target.result);
      S.pendingCancelled=rows;
      document.getElementById('ic-cancelled-status').textContent=`✓ ${rows.length} cancelled orders`;
      document.getElementById('ic-cancelled-status').style.color='var(--green)';
      document.getElementById('ic-cancelled').classList.add('has-data');
      if(!S.importLog)S.importLog=[];
      S.importLog.push({type:'Cancelled CSV',fileName:file.name,ordersLoaded:rows.length,date:new Date().toISOString()});
      // Reconstruct SL/TP — delay slightly to ensure filled trades are processed first
      setTimeout(()=>{
        if(S.trades.length) reconstructSLTP();
        save();if(typeof renderImportLog==='function')renderImportLog();
      },500);
      toast(`${rows.length} cancelled orders loaded → SL/TP reconstruction`,'ok');
    };
    reader.readAsText(file);
  }
  
  if(routed.amp_pdf.length){
    importPDFs({target:{files:routed.amp_pdf}});
  }
}

// SETTINGS
// ══════════════════════════════════════════════════════════
function renderSettings(){
  const syms=['MNQ','MES','NQ','ES','CL','GC'];
  document.getElementById('fee-settings').innerHTML=syms.map(s=>`
    <div class="fg" style="margin-bottom:10px">
      <label>${s} — Fee per contract per side ($)</label>
      <input type="number" id="fee-${s}" step=".01" value="${S.feeRates[s]||2.25}" placeholder="e.g. 0.90">
    </div>`).join('');
  if(S.ampStatements&&S.ampStatements.length){renderAMPStatements();}
  else if(S.ampFees&&S.ampFees.total){
    document.getElementById('amp-fees-display').innerHTML=`
      <div class="stat-row"><span class="stat-k">Total RT</span><span class="stat-v" style="color:var(--red)">$${S.ampFees.total.toFixed(2)}</span></div>`;
  }
}
function saveFees(){
  ['MNQ','MES','NQ','ES','CL','GC'].forEach(s=>{
    const v=parseFloat(document.getElementById('fee-'+s)?.value);
    if(!isNaN(v))S.feeRates[s]=v;
  });
  save();toast('Fee rates saved ✓','ok');
}

// ══════════════════════════════════════════════════════════
// EXPORT / BACKUP
// ══════════════════════════════════════════════════════════
function exportCSV(){
  if(!S.trades.length){toast('No trades to export','err');return;}
  const keys=['date','time','symbol','side','qty','entry','exit','sl','tp','pnl','fees','netPnl','rr','killzone','emotion','rating','notes','chartUrl'];
  const csv=[keys.join(','),...S.trades.map(t=>keys.map(k=>JSON.stringify(t[k]??'')).join(','))].join('\n');
  dl(csv,'tradeedge-trades.csv','text/csv');
}
function exportAllCSV(){exportCSV();}
function exportJSON(){
  dl(JSON.stringify({trades:S.trades,journal:S.journal,feeRates:S.feeRates,ampStatements:S.ampStatements||[],importLog:S.importLog||[]},null,2),'tradeedge-backup.json','application/json');
}
function importJSON(){
  const inp=document.createElement('input');inp.type='file';inp.accept='.json';
  inp.onchange=e=>{
    const f=e.target.files[0];if(!f)return;
    const r=new FileReader();r.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(data.trades)S.trades=[...S.trades,...data.trades];
        if(data.journal)S.journal=[...S.journal,...data.journal];
        if(data.feeRates)S.feeRates={...S.feeRates,...data.feeRates};
        if(data.ampStatements){if(!S.ampStatements)S.ampStatements=[];S.ampStatements.push(...data.ampStatements);}
        if(data.importLog){if(!S.importLog)S.importLog=[];S.importLog.push(...data.importLog);}
        save();toast(`✓ Restored ${data.trades?.length||0} trades`,'ok');
        updateSidebar();go('dashboard');
      }catch(err){toast('Invalid backup file','err');}
    };r.readAsText(f);
  };inp.click();
}
let clearPending=false;
function clearAll(){
  if(!clearPending){
    clearPending=true;
    const btn=event.target;
    btn.textContent='⚠ Click Again to Confirm Delete';
    btn.style.background='var(--red)';btn.style.color='#fff';
    setTimeout(()=>{clearPending=false;btn.textContent='Clear All Data';btn.style.background='';btn.style.color='';},4000);
    return;
  }
  clearPending=false;
  // Nuclear clear — wipe everything
  S.trades=[];S.journal=[];S.ampStatements=[];S.importLog=[];S.ampFees=null;
  S.accountName='';S.startingBalance=0;S._ampMigrated=true;S._ampMigV2=true;
  S.feeRates={MNQ:0.90,MES:0.90,NQ:2.25,ES:2.25};
  S.pendingCancelled=[];
  if(typeof cancelledOrders!=='undefined')cancelledOrders=[];
  _lastChipBalance=-1; // Force 3D chip re-render
  try{localStorage.removeItem(SK);}catch(e){}
  save();
  // Reset file input
  var fi=document.getElementById('fi-smart');if(fi)fi.value='';
  // Reset import card statuses
  var hs=document.getElementById('ic-history-status');if(hs){hs.textContent='No file loaded';hs.style.color='var(--t3)';}
  var cs=document.getElementById('ic-cancelled-status');if(cs){cs.textContent='No file loaded';cs.style.color='var(--t3)';}
  var ps=document.getElementById('ic-pdf-status');if(ps){ps.textContent='No files loaded';ps.style.color='var(--t3)';}
  // Reset import preview & AMP panel
  var ip=document.getElementById('import-preview');if(ip)ip.style.display='none';
  var ap=document.getElementById('amp-statements-panel');if(ap)ap.style.display='none';
  var rl=document.getElementById('import-route-log');if(rl)rl.style.display='none';
  // Reset AMP fees display
  var af=document.getElementById('amp-fees-display');if(af)af.innerHTML='<p style="font-size:.74rem;color:var(--t3)">Import an AMP PDF statement to see your exact fee breakdown here.</p>';
  // Re-render current active view (covers settings, trades, journal, analytics, etc.)
  var activeNav=document.querySelector('.ni.active');
  var curView=activeNav?activeNav.dataset.view:'dashboard';
  go(curView);
  toast('✓ All data cleared successfully','ok');
  // Reset the button
  const btn=event.target;
  btn.textContent='Clear All Data';btn.style.background='';btn.style.color='';
}
function dl(content,name,type){
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type}));a.download=name;a.click();
}

// ══════════════════════════════════════════════════════════
// IMAGE PREVIEW
// ══════════════════════════════════════════════════════════
function previewImg(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{
    document.getElementById('img-preview').src=ev.target.result;
    document.getElementById('img-preview-link').href=ev.target.result;
    document.getElementById('img-preview-wrap').style.display='block';
  };
  r.readAsDataURL(file);
}
function previewJImg(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{
    document.getElementById('j-img-preview').src=ev.target.result;
    document.getElementById('j-img-preview-link').href=ev.target.result;
    document.getElementById('j-img-preview-wrap').style.display='block';
  };
  r.readAsDataURL(file);
}

// ══════════════════════════════════════════════════════════
// MODAL HELPERS
// ══════════════════════════════════════════════════════════
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.overlay').forEach(o=>{
  o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');});
});

// ══════════════════════════════════════════════════════════
// TOAST
// ══════════════════════════════════════════════════════════
function toast(msg,type=''){
  const el=document.getElementById('toast');
  el.textContent=msg;el.className='toast '+(type||'');
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),2800);
}

// ══════════════════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════════════════
renderTagSuggestions();
renderDash();
updateSidebar();
// Deferred 3D chip init — ensure layout is settled after splash
setTimeout(function(){_lastChipBalance=-1;updateSidebar();},2800);



// Auto open pre-session between 7:30-9:30am ET on weekdays
(function(){
  const now=new Date();
  const et=new Date(now.toLocaleString('en-US',{timeZone:'America/New_York'}));
  const h=et.getHours(),m=et.getMinutes(),dow=et.getDay();
  const isWeekday=dow>=1&&dow<=5;
  const isPreSession=(h===7&&m>=30)||(h===8)||(h===9&&m<30);
  if(isWeekday&&isPreSession&&S.journal.findIndex(j=>j.date===et.toISOString().split('T')[0])<0){
    setTimeout(openPreSession,1200);
  }
})();

// ══════════════════════════════════════════════════════════
// HELP & TUTORIAL
// ══════════════════════════════════════════════════════════
const pageTitlesExt = {help:'Help & Tutorial'};
const originalPageTitles = {dashboard:'Dashboard',trades:'Trade Log',journal:'Journal',analytics:'Performance Analytics',ict:'ICT Analytics',weekly:'Weekly Report',import:'Import Data',settings:'Settings',help:'Help & Tutorial'};

function renderHelp() {
  const el = document.getElementById('view-help');
  el.innerHTML = `
    <div class="help-tabs">
      <div class="htab on" onclick="showHelpTab('getting-started',this)">🚀 Getting Started</div>
      <div class="htab" onclick="showHelpTab('tradingview-export',this)">📊 TV Export Guide</div>
      <div class="htab" onclick="showHelpTab('amp-pdf',this)">📄 AMP Statement</div>
      <div class="htab" onclick="showHelpTab('metrics',this)">📈 Metrics Explained</div>
      <div class="htab" onclick="showHelpTab('ict-glossary',this)">⭐ ICT Glossary</div>
      <div class="htab" onclick="showHelpTab('killzones',this)">🕐 Killzones</div>
      <div class="htab" onclick="showHelpTab('session',this)">🎯 Session Companion</div>
      <div class="htab" onclick="showHelpTab('shortcuts',this)">⌨️ Shortcuts</div>
    </div>

    <!-- GETTING STARTED -->
    <div class="help-section on" id="hs-getting-started">
      <div class="hcard">
        <div class="hcard-title">Welcome to TradeEdge ICT</div>
        <p>TradeEdge is your personal trading journal built specifically for <strong>ICT / Smart Money Concepts</strong> traders using <strong>AMP Futures + TradingView</strong> on Mac. Everything stays on your computer — no accounts, no subscriptions, no cloud.</p>
        <div class="tip-box"><strong>💡 First time here?</strong> Click "Start Tour" below for an interactive walkthrough of the entire app, or follow the steps below to get set up in under 5 minutes.</div>
        <button class="btn btn-accent" onclick="startTour()" style="margin-bottom:18px;margin-top:4px">▶ Start Interactive Tour</button>
      </div>
      <div class="hcard">
        <div class="hcard-title">5-Minute Setup Checklist</div>
        <div class="hstep">
          <div class="hstep-n">1</div>
          <div class="hstep-body">
            <div class="hstep-title">Set your fee rates</div>
            <div class="hstep-desc">Go to <strong>Settings</strong> → enter your AMP fee per contract per side. For MNQ: <strong>$0.90/side</strong> (based on your statement: $0.70 exchange + $0.04 NFA + $0.26 clearing + $0.20 CQG + $0.60 commission ÷ 2 sides). The app will auto-calculate fees on every trade.</div>
          </div>
        </div>
        <div class="hstep">
          <div class="hstep-n">2</div>
          <div class="hstep-body">
            <div class="hstep-title">Export your TradingView History CSV</div>
            <div class="hstep-desc">In TradingView → Trading Panel at bottom → click <strong>⋯ menu</strong> → <strong>Export data…</strong> → export the History tab. Then go to <strong>Import Data</strong> and drop the file in.</div>
          </div>
        </div>
        <div class="hstep">
          <div class="hstep-n">3</div>
          <div class="hstep-body">
            <div class="hstep-title">Export your Cancelled orders CSV</div>
            <div class="hstep-desc">Same process — export the <strong>Cancelled tab</strong> from TradingView. This lets the app estimate your stop loss and take profit levels for each trade.</div>
          </div>
        </div>
        <div class="hstep">
          <div class="hstep-n">4</div>
          <div class="hstep-body">
            <div class="hstep-title">Upload your AMP daily PDF</div>
            <div class="hstep-desc">AMP emails you a daily statement PDF. Upload it in <strong>Import Data → AMP Statement</strong>. The app extracts your exact fee breakdown automatically.</div>
          </div>
        </div>
        <div class="hstep">
          <div class="hstep-n">5</div>
          <div class="hstep-body">
            <div class="hstep-title">Click "Start Session" each morning</div>
            <div class="hstep-desc">Every trading morning, hit the <strong>Start Session</strong> button in the top bar. It will prompt you for sleep, energy, coffee, HTF bias, and your plan for the day — before a single trade is placed.</div>
          </div>
        </div>
        <div class="hstep">
          <div class="hstep-n">6</div>
          <div class="hstep-body">
            <div class="hstep-title">Backup weekly</div>
            <div class="hstep-desc">Go to <strong>Settings → Export Backup (JSON)</strong> once a week. Save it to iCloud Drive. This is the only way to protect your data if you clear your browser cache.</div>
          </div>
        </div>
        <div class="warn-box"><strong>⚠️ Important:</strong> Your data lives in this browser only. Never clear Safari/Chrome browser data without exporting a backup first. See the Settings page for backup options.</div>
      </div>
    </div>

    <!-- TRADINGVIEW EXPORT -->
    <div class="help-section" id="hs-tradingview-export">
      <div class="hcard">
        <div class="hcard-title">How to Export from TradingView + AMP</div>
        <p>TradingView lets you export three useful data sets from your AMP broker connection. Do this <strong>daily or at minimum weekly</strong> — the app never overwrites existing data, it only adds new trades.</p>
        <div class="warn-box"><strong>⚠️ Limitation:</strong> TradingView's broker export only covers the last 7 days of history. Export regularly so you don't lose data.</div>
      </div>
      <div class="hcard">
        <div class="hcard-title">Step-by-Step: History CSV (Filled Orders)</div>
        <div class="hstep">
          <div class="hstep-n">1</div>
          <div class="hstep-body"><div class="hstep-title">Open TradingView in your browser</div><div class="hstep-desc">Make sure you're logged in and connected to AMP Futures as your broker.</div></div>
        </div>
        <div class="hstep">
          <div class="hstep-n">2</div>
          <div class="hstep-body"><div class="hstep-title">Open the Trading Panel</div><div class="hstep-desc">At the bottom of TradingView, click on the <strong>Trading Panel tab</strong>. You should see your AMP account, open positions, and order tabs.</div></div>
        </div>
        <div class="hstep">
          <div class="hstep-n">3</div>
          <div class="hstep-body"><div class="hstep-title">Click the History tab</div><div class="hstep-desc">In the Trading Panel, click the <strong>History</strong> tab — this shows all your filled orders.</div></div>
        </div>
        <div class="hstep">
          <div class="hstep-n">4</div>
          <div class="hstep-body"><div class="hstep-title">Export the data</div><div class="hstep-desc">Click the <strong>⋯ (three dots) menu</strong> in the top right of the panel → click <strong>"Export data…"</strong> → save the CSV file to your Downloads folder.</div></div>
        </div>
        <div class="hstep">
          <div class="hstep-n">5</div>
          <div class="hstep-body"><div class="hstep-title">Import into TradeEdge</div><div class="hstep-desc">Go to <strong>Import Data</strong> in this app → drag all CSV files into the drop zone → trades are <strong>auto-imported instantly</strong>.</div></div>
        </div>
        <div class="img-mock">📊 TradingView → Trading Panel → History Tab → ⋯ → Export data…</div>
      </div>
      <div class="hcard">
        <div class="hcard-title">Step-by-Step: Cancelled CSV (SL/TP Reconstruction)</div>
        <p>The Cancelled tab contains your stop loss and take profit orders that were auto-cancelled when the other bracket order filled. This is how TradeEdge reconstructs your planned SL and TP levels.</p>
        <div class="hstep">
          <div class="hstep-n">1</div>
          <div class="hstep-body"><div class="hstep-title">Click the Cancelled tab</div><div class="hstep-desc">In the Trading Panel, find and click the <strong>Cancelled</strong> tab.</div></div>
        </div>
        <div class="hstep">
          <div class="hstep-n">2</div>
          <div class="hstep-body"><div class="hstep-title">Export and import</div><div class="hstep-desc">Same process: <strong>⋯ → Export data…</strong> → in TradeEdge, upload to the <strong>TV Cancelled</strong> card on the Import page.</div></div>
        </div>
        <div class="tip-box"><strong>💡 How SL/TP reconstruction works:</strong> When you place a bracket order (entry + SL + TP), TradingView creates three orders. When price hits your TP, the SL gets auto-cancelled. TradeEdge matches the cancelled SL/TP orders to your fills by timestamp and symbol to estimate your planned levels.</div>
      </div>
    </div>

    <!-- AMP PDF -->
    <div class="help-section" id="hs-amp-pdf">
      <div class="hcard">
        <div class="hcard-title">Your AMP Daily Statement PDF</div>
        <p>AMP Global Clearing emails you a daily statement PDF after every trading day. This PDF contains your <strong>exact fee breakdown</strong> which is more precise than any estimate.</p>
      </div>
      <div class="hcard">
        <div class="hcard-title">What's in Your AMP Statement</div>
        <p>Based on your uploaded statement (Feb 19, 2026 — MNQ trade), here's exactly what the app extracts:</p>
        <div class="metric-explain">
          <div class="me-card"><div class="me-name">Exchange Fee</div><div class="me-def">CME Group exchange fee per contract</div><div class="me-eg">Your rate: $0.70</div></div>
          <div class="me-card"><div class="me-name">NFA Fee</div><div class="me-def">National Futures Association regulatory fee</div><div class="me-eg">Your rate: $0.04</div></div>
          <div class="me-card"><div class="me-name">Clearing Fee</div><div class="me-def">Trade clearing and settlement fee</div><div class="me-eg">Your rate: $0.26</div></div>
          <div class="me-card"><div class="me-name">CQG TRF</div><div class="me-def">CQG platform transaction fee</div><div class="me-eg">Your rate: $0.20</div></div>
          <div class="me-card"><div class="me-name">Commission</div><div class="me-def">AMP broker commission</div><div class="me-eg">Your rate: $0.60</div></div>
          <div class="me-card" style="border-color:rgba(255,61,90,.2)"><div class="me-name" style="color:var(--red)">Total (Round Trip)</div><div class="me-def">All fees for one complete trade</div><div class="me-eg" style="color:var(--red)">Your total: $1.80</div></div>
        </div>
      </div>
      <div class="hcard">
        <div class="hcard-title">How to Get Your Daily PDF</div>
        <div class="hstep">
          <div class="hstep-n">1</div>
          <div class="hstep-body"><div class="hstep-title">Check your email</div><div class="hstep-desc">AMP sends the statement to the email on your account, usually by <strong>6–8am ET</strong> the following morning after each trading day.</div></div>
        </div>
        <div class="hstep">
          <div class="hstep-n">2</div>
          <div class="hstep-body"><div class="hstep-title">Save the PDF</div><div class="hstep-desc">The email subject is usually <strong>"Daily Statement — [Date]"</strong>. Download the attached PDF.</div></div>
        </div>
        <div class="hstep">
          <div class="hstep-n">3</div>
          <div class="hstep-body"><div class="hstep-title">Upload to TradeEdge</div><div class="hstep-desc">Go to <strong>Import Data → AMP Statement</strong> card → click it → select your PDF. The app parses fee rates and account balance automatically.</div></div>
        </div>
        <div class="tip-box"><strong>💡 Tip:</strong> You only need to upload the PDF once unless your AMP fee tier changes. After the first upload, TradeEdge remembers your fee rates and calculates them automatically on every future trade.</div>
      </div>
    </div>

    <!-- METRICS -->
    <div class="help-section" id="hs-metrics">
      <div class="hcard">
        <div class="hcard-title">Every Metric Explained</div>
        <p>These are the same metrics used by professional trading journals like Tradezella. Understanding each one is key to improving as a trader.</p>
      </div>
      <div class="metric-explain">
        <div class="me-card">
          <div class="me-name">NET P&L</div>
          <div class="me-def">Your total profit or loss after all fees and commissions. This is the only number that actually hits your account.</div>
          <div class="me-eg">Formula: Gross P&L − Total Fees</div>
        </div>
        <div class="me-card">
          <div class="me-name">WIN RATE</div>
          <div class="me-def">Percentage of trades that closed profitably. A high win rate alone doesn't mean profitability — it must be paired with good R:R.</div>
          <div class="me-eg">Formula: Winners ÷ Total Trades × 100</div>
        </div>
        <div class="me-card">
          <div class="me-name">PROFIT FACTOR</div>
          <div class="me-def">Ratio of gross profits to gross losses. Above 1.0 means profitable. Above 1.5 is solid. Above 2.0 is excellent. ICT traders typically target 1.5+.</div>
          <div class="me-eg">Formula: Gross Wins ÷ Gross Losses</div>
        </div>
        <div class="me-card">
          <div class="me-name">EXPECTANCY</div>
          <div class="me-def">The average dollar amount you can expect to make (or lose) per trade over time. This is arguably the most important metric — it tells you if your edge is real.</div>
          <div class="me-eg">Formula: (Win% × Avg Win) − (Loss% × Avg Loss)</div>
        </div>
        <div class="me-card">
          <div class="me-name">AVG WINNER</div>
          <div class="me-def">Average dollar profit on winning trades. You want this to be meaningfully larger than your Avg Loser to maintain a positive edge even with a lower win rate.</div>
          <div class="me-eg">Target: At least 1.5× your Avg Loser</div>
        </div>
        <div class="me-card">
          <div class="me-name">AVG LOSER</div>
          <div class="me-def">Average dollar loss on losing trades. If this is growing over time, you may be moving your stop loss — one of the most dangerous habits in trading.</div>
          <div class="me-eg">Watch: Is this consistent or creeping up?</div>
        </div>
        <div class="me-card">
          <div class="me-name">AVG R:R</div>
          <div class="me-def">Average risk-to-reward ratio achieved across all trades. ICT methodology targets minimum 2:1 or 3:1. This is calculated from your SL and TP prices.</div>
          <div class="me-eg">Target: 2.0R or higher per trade</div>
        </div>
        <div class="me-card">
          <div class="me-name">MAX DRAWDOWN</div>
          <div class="me-def">The largest peak-to-trough decline in your account equity. This measures your worst losing streak period. Keep this below 10% of your account.</div>
          <div class="me-eg">Warning: If growing, reduce position size</div>
        </div>
        <div class="me-card">
          <div class="me-name">WIN STREAK</div>
          <div class="me-def">Your longest consecutive winning run. Useful for identifying when your edge is working best — cross-reference with market conditions and killzones.</div>
          <div class="me-eg">Tip: What setup was active during streaks?</div>
        </div>
        <div class="me-card">
          <div class="me-name">LOSS STREAK</div>
          <div class="me-def">Your longest consecutive losing run. If this exceeds 3–4 trades, consider stopping for the day. Revenge trading typically begins at loss streak 2–3.</div>
          <div class="me-eg">Rule: Stop trading after 3 consecutive losses</div>
        </div>
        <div class="me-card">
          <div class="me-name">PSYCHOLOGICAL SCORE</div>
          <div class="me-def">TradeEdge's proprietary score (1–10) calculated from your sleep, energy, emotional state, and mistake patterns. Low scores correlate with losing sessions.</div>
          <div class="me-eg">Formula: Sleep + Energy + Discipline − Mistakes</div>
        </div>
        <div class="me-card">
          <div class="me-name">TOTAL FEES</div>
          <div class="me-def">All commissions and fees paid to AMP, CME, NFA, and CQG. For MNQ: $1.80 per round trip. Track this — it's a real drag on performance at scale.</div>
          <div class="me-eg">MNQ: $1.80 · MES: ~$1.80 · NQ: ~$4.50</div>
        </div>
      </div>
    </div>

    <!-- ICT GLOSSARY -->
    <div class="help-section" id="hs-ict-glossary">
      <div class="hcard">
        <div class="hcard-title">ICT Setup Tags — Glossary</div>
        <p>These are the pre-loaded ICT / Smart Money Concept setup tags in TradeEdge. Tag every trade with the primary concept used so you can track which setups are actually profitable for you.</p>
      </div>
      <div class="ict-grid">
        <div class="ict-card">
          <div class="ict-name">FVG — Fair Value Gap</div>
          <div class="ict-def">A 3-candle imbalance where the high of candle 1 and the low of candle 3 don't overlap, leaving an inefficiency. Price typically returns to fill this gap. ICT's most fundamental concept.</div>
        </div>
        <div class="ict-card">
          <div class="ict-name">Order Block (OB)</div>
          <div class="ict-def">The last up/down candle before a significant move in the opposite direction. Represents institutional order flow. Used as key support/resistance levels for entries.</div>
        </div>
        <div class="ict-card">
          <div class="ict-name">Breaker Block</div>
          <div class="ict-def">A failed Order Block that price has broken through. When price returns to this area, the OB "breaks" and flips — bullish OB becomes bearish resistance and vice versa.</div>
        </div>
        <div class="ict-card">
          <div class="ict-name">Liquidity Sweep</div>
          <div class="ict-def">Price engineered to take out stops (buy-side or sell-side liquidity) before reversing. ICT refers to this as "stop hunts." The sweep itself is often the entry signal.</div>
        </div>
        <div class="ict-card">
          <div class="ict-name">OTE — Optimal Trade Entry</div>
          <div class="ict-def">The 62–79% Fibonacci retracement zone of a swing move. ICT's preferred entry zone. Combining OTE with an OB or FVG gives high-probability entries.</div>
        </div>
        <div class="ict-card">
          <div class="ict-name">MSS — Market Structure Shift</div>
          <div class="ict-def">When price breaks a key swing high/low on the LTF, signaling a potential change in direction. Used as confirmation that the HTF bias is playing out on the entry timeframe.</div>
        </div>
        <div class="ict-card">
          <div class="ict-name">Silver Bullet</div>
          <div class="ict-def">ICT's specific strategy using the 10:00–11:00am ET and 2:00–3:00pm ET windows. Looks for a liquidity sweep followed by an FVG entry. One of ICT's most taught setups.</div>
        </div>
        <div class="ict-card">
          <div class="ict-name">1st Presented FVG</div>
          <div class="ict-def">The very first Fair Value Gap that forms after a Market Structure Shift. ICT teaches this as the highest-probability FVG to trade, as it represents the initial institutional displacement.</div>
        </div>
        <div class="ict-card">
          <div class="ict-name">Judas Swing</div>
          <div class="ict-def">A false move at the open (often 8:30–9:30am ET) that sweeps liquidity in the wrong direction before the true move begins. Part of ICT's Power of 3 (PO3) model.</div>
        </div>
        <div class="ict-card">
          <div class="ict-name">Turtle Soup</div>
          <div class="ict-def">A reversal entry taken when price sweeps a previous day's high/low (turtle traders' stop levels) and immediately reverses. Named after the Turtle Traders strategy ICT fades.</div>
        </div>
        <div class="ict-card">
          <div class="ict-name">ORG — Opening Range Gap</div>
          <div class="ict-def">The gap between the previous day's close and the current day's open (or between sessions). Price frequently returns to fill this gap, making it a useful reference level.</div>
        </div>
        <div class="ict-card">
          <div class="ict-name">Liquidity Sweep</div>
          <div class="ict-def">Engineered price movement to trigger stops above swing highs (BSL) or below swing lows (SSL) before reversing. The sweep + reversal is the trade signal.</div>
        </div>
      </div>
    </div>

    <!-- KILLZONES -->
    <div class="help-section" id="hs-killzones">
      <div class="hcard">
        <div class="hcard-title">ICT Killzones & Macro Times</div>
        <p>ICT teaches that institutional order flow is only active during specific windows of the trading day. Trading outside these windows significantly reduces edge. All times are <strong>Eastern Time (ET)</strong>.</p>
      </div>
      <div class="kz-explain">
        <div class="kz-card">
          <div class="kz-time">2:00am – 5:00am ET</div>
          <div><div class="kz-info-name">London Killzone 🇬🇧</div><div class="kz-info-desc">London session open. Major institutional activity. ICT looks for London to take liquidity in one direction, then reverse for the true NY move. Good for early risers.</div></div>
        </div>
        <div class="kz-card">
          <div class="kz-time">8:30am – 11:00am ET</div>
          <div><div class="kz-info-name">NY AM Killzone 🗽 (Primary)</div><div class="kz-info-desc">The most important killzone for most ICT traders. Includes the NY open overlap with London. Judas Swings, Silver Bullets, and the primary daily move typically form here. This is where your edge should be sharpest.</div></div>
        </div>
        <div class="kz-card">
          <div class="kz-time">10:00am – 11:00am ET</div>
          <div><div class="kz-info-name">Silver Bullet Window #1 ⚡</div><div class="kz-info-desc">ICT's first Silver Bullet window. Look for a liquidity sweep into an FVG. One of the highest-probability 60-minute windows of the day.</div></div>
        </div>
        <div class="kz-card">
          <div class="kz-time">11:00am – 1:00pm ET</div>
          <div><div class="kz-info-name">NY Lunch / Dead Zone 😴</div><div class="kz-info-desc">Institutional traders at lunch. Volume drops, spreads widen, price chops. ICT explicitly teaches to avoid trading this window. Low probability, high noise.</div></div>
        </div>
        <div class="kz-card">
          <div class="kz-time">1:30pm – 4:00pm ET</div>
          <div><div class="kz-info-name">NY PM Killzone 🌆</div><div class="kz-info-desc">Afternoon institutional activity resumes. Often completes the daily range or creates a second delivery. Lower probability than AM but still tradeable with the right setup.</div></div>
        </div>
        <div class="kz-card">
          <div class="kz-time">2:00pm – 3:00pm ET</div>
          <div><div class="kz-info-name">Silver Bullet Window #2 ⚡</div><div class="kz-info-desc">ICT's second Silver Bullet window in the PM session. Same concept — look for liquidity sweep + FVG entry. Less reliable than the AM window but valid.</div></div>
        </div>
        <div class="kz-card">
          <div class="kz-time">XX:50 – XX:10 ET</div>
          <div><div class="kz-info-name">Macro Windows ⏰ (Every Hour)</div><div class="kz-info-desc">The last 10 minutes and first 10 minutes of every hour. ICT teaches that algorithms re-price markets during these windows. Key times: 8:50, 9:50, 10:50, 1:50, 2:50, 3:50. These are often where the best LTF entries occur within a killzone.</div></div>
        </div>
        <div class="kz-card" style="border-color:rgba(245,183,49,.15)">
          <div class="kz-time" style="color:var(--gold)">8:30am ET</div>
          <div><div class="kz-info-name" style="color:var(--gold)">High-Impact News Events 📰</div><div class="kz-info-desc">CPI, NFP, FOMC, PPI, GDP releases. ICT teaches to either avoid trading 30 minutes before and after, or to specifically trade the post-news liquidity sweep. Always check the economic calendar before each session.</div></div>
        </div>
      </div>
    </div>

    <!-- SESSION COMPANION -->
    <div class="help-section" id="hs-session">
      <div class="hcard">
        <div class="hcard-title">The Session Companion</div>
        <p>The Session Companion is the most important feature for improving as a trader. It forces structured thinking before and after every trade — the same discipline professional traders use.</p>
      </div>
      <div class="hcard">
        <div class="hcard-title">Pre-Session Check-In (opens automatically at 8am ET)</div>
        <p>Every weekday morning between 8:00–9:30am ET, the app automatically opens the Pre-Session popup if you haven't journaled yet today. It asks:</p>
        <div class="hstep"><div class="hstep-n">💤</div><div class="hstep-body"><div class="hstep-title">Hours Slept</div><div class="hstep-desc">Research shows sleep deprivation severely impacts decision-making. TradeEdge tracks this and correlates it with your P&L over time. If you slept under 6 hours, consider sim trading only.</div></div></div>
        <div class="hstep"><div class="hstep-n">⚡</div><div class="hstep-body"><div class="hstep-title">Energy & Confidence Level (1–10)</div><div class="hstep-desc">Your subjective energy and confidence at session start. Low energy + low confidence = recipe for hesitation entries and early exits.</div></div></div>
        <div class="hstep"><div class="hstep-n">☕</div><div class="hstep-body"><div class="hstep-title">Coffee Before 9:30am?</div><div class="hstep-desc">Caffeine before the open can increase anxiety and FOMO trades. TradeEdge tracks this against your performance so you can see the actual impact on your results.</div></div></div>
        <div class="hstep"><div class="hstep-n">📊</div><div class="hstep-body"><div class="hstep-title">HTF Bias & Pre-Market Plan</div><div class="hstep-desc">Your Daily/4H directional bias and key levels to watch. Write this <strong>before</strong> the market opens. If you can't articulate your edge for the day, don't trade.</div></div></div>
      </div>
      <div class="hcard">
        <div class="hcard-title">Post-Trade Debrief (one click after each trade)</div>
        <p>After each trade closes, click <strong>"📝 Log Post-Trade"</strong> in the Journal section, or use keyboard shortcut <kbd>Cmd</kbd>+<kbd>J</kbd>. The popup asks:</p>
        <div class="hstep"><div class="hstep-n">✅</div><div class="hstep-body"><div class="hstep-title">ICT Checklist</div><div class="hstep-desc">Did you wait for the killzone? Was there an MSS? Did you let it run? Complete this honestly — the ICT Compliance chart in analytics tracks this over time.</div></div></div>
        <div class="hstep"><div class="hstep-n">😤</div><div class="hstep-body"><div class="hstep-title">Emotional State</div><div class="hstep-desc">How did you feel during the trade? Calm and focused, or anxious and chasing? This gets tracked in your Psychological Score over time.</div></div></div>
        <div class="hstep"><div class="hstep-n">❌</div><div class="hstep-body"><div class="hstep-title">Mistakes</div><div class="hstep-desc">Be ruthlessly honest here. Did you move your stop? Did you chase? The Mistake Frequency tracker will show you which habits are costing you the most money.</div></div></div>
        <div class="tip-box"><strong>💡 The 30-second rule:</strong> Log the post-trade debrief within 30 seconds of the trade closing, while everything is fresh. Don't wait until end of day — you'll forget the emotion.</div>
      </div>
    </div>

    <!-- SHORTCUTS -->
    <div class="help-section" id="hs-shortcuts">
      <div class="hcard">
        <div class="hcard-title">Keyboard Shortcuts</div>
        <p>Keep this app in a browser tab next to TradingView. These shortcuts let you log trades without taking your eyes off the chart for long.</p>
        <div class="shortcut-grid">
          <div class="sc-row"><span class="sc-desc">Add new trade manually</span><span class="sc-key"><kbd>Cmd</kbd>+<kbd>N</kbd></span></div>
          <div class="sc-row"><span class="sc-desc">Open post-trade debrief</span><span class="sc-key"><kbd>Cmd</kbd>+<kbd>J</kbd></span></div>
          <div class="sc-row"><span class="sc-desc">Start pre-session check-in</span><span class="sc-key"><kbd>Cmd</kbd>+<kbd>S</kbd></span></div>
          <div class="sc-row"><span class="sc-desc">Go to Dashboard</span><span class="sc-key"><kbd>Cmd</kbd>+<kbd>1</kbd></span></div>
          <div class="sc-row"><span class="sc-desc">Go to Trade Log</span><span class="sc-key"><kbd>Cmd</kbd>+<kbd>2</kbd></span></div>
          <div class="sc-row"><span class="sc-desc">Go to Journal</span><span class="sc-key"><kbd>Cmd</kbd>+<kbd>3</kbd></span></div>
          <div class="sc-row"><span class="sc-desc">Go to Analytics</span><span class="sc-key"><kbd>Cmd</kbd>+<kbd>4</kbd></span></div>
          <div class="sc-row"><span class="sc-desc">Go to ICT Analytics</span><span class="sc-key"><kbd>Cmd</kbd>+<kbd>5</kbd></span></div>
          <div class="sc-row"><span class="sc-desc">Go to Import Data</span><span class="sc-key"><kbd>Cmd</kbd>+<kbd>I</kbd></span></div>
          <div class="sc-row"><span class="sc-desc">Go to Help</span><span class="sc-key"><kbd>Cmd</kbd>+<kbd>?</kbd></span></div>
          <div class="sc-row"><span class="sc-desc">Export trades CSV</span><span class="sc-key"><kbd>Cmd</kbd>+<kbd>E</kbd></span></div>
          <div class="sc-row"><span class="sc-desc">Close any popup / modal</span><span class="sc-key"><kbd>Escape</kbd></span></div>
        </div>
        <div class="tip-box" style="margin-top:14px"><strong>💡 Workflow tip:</strong> Keep TradingView on the left half of your screen and TradeEdge on the right half. After each trade closes, hit <kbd>Cmd</kbd>+<kbd>J</kbd> immediately to log the debrief while the emotion is fresh.</div>
      </div>
    </div>
  `;
}

function showHelpTab(tab, el) {
  document.querySelectorAll('.help-section').forEach(s => s.classList.remove('on'));
  document.querySelectorAll('.htab').forEach(t => t.classList.remove('on'));
  const sec = document.getElementById('hs-' + tab);
  if (sec) sec.classList.add('on');
  if (el) el.classList.add('on');
}

// ══════════════════════════════════════════════════════════
// ONBOARDING TOUR
// ══════════════════════════════════════════════════════════
const TOUR_STEPS = [
  {
    title: 'Welcome to TradeEdge ICT!',
    desc: "Let's take a 60-second tour of your new trading journal. We'll show you everything you need to get started. Click Next to begin.",
    target: '.logo-wrap',
    pos: 'right'
  },
  {
    title: 'Dashboard',
    desc: 'Your command center. See all key metrics at a glance — Net P&L, Win Rate, Profit Factor, Equity Curve, and more. Everything updates automatically when you import or add trades.',
    target: '[data-view="dashboard"]',
    pos: 'right'
  },
  {
    title: 'Trade Log',
    desc: 'Every trade in one table. Filter by winners, losers, long or short. Click any row to edit the trade, add journal notes, or attach a chart screenshot.',
    target: '[data-view="trades"]',
    pos: 'right'
  },
  {
    title: 'Journal',
    desc: 'Your daily trading journal. Log your pre-market plan, post-session review, and psychological state. The "Log Post-Trade" button opens a quick debrief after each individual trade.',
    target: '[data-view="journal"]',
    pos: 'right'
  },
  {
    title: 'ICT Analytics',
    desc: 'See which ICT setups (FVG, OB, Silver Bullet, etc.) are actually profitable for you. Track your killzone performance, HTF bias accuracy, and ICT checklist compliance.',
    target: '[data-view="ict"]',
    pos: 'right'
  },
  {
    title: 'Start Session Button',
    desc: 'Click this every morning before you trade. It opens your pre-session check-in — sleep, energy, coffee, HTF bias, and daily plan. The app auto-opens this at 8am ET on weekdays.',
    target: '.session-btn',
    pos: 'bottom'
  },
  {
    title: 'Import Data',
    desc: 'Import your TradingView History CSV, Cancelled CSV (for SL/TP), and AMP daily PDF. The app never overwrites existing trades — always accumulates. Export weekly as a backup.',
    target: '[data-view="import"]',
    pos: 'right'
  },
  {
    title: "You're all set! 🎯",
    desc: "Start by clicking 'Import Data' to load your TradingView trades, or hit '+ Add Trade' to log manually. Remember: click 'Start Session' every morning before you trade. Good luck!",
    target: '.btn-accent',
    pos: 'bottom'
  }
];

let tourStep = 0;

function startTour() {
  tourStep = 0;
  document.getElementById('tour-overlay').style.display = 'block';
  showTourStep();
}

function showTourStep() {
  const step = TOUR_STEPS[tourStep];
  const overlay = document.getElementById('tour-overlay');
  const tooltip = document.getElementById('tour-tooltip');
  const highlight = document.getElementById('tour-highlight');

  document.getElementById('tour-step-label').textContent = `STEP ${tourStep + 1} OF ${TOUR_STEPS.length}`;
  document.getElementById('tour-title').textContent = step.title;
  document.getElementById('tour-desc').textContent = step.desc;
  document.getElementById('tour-next-btn').textContent = tourStep === TOUR_STEPS.length - 1 ? 'Finish ✓' : 'Next →';

  // Dots
  document.getElementById('tour-dots').innerHTML = TOUR_STEPS.map((_, i) =>
    `<div class="tour-dot ${i === tourStep ? 'on' : ''}"></div>`
  ).join('');

  // Highlight target element
  const target = document.querySelector(step.target);
  if (target && target.offsetParent !== null) {
    const rect = target.getBoundingClientRect();
    const pad = 8;
    highlight.style.left = (rect.left - pad) + 'px';
    highlight.style.top = (rect.top - pad) + 'px';
    highlight.style.width = (rect.width + pad * 2) + 'px';
    highlight.style.height = (rect.height + pad * 2) + 'px';
    tooltip.style.transform = 'none';

    // Position tooltip
    if (step.pos === 'right') {
      var tLeft = rect.right + 20;
      if(tLeft + 320 > window.innerWidth) tLeft = Math.max(10, rect.left - 320);
      if(tLeft + 320 > window.innerWidth) tLeft = 10;
      tooltip.style.left = tLeft + 'px';
      tooltip.style.top = Math.max(10, rect.top) + 'px';
    } else if (step.pos === 'bottom') {
      tooltip.style.left = Math.max(10, Math.min(rect.left, window.innerWidth - 320)) + 'px';
      tooltip.style.top = (rect.bottom + 16) + 'px';
    }
  } else {
    // Center if target not found or hidden
    highlight.style.left = '0'; highlight.style.top = '0';
    highlight.style.width = '0'; highlight.style.height = '0';
    tooltip.style.left = '50%'; tooltip.style.top = '50%';
    tooltip.style.transform = 'translate(-50%,-50%)';
  }
}

function tourNext() {
  tourStep++;
  if (tourStep >= TOUR_STEPS.length) { endTour(); return; }
  showTourStep();
}

function endTour() {
  document.getElementById('tour-overlay').style.display = 'none';
  tourStep = 0;
}

// ══════════════════════════════════════════════════════════
// 3D POKER CHIPS — THREE.JS RENDERER
// ══════════════════════════════════════════════════════════
// Standard US casino chip colors (CONFIRMED accurate)
var CHIP_DENOMS=[
  {v:1000,label:'1K',  c:'#CF6500',r:[207,101,0],   s1:'#000',s2:'#FFF',tx:'#FFF'},
  {v:500, label:'500', c:'#6B2D8B',r:[107,45,139],  s1:'#FFF',s2:'#FFF',tx:'#FFF'},
  {v:250, label:'250', c:'#D4688B',r:[212,104,139], s1:'#000',s2:'#FFF',tx:'#000'},
  {v:100, label:'100', c:'#1A1A1A',r:[26,26,26],    s1:'#FFF',s2:'#FFF',tx:'#D4A017'},
  {v:50,  label:'50',  c:'#0055AA',r:[0,85,170],    s1:'#FFF',s2:'#FFF',tx:'#FFF'},
  {v:25,  label:'25',  c:'#006B3F',r:[0,107,63],    s1:'#FFF',s2:'#FFF',tx:'#FFF'},
  {v:10,  label:'10',  c:'#1565C0',r:[21,101,192],  s1:'#FFF',s2:'#FFF',tx:'#FFF'},
  {v:5,   label:'5',   c:'#CC0000',r:[204,0,0],     s1:'#FFF',s2:'#FFF',tx:'#FFF'}
];
var CHIP_R=0.42, CHIP_H=0.09, CHIP_MAX_STACK=10; // H increased for thicker, more visible chips
var _3d={scene:null,camera:null,renderer:null,chipGroup:null,allChips:[],stacks:[],_fidgets:[],dropStart:-1,animId:null,inited:false};

function init3DChips(){
  if(typeof _3d==='undefined'||_3d.inited)return;
  if(typeof THREE==='undefined'){console.warn('[TradeEdge] Three.js not loaded');return;}
  var canvas=document.getElementById('chip-canvas');
  if(!canvas){console.warn('[TradeEdge] chip-canvas not found');return;}
  var container=document.getElementById('chip-tray');
  if(!container){console.warn('[TradeEdge] chip-tray not found');return;}
  
  // Force layout calc
  var w=container.offsetWidth, h=container.offsetHeight;
  if(w<10||h<10){
    console.log('[TradeEdge] chip-tray too small:',w,'x',h,'retrying...');
    setTimeout(function(){
      init3DChips();
      // If init succeeded on retry, create chip meshes immediately
      if(_3d&&_3d.inited){_lastChipBalance=-1;if(typeof updateSidebar==='function')updateSidebar();}
    },500);
    return;
  }
  console.log('[TradeEdge] init3DChips:',w,'x',h);
  
  // Explicitly size canvas
  canvas.width=w*Math.min(window.devicePixelRatio,2);
  canvas.height=h*Math.min(window.devicePixelRatio,2);
  canvas.style.width=w+'px';
  canvas.style.height=h+'px';

  _3d.scene=new THREE.Scene();
  _3d.scene.background=new THREE.Color(0x020806);
  _3d.scene.fog=new THREE.FogExp2(0x020806,0.06);

  _3d.camera=new THREE.PerspectiveCamera(32,w/h,2,15);
  _3d.camera.position.set(0,2.6,5.5);
  _3d.camera.lookAt(0,0.2,0);

  try{
    _3d.renderer=new THREE.WebGLRenderer({canvas:canvas,antialias:true,alpha:false});
  }catch(e){
    console.error('[TradeEdge] WebGL renderer creation failed:',e);
    window._threeJsFailed=true;
    return;
  }
  _3d.renderer.setSize(w,h);
  _3d.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
  _3d.renderer.shadowMap.enabled=true;
  _3d.renderer.shadowMap.type=THREE.PCFSoftShadowMap;
  _3d.renderer.toneMapping=THREE.ACESFilmicToneMapping;
  _3d.renderer.toneMappingExposure=1.1;
  _3d.renderer.outputEncoding=THREE.sRGBEncoding;

  // Key light — overhead spot (boosted for chip detail visibility)
  var key=new THREE.SpotLight(0xfff5e0,2.0,20,Math.PI*0.25,0.6,1.2);
  key.position.set(0,8,2);key.target.position.set(0,0,0);
  key.castShadow=true;key.shadow.mapSize.set(2048,2048);
  key.shadow.camera.near=1;key.shadow.camera.far=15;
  key.shadow.bias=-0.001;key.shadow.radius=4;
  _3d.scene.add(key);_3d.scene.add(key.target);

  // Fill light — warmer for chip color accuracy
  var fill=new THREE.SpotLight(0xd0e8ff,0.5,15,Math.PI*0.4,0.8,1.5);
  fill.position.set(-4,4,5);_3d.scene.add(fill);

  // Rim light — TradeEdge cyan (brighter for edge definition)
  var rim=new THREE.SpotLight(0x00f0c0,0.2,12,Math.PI*0.3,0.9,2);
  rim.position.set(2,3,-4);_3d.scene.add(rim);

  _3d.scene.add(new THREE.AmbientLight(0x101820,0.65));
  _3d.scene.add(new THREE.HemisphereLight(0x1a2a1a,0x080808,0.3));

  // Felt table
  var feltC=document.createElement('canvas');feltC.width=1024;feltC.height=1024;
  var fctx=feltC.getContext('2d');
  var grd=fctx.createRadialGradient(512,512,0,512,512,600);
  grd.addColorStop(0,'#1a5c3a');grd.addColorStop(0.5,'#145230');grd.addColorStop(1,'#0c3820');
  fctx.fillStyle=grd;fctx.fillRect(0,0,1024,1024);
  var imgD=fctx.getImageData(0,0,1024,1024);var px=imgD.data;
  for(var i=0;i<px.length;i+=4){var n=(Math.random()-.5)*12;px[i]=Math.max(0,Math.min(255,px[i]+n));px[i+1]=Math.max(0,Math.min(255,px[i+1]+n));px[i+2]=Math.max(0,Math.min(255,px[i+2]+n));}
  fctx.putImageData(imgD,0,0);
  fctx.globalAlpha=0.02;fctx.strokeStyle='#000';fctx.lineWidth=1;
  for(var i=0;i<400;i++){var x=Math.random()*1024,y=Math.random()*1024;fctx.beginPath();fctx.moveTo(x,y);fctx.lineTo(x+Math.random()*30-15,y+Math.random()*8-4);fctx.stroke();}
  fctx.globalAlpha=1;
  var feltTex=new THREE.CanvasTexture(feltC);feltTex.wrapS=THREE.RepeatWrapping;feltTex.wrapT=THREE.RepeatWrapping;feltTex.repeat.set(2,2);
  var feltGeo=new THREE.PlaneGeometry(16,12);
  var feltMat=new THREE.MeshStandardMaterial({map:feltTex,roughness:0.92,metalness:0,bumpMap:feltTex,bumpScale:0.008});
  var felt=new THREE.Mesh(feltGeo,feltMat);felt.rotation.x=-Math.PI/2;felt.position.y=0;felt.receiveShadow=true;_3d.scene.add(felt);
  // Dark surround
  var railGeo=new THREE.PlaneGeometry(20,16);
  var railMat=new THREE.MeshStandardMaterial({color:0x0a0a0a,roughness:0.95});
  var rail=new THREE.Mesh(railGeo,railMat);rail.rotation.x=-Math.PI/2;rail.position.y=-0.01;rail.receiveShadow=true;_3d.scene.add(rail);

  _3d.chipGroup=new THREE.Group();_3d.scene.add(_3d.chipGroup);
  _3d.inited=true;

  // Show 3D canvas, hide CSS fallback
  canvas.style.display='block';
  var _fb=document.getElementById('chip-css-fallback');if(_fb)_fb.style.display='none';

  // Mouse subtle orbit
  container.addEventListener('mousemove',function(e){
    var rect=container.getBoundingClientRect();
    var mx=(e.clientX-rect.left)/rect.width-0.5;
    var my=(e.clientY-rect.top)/rect.height-0.5;
    _3d._targetX=mx*1.5;_3d._targetY=my*0.4;
  });
  container.addEventListener('mouseleave',function(){_3d._targetX=0;_3d._targetY=0;});
  _3d._targetX=0;_3d._targetY=0;_3d._curX=0;_3d._curY=0;_3d._fidgets=[];

  // Click → fidget the clicked stack
  var _ray=new THREE.Raycaster(),_mouse=new THREE.Vector2();
  container.addEventListener('click',function(e){
    var rect=container.getBoundingClientRect();
    _mouse.x=((e.clientX-rect.left)/rect.width)*2-1;
    _mouse.y=-((e.clientY-rect.top)/rect.height)*2+1;
    _ray.setFromCamera(_mouse,_3d.camera);
    var hits=_ray.intersectObjects(_3d.chipGroup.children,true);
    if(hits.length>0){
      // Traverse up to find the direct child of chipGroup (the stack Group)
      var hitObj=hits[0].object;
      while(hitObj.parent&&hitObj.parent!==_3d.chipGroup)hitObj=hitObj.parent;
      for(var i=0;i<_3d.stacks.length;i++){
        if(_3d.stacks[i].mesh===hitObj){_fidgetStack(i);break;}
      }
    }
  });

  // Start render loop
  function animate3D(){
    _3d.animId=requestAnimationFrame(animate3D);
    // Animate drops — dramatic slam from above
    if(_3d.dropStart>0){
      var now=performance.now(),allDone=true;
      _3d.allChips.forEach(function(c){
        if(c.done)return;
        var elapsed=now-_3d.dropStart-c.delay;
        if(elapsed<0){allDone=false;return;}
        var t=Math.min(elapsed/280,1); // 280ms — fast realistic gravity slam
        // Bounce easing
        var e;
        if(t<1/2.75)e=7.5625*t*t;
        else if(t<2/2.75)e=7.5625*(t-=1.5/2.75)*t+0.75;
        else if(t<2.5/2.75)e=7.5625*(t-=2.25/2.75)*t+0.9375;
        else e=7.5625*(t-=2.625/2.75)*t+0.984375;
        c.mesh.position.y=c.startY+(c.targetY-c.startY)*e;
        // Animate X/Z convergence and rotation correction
        if(c.startX!==undefined){c.mesh.position.x=c.startX+(c.targetX-c.startX)*e;}
        if(c.startZ!==undefined){c.mesh.position.z=c.startZ+(c.targetZ-c.startZ)*e;}
        if(c.startRX!==undefined){c.mesh.rotation.x=c.startRX*(1-e);}
        if(c.startRZ!==undefined){c.mesh.rotation.z=c.startRZ*(1-e);}
        if(t>=1){c.mesh.position.y=c.targetY;c.mesh.position.x=c.targetX||c.mesh.position.x;c.mesh.position.z=c.targetZ||c.mesh.position.z;c.mesh.rotation.x=0;c.mesh.rotation.z=0;c.done=true;}else allDone=false;
      });
      if(allDone)_3d.dropStart=-1;
    }
    // Fidget animations
    if(_3d._fidgets&&_3d._fidgets.length>0){
      var now2=performance.now();
      for(var fi=_3d._fidgets.length-1;fi>=0;fi--){
        var fa=_3d._fidgets[fi],fel=now2-fa.st;
        if(fel>=fa.dur){
          if(fa._spreadChips){fa._spreadChips.forEach(function(sc){_disposeSpreadChip(sc);_3d.chipGroup.remove(sc);});fa.m.visible=true;fa._spreadChips=null;}
          fa.m.position.y=fa.by;fa.m.position.x=fa.bx||fa.m.position.x;fa.m.position.z=fa.bz||fa.m.position.z;fa.m.rotation.y=fa.bry;fa.m.rotation.z=fa.brz||0;_3d._fidgets.splice(fi,1);continue;
        }
        fa.fn(fa,fel/fa.dur);
      }
    }
    // Smooth camera orbit
    _3d._curX+=(_3d._targetX-_3d._curX)*0.05;
    _3d._curY+=(_3d._targetY-_3d._curY)*0.05;
    _3d.camera.position.x=_3d._curX;
    _3d.camera.position.y=2.6-_3d._curY;
    _3d.camera.lookAt(0,0.2,0);
    _3d.renderer.render(_3d.scene,_3d.camera);
  }
  animate3D();

  // Handle resize
  var resizeObs=new ResizeObserver(function(entries){
    var e=entries[0];if(!e)return;
    var w2=e.contentRect.width,h2=e.contentRect.height;
    if(w2<10||h2<10)return;
    _3d.camera.aspect=w2/h2;_3d.camera.updateProjectionMatrix();
    _3d.renderer.setSize(w2,h2);
  });
  resizeObs.observe(container);
}

// ─── V12 CHIP SYSTEM: Individual chip meshes per stack → realistic imperfections ───

// Helper: adjust RGB array by offset, return css rgb() string
function _ac(r,a){return 'rgb('+Math.max(0,Math.min(255,r[0]+a))+','+Math.max(0,Math.min(255,r[1]+a))+','+Math.max(0,Math.min(255,r[2]+a))+')';}

// Texture cache (top/bottom cached per denom; side created fresh per stack)
var _chipTexCache={};

/* Side texture — one canvas encodes ALL chip layers for a stack of `count` chips.
   Each layer is 256px tall. Alternating stripe sections give the classic edge pattern.
   Zero overlapping geometry means zero z-fighting. */
function _chipSideTex(d,count){
  var key=d.label+'_side_'+count;
  if(_chipTexCache[key])return _chipTexCache[key];
  var W=512,H=256*count;
  var cv=document.createElement('canvas');cv.width=W;cv.height=H;var ctx=cv.getContext('2d');
  for(var layer=0;layer<count;layer++){
    var ly=H-(layer+1)*256,lh=256;
    // Base color with subtle vertical gradient for depth
    var baseG=ctx.createLinearGradient(0,ly,0,ly+lh);
    baseG.addColorStop(0,_ac(d.r,12));baseG.addColorStop(.5,d.c);baseG.addColorStop(1,_ac(d.r,-12));
    ctx.fillStyle=baseG;ctx.fillRect(0,ly,W,lh);
    // Stripe sections — wider stripes with better contrast
    var N=8,T=N*2,sW=W/T;
    for(var i=0;i<T;i++){
      var sx=Math.round(i*sW),sw=Math.round((i+1)*sW)-sx;
      if(i%2===0){
        var p=Math.round(lh*.04),sH=lh-p*2,tw=Math.round(sw/3);
        ctx.fillStyle=d.s1;ctx.fillRect(sx,ly+p,tw,sH);
        ctx.fillStyle='#E8E0D4';ctx.fillRect(sx+tw,ly+p,tw,sH);
        ctx.fillStyle=d.s2;ctx.fillRect(sx+tw*2,ly+p,sw-tw*2,sH);
        // Groove shadows between stripes
        ctx.fillStyle='rgba(0,0,0,0.25)';ctx.fillRect(sx,ly+p,1,sH);ctx.fillRect(sx+sw-1,ly+p,1,sH);
        // Inner highlight
        ctx.fillStyle='rgba(255,255,255,0.08)';ctx.fillRect(sx+1,ly+p,1,sH);
      }else{
        var g=ctx.createLinearGradient(0,ly,0,ly+lh);
        g.addColorStop(0,_ac(d.r,25));g.addColorStop(.3,_ac(d.r,8));g.addColorStop(.7,d.c);g.addColorStop(1,_ac(d.r,-25));
        ctx.fillStyle=g;ctx.fillRect(sx,ly,sw+1,lh);
      }
    }
    // Top edge highlight (bevel)
    ctx.fillStyle='rgba(255,255,255,0.18)';ctx.fillRect(0,ly,W,2);
    ctx.fillStyle='rgba(255,255,255,0.08)';ctx.fillRect(0,ly+2,W,1);
    // Bottom edge shadow (bevel)
    ctx.fillStyle='rgba(0,0,0,0.22)';ctx.fillRect(0,ly+lh-2,W,2);
    ctx.fillStyle='rgba(0,0,0,0.1)';ctx.fillRect(0,ly+lh-3,W,1);
    // Chip separation groove
    if(layer>0){ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(0,ly+lh-1,W,2);ctx.fillStyle='rgba(255,255,255,0.06)';ctx.fillRect(0,ly+lh+1,W,1);}
  }
  // Clay grain texture
  var id=ctx.getImageData(0,0,W,H),px=id.data;
  for(var i=0;i<px.length;i+=4){var n=(Math.random()-.5)*6;px[i]+=n;px[i+1]+=n;px[i+2]+=n;}
  ctx.putImageData(id,0,0);
  var t=new THREE.CanvasTexture(cv);t.wrapS=THREE.RepeatWrapping;
  _chipTexCache[key]=t;return t;
}

/* Top face — 768×768, casino stripe wedges + edge spots + metallic inlay ring */
function _chipTopTex(d){
  if(_chipTexCache[d.label+'_top'])return _chipTexCache[d.label+'_top'];
  var Z=768,cv=document.createElement('canvas');cv.width=Z;cv.height=Z;var ctx=cv.getContext('2d');
  var cx=Z/2,cy=Z/2,R=Z/2-4;
  // Base fill with radial gradient
  var bg=ctx.createRadialGradient(cx-Z*.04,cy-Z*.04,0,cx,cy,R);
  bg.addColorStop(0,_ac(d.r,25));bg.addColorStop(.35,d.c);bg.addColorStop(.85,d.c);bg.addColorStop(1,_ac(d.r,-30));
  ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.fillStyle=bg;ctx.fill();
  // Clay grain noise
  var id=ctx.getImageData(0,0,Z,Z),px=id.data;
  for(var i=0;i<px.length;i+=4){var pi=(i/4)%Z,pj=Math.floor(i/4/Z),dx=pi-cx,dy=pj-cy;if(dx*dx+dy*dy<R*R){var n=(Math.random()-.5)*6;px[i]+=n;px[i+1]+=n;px[i+2]+=n;}}
  ctx.putImageData(id,0,0);
  // Edge stripe wedges (8 pairs)
  var N=8,T=N*2,aP=Math.PI*2/T,iR=R-28;
  ctx.save();ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.clip();
  for(var i=0;i<T;i++){if(i%2!==0)continue;var a1=i*aP-Math.PI/2,sub=aP/3;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,R,a1,a1+sub);ctx.closePath();ctx.fillStyle=d.s1;ctx.globalAlpha=.45;ctx.fill();
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,R,a1+sub,a1+sub*2);ctx.closePath();ctx.fillStyle='#E8E0D4';ctx.globalAlpha=.5;ctx.fill();
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,R,a1+sub*2,a1+aP);ctx.closePath();ctx.fillStyle=d.s2;ctx.globalAlpha=.45;ctx.fill();
  }
  // Cut inner circle and refill
  ctx.globalAlpha=1;ctx.globalCompositeOperation='destination-out';
  ctx.beginPath();ctx.arc(cx,cy,iR,0,Math.PI*2);ctx.fillStyle='#000';ctx.fill();
  ctx.globalCompositeOperation='source-over';
  var bg2=ctx.createRadialGradient(cx,cy,0,cx,cy,iR);
  bg2.addColorStop(0,_ac(d.r,18));bg2.addColorStop(.5,d.c);bg2.addColorStop(1,_ac(d.r,-20));
  ctx.beginPath();ctx.arc(cx,cy,iR,0,Math.PI*2);ctx.fillStyle=bg2;ctx.fill();
  ctx.restore();ctx.globalAlpha=1;
  // Edge spots — classic casino chip pattern (6 rectangular spots around perimeter)
  var spotR=R-10,spotCount=6;
  var _rr=!!ctx.roundRect; // roundRect support check (Chrome 99+)
  for(var si=0;si<spotCount;si++){
    var sa=si*(Math.PI*2/spotCount)-Math.PI/2;
    var sx=cx+Math.cos(sa)*spotR,sy=cy+Math.sin(sa)*spotR;
    ctx.save();ctx.translate(sx,sy);ctx.rotate(sa+Math.PI/2);
    // Outer spot (white with shadow)
    ctx.fillStyle='rgba(255,255,255,0.7)';
    ctx.beginPath();if(_rr){ctx.roundRect(-10,-5,20,10,3);}else{ctx.rect(-10,-5,20,10);}ctx.fill();
    // Inner colored spot
    ctx.fillStyle=si%2===0?d.s1:d.s2;ctx.globalAlpha=0.8;
    ctx.beginPath();if(_rr){ctx.roundRect(-7,-3,14,6,2);}else{ctx.rect(-7,-3,14,6);}ctx.fill();
    ctx.globalAlpha=1;ctx.restore();
  }
  // Metallic inlay ring
  ctx.beginPath();ctx.arc(cx,cy,iR+2,0,Math.PI*2);ctx.strokeStyle='rgba(212,190,140,0.35)';ctx.lineWidth=3;ctx.stroke();
  ctx.beginPath();ctx.arc(cx,cy,iR-1,0,Math.PI*2);ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=1;ctx.stroke();
  // Inner ring detail
  ctx.beginPath();ctx.arc(cx,cy,iR,0,Math.PI*2);ctx.strokeStyle='rgba(0,0,0,0.2)';ctx.lineWidth=1.5;ctx.stroke();
  ctx.beginPath();ctx.arc(cx,cy,iR-10,0,Math.PI*2);ctx.strokeStyle='rgba(255,255,255,0.06)';ctx.lineWidth=1;ctx.setLineDash([7,5]);ctx.stroke();ctx.setLineDash([]);
  // Denomination text — bolder with subtle shadow
  ctx.fillStyle=d.tx;ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.font='900 '+(Z*.042)+'px "Arial Black",Arial,sans-serif';
  ctx.globalAlpha=.15;ctx.fillText('$',cx+1,cy-Z*.030);  // shadow
  ctx.globalAlpha=.6;ctx.fillText('$',cx,cy-Z*.032);
  ctx.font='900 '+(d.label.length>2?Z*.06:Z*.075)+'px "Arial Black",Arial,sans-serif';
  ctx.globalAlpha=.15;ctx.fillText(d.label,cx+1,cy+Z*.022);  // shadow
  ctx.globalAlpha=.8;ctx.fillText(d.label,cx,cy+Z*.02);
  // Specular highlight
  ctx.globalAlpha=.04;ctx.beginPath();ctx.ellipse(cx-Z*.06,cy-Z*.1,R*.4,R*.2,-.2,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();ctx.globalAlpha=1;
  _chipTexCache[d.label+'_top']=new THREE.CanvasTexture(cv);
  return _chipTexCache[d.label+'_top'];
}

/* Bottom face — dark underside with subtle ring detail */
function _chipBotTex(d){
  if(_chipTexCache[d.label+'_bot'])return _chipTexCache[d.label+'_bot'];
  var Z=256,cv=document.createElement('canvas');cv.width=Z;cv.height=Z;var ctx=cv.getContext('2d');
  var cx=Z/2,R=Z/2;
  var g=ctx.createRadialGradient(cx,cx,0,cx,cx,R);
  g.addColorStop(0,_ac(d.r,-12));g.addColorStop(.7,_ac(d.r,-25));g.addColorStop(1,_ac(d.r,-40));
  ctx.beginPath();ctx.arc(cx,cx,R,0,Math.PI*2);ctx.fillStyle=g;ctx.fill();
  // Concentric wear ring
  ctx.beginPath();ctx.arc(cx,cx,R*.7,0,Math.PI*2);ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.lineWidth=2;ctx.stroke();
  // Clay grain
  var id=ctx.getImageData(0,0,Z,Z),px=id.data;
  for(var i=0;i<px.length;i+=4){var n=(Math.random()-.5)*4;px[i]+=n;px[i+1]+=n;px[i+2]+=n;}
  ctx.putImageData(id,0,0);
  _chipTexCache[d.label+'_bot']=new THREE.CanvasTexture(cv);
  return _chipTexCache[d.label+'_bot'];
}

/* Individual chip meshes per stack — realistic imperfections (misaligned stripes, jitter, tilt) */
function _makeStackMesh(d,count){
  var group=new THREE.Group();
  var totalH=count*CHIP_H;
  var sideMat=new THREE.MeshStandardMaterial({map:_chipSideTex(d,1),roughness:.72,metalness:.03});
  var topMat=new THREE.MeshStandardMaterial({map:_chipTopTex(d),roughness:.65,metalness:.05});
  var botMat=new THREE.MeshStandardMaterial({map:_chipBotTex(d),roughness:.85,metalness:.02});
  var geo=new THREE.CylinderGeometry(CHIP_R,CHIP_R,CHIP_H,64);
  for(var i=0;i<count;i++){
    var chip=new THREE.Mesh(geo,[sideMat,topMat,botMat]);
    chip.position.y=(i*CHIP_H)-(totalH/2)+CHIP_H/2+(i*0.001);
    chip.rotation.y=(Math.random()-.5)*0.7; // ±0.35 rad — edge stripe misalignment
    chip.position.x=(Math.random()-.5)*0.024; // ±0.012 lateral shift
    chip.position.z=(Math.random()-.5)*0.024;
    chip.rotation.x=(Math.random()-.5)*0.016; // ±0.008 micro-tilt
    chip.rotation.z=(Math.random()-.5)*0.016;
    chip.castShadow=true;chip.receiveShadow=false;
    group.add(chip);
  }
  return group;
}

/* Single chip disc for spread fidget — shared geometry, random rotation for realistic look */
var _singleChipGeo=null;
function _makeSingleChipMesh(d){
  if(!_singleChipGeo)_singleChipGeo=new THREE.CylinderGeometry(CHIP_R,CHIP_R,CHIP_H,64);
  var mesh=new THREE.Mesh(_singleChipGeo,[
    new THREE.MeshStandardMaterial({map:_chipSideTex(d,1),roughness:.72,metalness:.03}),
    new THREE.MeshStandardMaterial({map:_chipTopTex(d),roughness:.65,metalness:.05}),
    new THREE.MeshStandardMaterial({map:_chipBotTex(d),roughness:.85,metalness:.02})
  ]);
  mesh.castShadow=true;mesh.receiveShadow=false;
  mesh.rotation.y=(Math.random()-.5)*0.7; // stripe misalignment
  return mesh;
}

/* Dispose materials on a spread chip (geometry is shared, never disposed) */
function _disposeSpreadChip(sc){
  if(sc.material){
    if(Array.isArray(sc.material))sc.material.forEach(function(m){m.dispose();});
    else sc.material.dispose();
  }
}

/* Fidget animation for a clicked stack */
function _fidgetStack(si){
  var sk=_3d.stacks[si];if(!sk)return;
  // Cancel any existing fidget on this stack first
  for(var i=_3d._fidgets.length-1;i>=0;i--){
    if(_3d._fidgets[i].si===si){
      var old=_3d._fidgets[i];
      // Clean up spread chips if they exist
      if(old._spreadChips){
        old._spreadChips.forEach(function(sc){_disposeSpreadChip(sc);_3d.chipGroup.remove(sc);});
        old.m.visible=true;
      }
      old.m.position.y=old.by;old.m.position.x=old.bx;old.m.position.z=old.bz;
      old.m.rotation.y=old.bry;old.m.rotation.z=old.brz;
      _3d._fidgets.splice(i,1);
    }
  }
  var m=sk.mesh;
  var a={si:si,m:m,by:m.position.y,bx:m.position.x,bz:m.position.z,bry:m.rotation.y,brz:m.rotation.z||0,st:performance.now()};
  // Spread is weighted 2x more likely
  var types=['spread','spread','bounce','spin','hop','launch','tilt','wobble'];
  var tr=types[Math.floor(Math.random()*types.length)];
  if(tr==='spread'){
    // Grab stack, lift, spread chips in air, then drop them one-by-one back down
    var count=sk.sz||3;
    var d=sk.d;
    var singles=[];
    for(var ci=0;ci<count;ci++){
      var chip=_makeSingleChipMesh(d);
      chip.position.copy(m.position);
      chip.rotation.copy(m.rotation);
      _3d.chipGroup.add(chip);
      singles.push(chip);
    }
    a._spreadChips=singles;
    a._slamPlayed={}; // track which chips have played their slam
    m.visible=false;
    var liftH=1.4; // how high the hand lifts the stack
    var spreadGap=0.25; // gap between chips when spread in the air
    var liftPhase=0.10; // 0-10% = quick lift
    var holdPhase=0.25; // 10-25% = spread apart in the air
    var dropPhase=1.0;  // 25-100% = chips fall one by one fast
    a.dur=900+(count*50); // snappy — real chips fall fast
    a.fn=function(a,t){
      var stackH=count*CHIP_H;
      // Base Y for each chip when stacked normally
      function baseY(ci){return a.by-(stackH/2)+CHIP_H/2+ci*CHIP_H;}
      // Spread Y when held in the air
      function spreadY(ci){return a.by+liftH-(count-1)*spreadGap/2+ci*spreadGap;}

      if(t<liftPhase){
        // Phase 1: Lift entire stack up smoothly
        var p=t/liftPhase;
        var ease=1-Math.pow(1-p,3); // ease out
        for(var ci=0;ci<singles.length;ci++){
          singles[ci].position.y=baseY(ci)+liftH*ease;
          singles[ci].position.x=a.bx;
          singles[ci].position.z=a.bz;
          singles[ci].rotation.z=0;
        }
      }else if(t<holdPhase){
        // Phase 2: Spread chips apart in the air (still held)
        var p=(t-liftPhase)/(holdPhase-liftPhase);
        var ease=1-Math.pow(1-p,2);
        for(var ci=0;ci<singles.length;ci++){
          var lifted=baseY(ci)+liftH;
          var target=spreadY(ci);
          singles[ci].position.y=lifted+(target-lifted)*ease;
          singles[ci].position.x=a.bx;
          singles[ci].position.z=a.bz;
          // Slight wobble while held
          singles[ci].rotation.z=Math.sin(p*Math.PI*2+ci)*0.03;
        }
      }else{
        // Phase 3: Release chips one by one from bottom to top
        var dropT=(t-holdPhase)/(dropPhase-holdPhase);
        for(var ci=0;ci<singles.length;ci++){
          var dropDelay=ci*0.12; // stagger — bottom chip drops first
          var chipT=(dropT-dropDelay)/(1-dropDelay*singles.length/(singles.length+1));
          chipT=Math.max(0,Math.min(1,chipT));

          var startY=spreadY(ci);
          var endY=baseY(ci);

          if(chipT<=0){
            // Still held in the air
            singles[ci].position.y=startY;
            singles[ci].rotation.z=Math.sin(ci)*0.02;
          }else if(chipT<1){
            // Falling — bounce easing
            var bt=chipT;
            var e;
            if(bt<1/2.75)e=7.5625*bt*bt;
            else if(bt<2/2.75){bt-=1.5/2.75;e=7.5625*bt*bt+0.75;}
            else if(bt<2.5/2.75){bt-=2.25/2.75;e=7.5625*bt*bt+0.9375;}
            else{bt-=2.625/2.75;e=7.5625*bt*bt+0.984375;}
            singles[ci].position.y=startY+(endY-startY)*e;
            singles[ci].rotation.z=(1-chipT)*Math.sin(ci)*0.02;
            // Play slam sound when chip first lands (e > 0.95)
            if(e>0.95&&!a._slamPlayed[ci]){
              a._slamPlayed[ci]=true;
              if(_userHasInteracted)_playChipSlamSound(ci,singles.length);
            }
          }else{
            // Landed
            singles[ci].position.y=endY;
            singles[ci].rotation.z=0;
            if(!a._slamPlayed[ci]){
              a._slamPlayed[ci]=true;
              if(_userHasInteracted)_playChipSlamSound(ci,singles.length);
            }
          }
          singles[ci].position.x=a.bx;
          singles[ci].position.z=a.bz;
        }
      }
      // Clean up when done
      if(t>=1){
        a._spreadChips.forEach(function(sc){_disposeSpreadChip(sc);_3d.chipGroup.remove(sc);});
        a.m.visible=true;
        a._spreadChips=null;
      }
    };
  }else if(tr==='bounce'){
    // Quick satisfying bounce
    a.dur=500;
    a.fn=function(a,t){a.m.position.y=a.by+Math.sin(t*Math.PI)*.35;};
  }else if(tr==='spin'){
    // Full rotation with slight lift
    a.dur=700;
    a.fn=function(a,t){a.m.rotation.y=a.bry+t*Math.PI*2;a.m.position.y=a.by+Math.sin(t*Math.PI)*.12;};
  }else if(tr==='hop'){
    // Rapid double-hop
    a.dur=450;
    a.fn=function(a,t){
      var phase=t*2%1;var hop=t<0.5?0:1;
      a.m.position.y=a.by+Math.sin(phase*Math.PI)*(hop?0.15:0.28);
    };
  }else if(tr==='launch'){
    // Shoots way up then falls back with realistic bounce
    a.dur=1000;
    a.fn=function(a,t){
      if(t<0.42){
        a.m.position.y=a.by+Math.sin((t/0.42)*Math.PI/2)*1.1;
      }else{
        var ft=(t-0.42)/0.58;
        var e;if(ft<1/2.75)e=7.5625*ft*ft;
        else if(ft<2/2.75){var _f=ft-1.5/2.75;e=7.5625*_f*_f+0.75;}
        else if(ft<2.5/2.75){var _f=ft-2.25/2.75;e=7.5625*_f*_f+0.9375;}
        else{var _f=ft-2.625/2.75;e=7.5625*_f*_f+0.984375;}
        a.m.position.y=a.by+1.1*(1-e);
      }
    };
  }else if(tr==='tilt'){
    // Sways side to side like a tap, with decay
    a.dur=750;
    a.fn=function(a,t){
      var decay=Math.pow(1-t,1.4);
      a.m.rotation.z=a.brz+Math.sin(t*Math.PI*3.5)*decay*0.5;
      a.m.position.y=a.by+Math.abs(Math.sin(t*Math.PI*3.5))*decay*0.06;
    };
  }else{
    // Wobble — lateral nudge with decay
    a.dur=650;
    a.fn=function(a,t){
      var decay=Math.pow(1-t,1.3);
      a.m.position.x=a.bx+Math.sin(t*Math.PI*4.5)*decay*0.22;
      a.m.position.y=a.by+Math.abs(Math.sin(t*Math.PI*4.5))*decay*0.08;
    };
  }
  _3d._fidgets.push(a);
  _playChipFidgetSound(tr);
}

function _playChipFidgetSound(type){
  try{
    var ctx=new(window.AudioContext||window.webkitAudioContext)();
    var comp=ctx.createDynamicsCompressor();comp.threshold.value=-12;comp.ratio.value=4;comp.connect(ctx.destination);
    // Launch gets more chips clattering; tilt/wobble gets fewer
    var n=type==='launch'?5:type==='spin'?3:2;
    for(var i=0;i<n;i++){(function(idx){
      var t=idx*0.025+Math.random()*0.01;
      var pv=0.88+Math.random()*0.24;
      // Sharp ceramic click
      var o=ctx.createOscillator(),g=ctx.createGain();
      o.type='sine';
      o.frequency.setValueAtTime(3600*pv,ctx.currentTime+t);
      o.frequency.exponentialRampToValueAtTime(900*pv,ctx.currentTime+t+0.009);
      g.gain.setValueAtTime(0.14,ctx.currentTime+t);
      g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+t+0.045);
      o.connect(g);g.connect(comp);o.start(ctx.currentTime+t);o.stop(ctx.currentTime+t+0.05);
      // Body thud (lower freq)
      var o2=ctx.createOscillator(),g2=ctx.createGain();
      o2.type='triangle';
      o2.frequency.setValueAtTime(420*pv,ctx.currentTime+t);
      o2.frequency.exponentialRampToValueAtTime(180*pv,ctx.currentTime+t+0.025);
      g2.gain.setValueAtTime(0.06,ctx.currentTime+t);
      g2.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+t+0.04);
      o2.connect(g2);g2.connect(comp);o2.start(ctx.currentTime+t);o2.stop(ctx.currentTime+t+0.05);
    })(i);}
    // For launch, add a landing thud
    if(type==='launch'){
      setTimeout(function(){
        try{
          var ctx2=new(window.AudioContext||window.webkitAudioContext)();
          var o=ctx2.createOscillator(),g=ctx2.createGain();
          o.type='triangle';o.frequency.setValueAtTime(380,ctx2.currentTime);
          o.frequency.exponentialRampToValueAtTime(120,ctx2.currentTime+0.06);
          g.gain.setValueAtTime(0.2,ctx2.currentTime);g.gain.exponentialRampToValueAtTime(0.001,ctx2.currentTime+0.12);
          o.connect(g);g.connect(ctx2.destination);o.start();o.stop(ctx2.currentTime+0.12);
        }catch(e){}
      },430); // ~landing time
    }
  }catch(e){}
}

// Per-stack slam sound — heavy thud + ceramic crack when each stack hits the felt
function _playChipSlamSound(idx,total){
  try{
    var ctx=new(window.AudioContext||window.webkitAudioContext)();
    var t=ctx.currentTime;
    var pitchVar=0.85+Math.random()*0.3;
    var isLast=(idx===total-1);
    var vol=isLast?1.3:0.9+Math.random()*0.3; // last stack hits hardest

    // Master output
    var master=ctx.createGain();master.gain.value=vol*0.5;
    master.connect(ctx.destination);

    // LAYER 1: Deep table thud — low freq impact
    var thud=ctx.createOscillator(),tg=ctx.createGain();
    thud.type='sine';
    thud.frequency.setValueAtTime(120*pitchVar,t);
    thud.frequency.exponentialRampToValueAtTime(35,t+0.18);
    tg.gain.setValueAtTime(0.15*vol,t);
    tg.gain.exponentialRampToValueAtTime(0.001,t+0.22);
    thud.connect(tg);tg.connect(master);
    thud.start(t);thud.stop(t+0.25);

    // LAYER 2: Sharp ceramic crack — the chip-on-felt impact
    var crack=ctx.createOscillator(),cg=ctx.createGain();
    crack.type='sine';
    crack.frequency.setValueAtTime(4200*pitchVar,t);
    crack.frequency.exponentialRampToValueAtTime(1500*pitchVar,t+0.006);
    cg.gain.setValueAtTime(0.08*vol,t);
    cg.gain.exponentialRampToValueAtTime(0.001,t+0.01);
    crack.connect(cg);cg.connect(master);
    crack.start(t);crack.stop(t+0.015);

    // LAYER 3: Noise burst — impact texture
    var nLen=Math.floor(ctx.sampleRate*0.015);
    var nBuf=ctx.createBuffer(1,nLen,ctx.sampleRate);
    var nd=nBuf.getChannelData(0);
    for(var j=0;j<nLen;j++)nd[j]=(Math.random()*2-1)*Math.pow(1-j/nLen,2);
    var nSrc=ctx.createBufferSource();nSrc.buffer=nBuf;
    var nFilt=ctx.createBiquadFilter();
    nFilt.type='lowpass';nFilt.frequency.value=2000*pitchVar;nFilt.Q.value=1.5;
    var ng=ctx.createGain();
    ng.gain.setValueAtTime(0.1*vol,t);
    ng.gain.exponentialRampToValueAtTime(0.001,t+0.02);
    nSrc.connect(nFilt);nFilt.connect(ng);ng.connect(master);
    nSrc.start(t);nSrc.stop(t+0.02);

    // LAYER 4: Ceramic ring-out (brief resonance after landing)
    var ring=ctx.createOscillator(),rg=ctx.createGain();
    ring.type='sine';
    ring.frequency.setValueAtTime(2800*pitchVar,t+0.005);
    ring.frequency.exponentialRampToValueAtTime(1800*pitchVar,t+0.04);
    rg.gain.setValueAtTime(0.025*vol,t+0.005);
    rg.gain.exponentialRampToValueAtTime(0.001,t+0.06);
    ring.connect(rg);rg.connect(master);
    ring.start(t+0.005);ring.stop(t+0.07);

    // LAYER 5: Felt absorption — soft low thump
    var feltLen=Math.floor(ctx.sampleRate*0.04);
    var feltBuf=ctx.createBuffer(1,feltLen,ctx.sampleRate);
    var fd=feltBuf.getChannelData(0);
    for(var j=0;j<feltLen;j++)fd[j]=(Math.random()*2-1)*Math.pow(1-j/feltLen,5);
    var feltSrc=ctx.createBufferSource();feltSrc.buffer=feltBuf;
    var feltFilt=ctx.createBiquadFilter();feltFilt.type='lowpass';feltFilt.frequency.value=300;
    var feltG=ctx.createGain();feltG.gain.value=0.06*vol;
    feltSrc.connect(feltFilt);feltFilt.connect(feltG);feltG.connect(master);
    feltSrc.start(t);feltSrc.stop(t+0.05);

    // Clean up context after sounds finish
    setTimeout(function(){ctx.close();},500);
  }catch(e){console.warn('[TradeEdge] Slam audio error:',e);}
}

function _playChipDropSound(count){
  try{
    var ctx=new(window.AudioContext||window.webkitAudioContext)();
    var n=Math.min(count||8,25);
    
    // Master compressor to glue the sounds together
    var comp=ctx.createDynamicsCompressor();
    comp.threshold.value=-18;comp.knee.value=12;comp.ratio.value=4;
    comp.attack.value=0.002;comp.release.value=0.05;
    comp.connect(ctx.destination);
    
    // Reverb — short room impulse (simulates table surface reflection)
    var reverbLen=Math.floor(ctx.sampleRate*0.15);
    var reverbBuf=ctx.createBuffer(2,reverbLen,ctx.sampleRate);
    for(var ch=0;ch<2;ch++){
      var rd=reverbBuf.getChannelData(ch);
      for(var i=0;i<reverbLen;i++)rd[i]=(Math.random()*2-1)*Math.pow(1-i/reverbLen,3)*0.3;
    }
    var reverb=ctx.createConvolver();reverb.buffer=reverbBuf;
    reverb.connect(comp);
    
    // Dry/wet mix
    var dryGain=ctx.createGain();dryGain.gain.value=0.7;dryGain.connect(comp);
    var wetGain=ctx.createGain();wetGain.gain.value=0.3;wetGain.connect(reverb);
    
    for(var i=0;i<n;i++){(function(idx){
      // Stagger: first few fast, then slower (chips settling)
      var t=idx<5?idx*0.032:0.16+(idx-5)*0.055+(Math.random()*0.015);
      // Randomize pitch center per chip (real chips have micro-variations)
      var pitchVar=0.85+Math.random()*0.3;
      
      // LAYER 1: Sharp ceramic transient (the initial "click")
      // Two detuned sine bursts create the clay-on-clay impact character
      var click1=ctx.createOscillator(),cg1=ctx.createGain();
      click1.type='sine';
      click1.frequency.setValueAtTime(3800*pitchVar,ctx.currentTime+t);
      click1.frequency.exponentialRampToValueAtTime(1200*pitchVar,ctx.currentTime+t+0.008);
      cg1.gain.setValueAtTime(0.06,ctx.currentTime+t);
      cg1.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+t+0.012);
      click1.connect(cg1);cg1.connect(dryGain);cg1.connect(wetGain);
      click1.start(ctx.currentTime+t);click1.stop(ctx.currentTime+t+0.015);
      
      // LAYER 2: Higher ceramic ring (the brief "ting")
      var ring=ctx.createOscillator(),rg=ctx.createGain();
      ring.type='sine';
      ring.frequency.setValueAtTime(6200*pitchVar,ctx.currentTime+t);
      ring.frequency.exponentialRampToValueAtTime(3800*pitchVar,ctx.currentTime+t+0.018);
      rg.gain.setValueAtTime(0.018,ctx.currentTime+t);
      rg.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+t+0.025);
      ring.connect(rg);rg.connect(dryGain);rg.connect(wetGain);
      ring.start(ctx.currentTime+t);ring.stop(ctx.currentTime+t+0.03);
      
      // LAYER 3: Sub-click body (the weight of the chip)
      var body=ctx.createOscillator(),bg=ctx.createGain();
      body.type='triangle';
      body.frequency.setValueAtTime(800*pitchVar,ctx.currentTime+t);
      body.frequency.exponentialRampToValueAtTime(200,ctx.currentTime+t+0.02);
      bg.gain.setValueAtTime(0.03,ctx.currentTime+t);
      bg.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+t+0.025);
      body.connect(bg);bg.connect(dryGain);bg.connect(wetGain);
      body.start(ctx.currentTime+t);body.stop(ctx.currentTime+t+0.03);
      
      // LAYER 4: Filtered noise burst (the "scrape" texture of clay edge)
      var nLen=Math.floor(ctx.sampleRate*0.008);
      var nBuf=ctx.createBuffer(1,nLen,ctx.sampleRate);
      var nd=nBuf.getChannelData(0);
      for(var j=0;j<nLen;j++)nd[j]=(Math.random()*2-1);
      var nSrc=ctx.createBufferSource();nSrc.buffer=nBuf;
      var nFilt=ctx.createBiquadFilter();
      nFilt.type='bandpass';nFilt.frequency.value=4500*pitchVar;nFilt.Q.value=2.5;
      var ng=ctx.createGain();
      ng.gain.setValueAtTime(0.04,ctx.currentTime+t);
      ng.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+t+0.008);
      nSrc.connect(nFilt);nFilt.connect(ng);ng.connect(dryGain);ng.connect(wetGain);
      nSrc.start(ctx.currentTime+t);nSrc.stop(ctx.currentTime+t+0.012);
      
      // LAYER 5: Every 3rd chip gets a slight "rattle" (chips shifting in stack)
      if(idx%3===2){
        var rattle=ctx.createOscillator(),rag=ctx.createGain();
        rattle.type='square';
        rattle.frequency.setValueAtTime(2200*pitchVar,ctx.currentTime+t+0.01);
        rattle.frequency.exponentialRampToValueAtTime(900,ctx.currentTime+t+0.025);
        rag.gain.setValueAtTime(0.008,ctx.currentTime+t+0.01);
        rag.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+t+0.03);
        rattle.connect(rag);rag.connect(dryGain);
        rattle.start(ctx.currentTime+t+0.01);rattle.stop(ctx.currentTime+t+0.035);
      }
    })(i);}
    
    // SETTLE: Deep felt thud (chips coming to rest on padded surface)
    var st=n<5?n*0.032+0.04:0.16+(n-5)*0.055+0.06;
    var thud=ctx.createOscillator(),tg=ctx.createGain();
    thud.type='sine';
    thud.frequency.setValueAtTime(80,ctx.currentTime+st);
    thud.frequency.exponentialRampToValueAtTime(25,ctx.currentTime+st+0.2);
    tg.gain.setValueAtTime(0.04,ctx.currentTime+st);
    tg.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+st+0.25);
    thud.connect(tg);tg.connect(dryGain);
    thud.start(ctx.currentTime+st);thud.stop(ctx.currentTime+st+0.3);
    
    // Felt noise (soft surface absorption)
    var feltLen=Math.floor(ctx.sampleRate*0.05);
    var feltBuf=ctx.createBuffer(1,feltLen,ctx.sampleRate);
    var fd=feltBuf.getChannelData(0);
    for(var j=0;j<feltLen;j++)fd[j]=(Math.random()*2-1)*Math.pow(1-j/feltLen,4);
    var feltSrc=ctx.createBufferSource();feltSrc.buffer=feltBuf;
    var feltFilt=ctx.createBiquadFilter();feltFilt.type='lowpass';feltFilt.frequency.value=400;
    var feltG=ctx.createGain();feltG.gain.value=0.02;
    feltSrc.connect(feltFilt);feltFilt.connect(feltG);feltG.connect(dryGain);
    feltSrc.start(ctx.currentTime+st);feltSrc.stop(ctx.currentTime+st+0.06);
  }catch(e){console.warn('[TradeEdge] Audio error:',e);}
}

var _lastChipBalance=-1;
var _chipInitRetries=0;
var _userHasInteracted=false;
document.addEventListener('click',function(){_userHasInteracted=true;},{once:true});
document.addEventListener('keydown',function(){_userHasInteracted=true;},{once:true});

function _showCSSFallback(balance){
  var cv=document.getElementById('chip-canvas');if(cv)cv.style.display='none';
  var fb=document.getElementById('chip-css-fallback');if(!fb)return;
  fb.style.display='flex';
  _renderCSSChips(balance,fb);
}

function renderChips(balance){
  if(typeof _3d==='undefined')return; // Script still initializing — deferred call will handle it
  var tray=document.getElementById('chip-tray');
  if(!tray)return;

  // Only render when dashboard is actually visible
  var dashView=document.getElementById('view-dashboard');
  if(!dashView||!dashView.classList.contains('active')){return;}

  console.log('[TradeEdge] renderChips: bal='+balance+', THREE='+(typeof THREE)+', failed='+window._threeJsFailed+', inited='+(typeof _3d!=='undefined'?_3d.inited:'n/a')+', tray='+tray.style.display);

  // Hide tray if no balance
  if(!balance||balance<=0){
    tray.style.display='none';
    _lastChipBalance=balance;
    return;
  }
  tray.style.display='';

  // THREE.js unavailable — show CSS chips; if CDN still loading, poll and upgrade to 3D
  if(typeof THREE==='undefined'||window._threeJsFailed){
    console.warn('[TradeEdge] renderChips: Using CSS fallback (THREE='+(typeof THREE)+', failed='+window._threeJsFailed+')');
    if(balance!==_lastChipBalance){_lastChipBalance=balance;_showCSSFallback(balance);}
    // If THREE is still loading (not failed, just slow), poll every 300ms and upgrade to 3D
    if(typeof THREE==='undefined'&&!window._threeJsFailed&&!window._threeRetryPending){
      window._threeRetryPending=true;
      var _bal=balance;
      var _threeCheck=setInterval(function(){
        if(typeof THREE!=='undefined'){
          clearInterval(_threeCheck);window._threeRetryPending=false;
          console.log('[TradeEdge] THREE.js now available — upgrading to 3D chips');
          _lastChipBalance=-1;renderChips(_bal);
        }
        if(window._threeJsFailed){clearInterval(_threeCheck);window._threeRetryPending=false;}
      },300);
    }
    return;
  }
  if(!_3d.inited){
    try{init3DChips();}catch(e){console.error('[TradeEdge] init3DChips threw:',e);window._threeJsFailed=true;}
    if(!_3d.inited){
      _chipInitRetries++;
      console.log('[TradeEdge] renderChips: THREE.js loaded but init pending (retry '+_chipInitRetries+', tray w='+tray.offsetWidth+' h='+tray.offsetHeight+')');
      if(_chipInitRetries<6){
        setTimeout(function(){_lastChipBalance=-1;renderChips(balance);},600);
      }else{
        console.warn('[TradeEdge] renderChips: init failed after '+_chipInitRetries+' retries — CSS fallback');
        window._threeJsFailed=true;
        _showCSSFallback(balance);
      }
      return;
    }
    _chipInitRetries=0;
  }
  if(balance===_lastChipBalance&&_3d.allChips.length>0)return;
  _lastChipBalance=balance;

  // Clear existing chips — dispose materials on child meshes inside each stack Group
  while(_3d.chipGroup.children.length>0){
    var obj=_3d.chipGroup.children[0];
    if(obj.isGroup){obj.children.forEach(function(c){if(c.material){if(Array.isArray(c.material))c.material.forEach(function(m){m.dispose();});else c.material.dispose();}});}
    else if(obj.material){if(Array.isArray(obj.material))obj.material.forEach(function(m){m.dispose();});else obj.material.dispose();}
    _3d.chipGroup.remove(obj);
  }
  _3d.allChips=[];_3d.stacks=[];_3d._fidgets=[];

  var countEl=document.getElementById('chip-tray-count');
  if(!balance||balance<=0){
    if(countEl)countEl.textContent=balance<=0&&S.trades.length>0?'LIQUIDATED':'No balance set';
    return;
  }

  // Break into groups
  var groups=[],rem=Math.floor(balance);
  for(var i=0;i<CHIP_DENOMS.length;i++){
    var ct=0;while(rem>=CHIP_DENOMS[i].v){ct++;rem-=CHIP_DENOMS[i].v;}
    if(ct>0)groups.push({denom:CHIP_DENOMS[i],count:ct});
  }

  // Build stacks
  var stacks=[];
  groups.forEach(function(g){
    var remaining=g.count;
    while(remaining>0){var sz=Math.min(remaining,CHIP_MAX_STACK);remaining-=sz;stacks.push({denom:g.denom,size:sz});}
  });
  stacks.sort(function(a,b){return b.size-a.size;});

  // Grid layout — CHIP_R=0.42, diameter=0.84. spacing=1.1 guarantees no cylinder overlap.
  var positions=[],totalStacks=stacks.length;
  var _numRows=totalStacks<=4?1:totalStacks<=9?2:3;
  var _perRow=Math.ceil(totalStacks/_numRows);
  var _xSp=1.05,_zSp=1.05; // tight spacing — stacks close together like a real table
  for(var _si=0;_si<totalStacks;_si++){
    var _row=Math.floor(_si/_perRow),_col=_si%_perRow;
    var _rowLen=Math.min(_perRow,totalStacks-_row*_perRow);
    positions.push({
      x:(_col-(_rowLen-1)/2)*_xSp+(Math.random()-.5)*.04,
      z:(_row-(_numRows-1)/2)*_zSp+(Math.random()-.5)*.04
    });
  }

  // Create meshes — individual chip Groups per stack (V12: realistic imperfections)
  _3d.stacks=[];
  try{
  stacks.forEach(function(stack,si){
    var pos=positions[si]||{x:(si-totalStacks/2)*1.1,z:0};
    var mesh=_makeStackMesh(stack.denom,stack.size);
    var totalH=stack.size*CHIP_H;
    var targetY=totalH/2+0.005; // slightly above felt, no z-fight
    mesh.rotation.y=(Math.random()-.5)*0.15;
    var dropH=4+Math.random()*2; // 4-6 units — realistic toss height
    var spreadX=pos.x+(Math.random()-.5)*1.8;
    var spreadZ=pos.z+(Math.random()-.5)*1.4;
    mesh.position.set(spreadX,targetY+dropH,spreadZ);
    mesh.rotation.x=(Math.random()-.5)*0.4;
    mesh.rotation.z=(Math.random()-.5)*0.4;
    _3d.chipGroup.add(mesh);
    _3d.allChips.push({mesh:mesh,targetY:targetY,startY:targetY+dropH,delay:si*120,done:false,
      startX:spreadX,targetX:pos.x,startZ:spreadZ,targetZ:pos.z,
      startRX:mesh.rotation.x,startRZ:mesh.rotation.z});
    _3d.stacks.push({mesh:mesh,pos:pos,d:stack.denom,sz:stack.size});
  });
  }catch(e){
    console.error('[TradeEdge] Error creating chip meshes:',e);
    window._threeJsFailed=true;_3d.inited=false;
    _showCSSFallback(balance);return;
  }

  // Update HUD
  if(countEl){
    var total=groups.reduce(function(a,g){return a+g.count;},0);
    var parts=groups.map(function(g){return g.count+'× $'+g.denom.label;});
    countEl.textContent=total+' chips  ·  '+parts.join('  ·  ');
  }

  // Trigger drop animation + per-stack slam sounds
  console.log('[TradeEdge] renderChips: created '+stacks.length+' stacks, '+_3d.allChips.length+' meshes, balance=$'+balance.toFixed(2));
  _3d.dropStart=performance.now();
  // Schedule a slam sound for each stack landing (delay + 600ms fall duration)
  _3d.allChips.forEach(function(c,idx){
    var landTime=c.delay+280; // delay + drop duration
    setTimeout(function(){if(_userHasInteracted)_playChipSlamSound(idx,_3d.allChips.length);},landTime);
  });
}

// TEST: Render chips at any balance — call from console: testChips(50000)
window.testChips=function(bal){
  _lastChipBalance=-1;
  _userHasInteracted=true;
  if(_3d._fidgets){_3d._fidgets.forEach(function(f){if(f._spreadChips)f._spreadChips.forEach(function(sc){_disposeSpreadChip(sc);_3d.chipGroup.remove(sc);});});_3d._fidgets=[];}
  renderChips(bal||50000);
  console.log('[TradeEdge] testChips: rendering $'+(bal||50000).toLocaleString());
};

// CSS poker chip fallback — shown when WebGL/THREE.js is unavailable
function _renderCSSChips(balance,container){
  container.innerHTML='';
  var rem=Math.floor(balance);
  var hasChips=false;
  CHIP_DENOMS.forEach(function(d){
    var ct=0;while(rem>=d.v){ct++;rem-=d.v;}
    if(!ct)return;
    hasChips=true;
    var wrap=document.createElement('div');
    wrap.className='css-chip-stack';
    var show=Math.min(ct,CHIP_MAX_STACK);
    for(var i=0;i<show;i++){
      var disc=document.createElement('div');
      disc.className='css-chip-disc';
      disc.style.background=d.c;
      disc.style.border='2px solid rgba(255,255,255,0.2)';
      disc.style.boxShadow='0 3px 8px rgba(0,0,0,0.6),inset 0 1px rgba(255,255,255,0.12)';
      wrap.appendChild(disc);
    }
    var lbl=document.createElement('div');
    lbl.className='css-chip-count';
    lbl.textContent=ct+'×$'+d.label;
    wrap.appendChild(lbl);
    container.appendChild(wrap);
  });
  if(!hasChips){
    var msg=document.createElement('div');
    msg.style.cssText='color:rgba(255,255,255,.2);font-family:var(--mono);font-size:.6rem;letter-spacing:2px';
    msg.textContent='NO BALANCE';
    container.appendChild(msg);
  }
}

// ══════════════════════════════════════════════════════════
// SELF-DESTRUCT SEQUENCE — triggered when balance <= 0
// ══════════════════════════════════════════════════════════
var _nukeTriggered=false;
function triggerSelfDestruct(){
  if(_nukeTriggered)return;
  _nukeTriggered=true;
  var overlay=document.getElementById('nuke-overlay');
  var countEl=document.getElementById('nuke-countdown');
  overlay.classList.add('active');
  var count=5;
  countEl.textContent=count;
  var iv=setInterval(function(){
    count--;
    if(count>0){
      countEl.textContent=count;
    }else{
      clearInterval(iv);
      countEl.textContent='0';
      setTimeout(nukeImpact,300);
    }
  },1000);
}
function nukeImpact(){
  // Hide countdown
  document.getElementById('nuke-overlay').classList.remove('active');
  // Drop the nuke emoji
  var emoji=document.getElementById('nuke-emoji');
  emoji.style.display='block';
  emoji.style.animation='nukeDrop .8s cubic-bezier(.6,.04,.98,.34) forwards';
  setTimeout(function(){
    emoji.style.display='none';
    // Flash
    var flash=document.getElementById('nuke-flash');
    flash.style.display='block';
    flash.style.animation='nukeFlash .6s ease-out forwards';
    // Screen shake
    document.body.style.animation='screenShake .5s ease';
    setTimeout(function(){document.body.style.animation='';},500);
    // App falls apart
    setTimeout(function(){
      flash.style.display='none';
      var dashboard=document.getElementById('view-dashboard');
      if(dashboard)dashboard.classList.add('falling');
    },400);
    // Blackout
    setTimeout(function(){
      document.getElementById('nuke-blackout').classList.add('active');
      playSadTrombone();
    },2500);
  },800);
}
function playSadTrombone(){
  try{
    var ctx=new(window.AudioContext||window.webkitAudioContext)();
    // Sad trombone: Bb4 → A4 → Ab4 → G4 (descending, each slightly longer)
    var notes=[
      {freq:466.16,start:0,dur:.4},
      {freq:440.00,start:.45,dur:.4},
      {freq:415.30,start:.9,dur:.5},
      {freq:392.00,start:1.5,dur:1.2}
    ];
    notes.forEach(function(n){
      var osc=ctx.createOscillator();
      var gain=ctx.createGain();
      osc.type='sawtooth';
      osc.frequency.setValueAtTime(n.freq,ctx.currentTime+n.start);
      // Slight pitch drop on last note for extra sadness
      if(n.dur>1)osc.frequency.linearRampToValueAtTime(n.freq*.94,ctx.currentTime+n.start+n.dur);
      gain.gain.setValueAtTime(.15,ctx.currentTime+n.start);
      gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+n.start+n.dur);
      osc.connect(gain);gain.connect(ctx.destination);
      osc.start(ctx.currentTime+n.start);
      osc.stop(ctx.currentTime+n.start+n.dur+.1);
    });
  }catch(e){console.log('[TradeEdge] Audio not supported');}
}
function dismissNuke(){
  document.getElementById('nuke-blackout').classList.remove('active');
  var dashboard=document.getElementById('view-dashboard');
  if(dashboard)dashboard.classList.remove('falling');
  _nukeTriggered=false;
}

// ══════════════════════════════════════════════════════════
// KEYBOARD SHORTCUTS
// ══════════════════════════════════════════════════════════
document.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  if (e.key === 'Escape') {
    document.querySelectorAll('.overlay.open, .session-overlay.open').forEach(el => el.classList.remove('open'));
    endTour();
    return;
  }
  if (!e.metaKey) return; // Cmd key required
  switch (e.key) {
    case 'n': case 'N': e.preventDefault(); openTrade(); break;
    case 'j': case 'J': e.preventDefault(); logTradeJournal(); break;
    case 's': case 'S': e.preventDefault(); openPreSession(); break;
    case '1': e.preventDefault(); go('dashboard'); break;
    case '2': e.preventDefault(); go('trades'); break;
    case '3': e.preventDefault(); go('journal'); break;
    case '4': e.preventDefault(); go('analytics'); break;
    case '5': e.preventDefault(); go('ict'); break;
    case 'i': case 'I': e.preventDefault(); go('import'); break;
    case 'e': case 'E': e.preventDefault(); exportCSV(); break;
    case '?': e.preventDefault(); go('help'); break;
  }
});


// ─── MOBILE SIDEBAR ────────────────────────
function toggleSidebar(){
  const sb = document.querySelector('.sidebar');
  const bd = document.getElementById('sidebar-backdrop');
  sb.classList.toggle('open');
  bd.classList.toggle('open');
}
// Close sidebar on nav click (mobile)
document.querySelectorAll('.ni').forEach(n => {
  n.addEventListener('click', () => {
    if(window.innerWidth <= 768){
      const sb = document.querySelector('.sidebar');
      const bd = document.getElementById('sidebar-backdrop');
      sb.classList.remove('open');
      bd.classList.remove('open');
    }
  });
});
// Close sidebar on resize to desktop
window.addEventListener('resize', () => {
  if(window.innerWidth > 768){
    document.querySelector('.sidebar').classList.remove('open');
    document.getElementById('sidebar-backdrop').classList.remove('open');
  }
});

</script>

<!-- FLOATING HELP BUTTON -->
<button class="help-fab" onclick="go('help')" title="Help & Tutorial">?</button>

<!-- SELF-DESTRUCT OVERLAY -->
<div class="nuke-overlay" id="nuke-overlay">
  <div style="text-align:center">
    <div class="nuke-label">⚠ ACCOUNT SELF-DESTRUCT SEQUENCE INITIATED ⚠</div>
    <div class="nuke-countdown" id="nuke-countdown">5</div>
  </div>
</div>
<div class="nuke-emoji" id="nuke-emoji" style="display:none">☢️</div>
<div class="nuke-flash" id="nuke-flash" style="display:none"></div>
<div class="nuke-blackout" id="nuke-blackout">
  <div class="nuke-rip">ACCOUNT LIQUIDATED</div>
  <div style="color:var(--t3);font-family:var(--mono);font-size:.7rem;margin-top:20px;opacity:0;animation:fadeRip 1s ease forwards;animation-delay:2s;letter-spacing:2px">REVIEW YOUR JOURNAL. DO BETTER.</div>
  <button class="btn btn-ghost btn-sm" style="margin-top:40px;opacity:0;animation:fadeRip 1s ease forwards;animation-delay:3.5s" onclick="dismissNuke()">Dismiss</button>
</div>

<!-- TOUR OVERLAY -->
<div class="tour-overlay" id="tour-overlay" style="display:none">
  <div class="tour-highlight" id="tour-highlight"></div>
  <div class="tour-tooltip" id="tour-tooltip">
    <div class="tour-step-label" id="tour-step-label"></div>
    <div class="tour-title" id="tour-title"></div>
    <div class="tour-desc" id="tour-desc"></div>
    <div class="tour-footer">
      <div class="tour-dots" id="tour-dots"></div>
      <div class="tour-btns">
        <button class="btn btn-ghost btn-sm" onclick="endTour()">Skip</button>
        <button class="btn btn-accent btn-sm" id="tour-next-btn" onclick="tourNext()">Next →</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>
